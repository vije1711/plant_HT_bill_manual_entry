<!-- htmlhint tagname-lowercase:false -->
<!DOCTYPE html>
<html lang="en" data-theme="neon">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IOM - HT Bill Calculator</title> <!-- base title; Save flow will override before print -->
  <!-- Main styles including print rules; id must remain unique -->
  <style id="print-css">
    :root{
      --bg:#0f172a;          /* slate-900 */
      --card:#111827;        /* gray-900 */
      --ink:#e5e7eb;         /* gray-200 */
      --muted:#cbd5e1;       /* slate-300 */
      --accent:#22d3ee;      /* cyan-400 */
      --accent-2:#a78bfa;    /* violet-400 */
      --good:#22c55e;        /* green-500 */
      --bad:#ef4444;         /* red-500 */
      --warn:#f59e0b;        /* amber-500 */
      --panel:#0b1224;       /* deep */
      --ring:2px solid rgba(34,211,238,.6);
      --shadow: 0 20px 50px rgba(0,0,0,.45);
      --radius: 18px;
      --warn-outline: rgba(255,120,120,.6);
    }
    /* Force a light palette for export */
    :root { color-scheme: light only; }
    *{box-sizing:border-box}
    :focus-visible{outline:var(--ring);outline-offset:2px}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1100px 600px at 100% -10%, rgba(167,139,250,.18), transparent 60%),
                  radial-gradient(900px 500px at -10% 10%, rgba(34,211,238,.18), transparent 60%),
                  var(--bg);
      color:var(--ink);
    }
    .wrap{max-width:1200px;margin:20px auto;padding:0 20px}
    header{
      position:sticky;top:0;z-index:10;
      backdrop-filter:saturate(150%) blur(8px);
      background:linear-gradient(180deg, rgba(15,23,42,.92), rgba(15,23,42,.66));
      border-bottom:1px solid rgba(255,255,255,.08);
      display:grid;
      grid-template-columns:minmax(260px,auto) 1fr;
      align-items:start;
      gap:10px;
      margin-bottom:10px;
      padding:6px 0;               /* slimmer top bar */
    }

    .brand svg{width:26px;height:26px}
    .brand h1{font-size:18px;line-height:1.2}
    .sub{font-size:12px;margin-top:2px}

    .brand{display:flex;align-items:center;gap:12px}
    .brand h1{margin:0;letter-spacing:.3px}
    .sub{color:var(--ink)}

    button, .ghost{
      border:0;border-radius:10px;padding:6px 10px;font-size:13px;font-weight:600;letter-spacing:.2px;
      line-height:1.1;               /* compact but readable */
      min-height:34px;               /* a11y tap target */
      white-space:nowrap;            /* prevent multi-line buttons */
      max-width:100%;
      background:linear-gradient(145deg, rgba(167,139,250,.25), rgba(34,211,238,.25));
      color:white;cursor:pointer;box-shadow:var(--shadow);backdrop-filter: blur(6px);
    }
    button:hover{filter:brightness(1.07)}
    button:active{transform:translateY(1px)}
    .ghost{background:rgba(255,255,255,.05)}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{
      grid-column: span 12;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);padding:18px 18px 12px 18px;box-shadow:var(--shadow)
    }
    .extras-group{margin:6px 0 0;display:flex;flex-direction:column;gap:6px;}
    .extras-panel{
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:6px 10px;
      background:rgba(15,23,42,.32);
    }
    .extras-panel summary{
      list-style:none;
      cursor:pointer;
      font-size:12px;
      font-weight:600;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .extras-panel summary::marker,
    .extras-panel summary::-webkit-details-marker{display:none;}
    .extras-panel[open] summary{color:var(--ink);}
    .extras-body{margin-top:8px;display:flex;flex-direction:column;gap:6px;}
    .extras-list{display:flex;flex-direction:column;gap:6px;}
    .extras-row{
      display:grid;
      grid-template-columns:minmax(160px,2fr) minmax(140px,1fr) auto auto;
      gap:8px;
      align-items:center;
    }
    .extras-label{width:100%;}
    .extras-amount{width:100%;}
    .extras-include{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      color:var(--muted);
    }
    .extras-include input{width:18px;height:18px;}
    .extras-remove{justify-self:end;}
    .extras-empty{font-size:12px;color:var(--muted);}
    .extras-add{align-self:flex-start;}
    @media(max-width:720px){
      .extras-row{
        grid-template-columns:1fr;
        gap:6px;
      }
      .extras-remove{justify-self:flex-start;}
      .extras-include{justify-content:flex-start;}
    }
    .main-final .final-card{
      display:flex;
      align-items:stretch;
      gap:20px;
      margin-top:10px;
    }
    .main-final .final-main{
      flex:0 0 280px;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:24px 22px 26px;
      border-radius:22px;
      background:linear-gradient(165deg, rgba(34,211,238,.24), rgba(59,130,246,.18) 55%, rgba(79,70,229,.15));
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 24px 52px rgba(15,23,42,.34);
    }
    .main-final .final-main .formula{font-size:13px;letter-spacing:.08em;text-transform:uppercase;color:rgba(226,232,240,.85);}
    .main-final .final-main .amount{
      font-size:clamp(28px, 5vw, 38px);
      font-weight:800;
      line-height:1.1;
      word-break:break-word;
      overflow-wrap:anywhere;
    }
    .main-final .final-main .mapping{font-size:13px;}
    .main-final .final-breakdown{
      flex:1;
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(180px,1fr));
      gap:10px 18px;
      padding:10px 0 6px;
    }
    .main-final .final-breakdown .item{
      display:grid;
      grid-template-columns:1fr auto;
      align-items:center;
      gap:12px;
      padding:10px 16px;
      border-radius:16px;
      background:linear-gradient(135deg, rgba(15,23,42,.52), rgba(30,41,59,.38));
      border:1px solid rgba(148,163,184,.12);
      box-shadow:0 12px 26px rgba(15,23,42,.26);
      position:relative;
    }
    .main-final .final-breakdown .item::after{
      content:'';
      position:absolute;
      inset:-1px;
      border-radius:inherit;
      border:1px solid rgba(255,255,255,.04);
      pointer-events:none;
    }
    .main-final .final-breakdown .label{
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:rgba(226,232,240,.74);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .main-final .final-breakdown .value{
      font-size:clamp(15px, 2vw, 17px);
      font-weight:700;
      text-align:right;
      min-width:110px;
      line-height:1.2;
      word-break:break-word;
      overflow-wrap:anywhere;
    }
    .main-final .final-breakdown .value.minus{color:var(--bad);}
    .main-final .final-breakdown .value.plus{color:var(--good);}
    .main-final .final-breakdown .value.base{color:var(--ink);}
    @media(max-width:1180px){
      .main-final .final-card{flex-direction:column;}
      .main-final .final-main{flex:1;}
    }
    .final-check-card{
      display:flex;
      flex-direction:column;
      gap:16px;
      margin-top:10px;
    }
    .final-check-card .pill-check{
      margin-top:0;
    }
    #analysisCard{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    #analysisMeta{
      font-size:12.5px;
      color:rgba(226,232,240,.72);
      margin-bottom:4px;
    }
    #analysisControls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin:6px 0;
    }
    #analysisControls label{
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
    }
    #analysisControls select{
      height:32px;
      line-height:32px;
      padding:0 10px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.28);
      background:rgba(15,23,42,.62);
      color:var(--ink);
    }
    #analysisControls select:focus-visible{
      outline:var(--ring);
      outline-offset:2px;
    }
    .analysis-stats{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:12px;
      margin:14px 0 0;
    }
    .analysis-stat{
      padding:12px 14px;
      border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(148,163,184,.14);
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:92px;
    }
    .analysis-stat-label{
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .analysis-stat-value{
      font-size:18px;
      font-weight:700;
      color:var(--ink);
    }
    .analysis-stat-sub{
      font-size:12px;
      color:var(--muted);
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }
    .analysis-stat-delta{
      font-weight:600;
    }
    .analysis-stat-delta.plus{color:var(--good);}
    .analysis-stat-delta.minus{color:var(--bad);}
    #analysisChartHost{
      position:relative;
      overflow:hidden;
      min-height:260px;
      padding:20px 22px 18px;
      border-radius:20px;
      background:linear-gradient(165deg, rgba(15,23,42,.78), rgba(17,24,39,.66));
      border:1px solid rgba(148,163,184,.18);
      box-shadow:0 18px 42px rgba(15,23,42,.33);
    }
    #analysisChartHost::before{
      content:'';
      position:absolute;
      inset:0;
      border-radius:inherit;
      background:
        radial-gradient(circle at 18% 12%, rgba(34,211,238,.32), transparent 52%),
        radial-gradient(circle at 88% 85%, rgba(167,139,250,.26), transparent 55%);
      opacity:.5;
      pointer-events:none;
      mix-blend-mode:screen;
    }
    #analysisChartHost canvas{
      position:relative;
      z-index:1;
      width:100% !important;
      height:100% !important;
    }
    @media(min-width:980px){
      .span-6{grid-column:span 6}
      .span-4{grid-column:span 4}
      .span-8{grid-column:span 8}
      .span-7{grid-column:span 7}
      .span-3{grid-column:span 3}
      .span-5{grid-column:span 5}
      .span-9{grid-column:span 9}
    }

    .card h2{margin:0 0 12px 0;font-size:16px;font-weight:700;display:flex;justify-content:space-between;align-items:center}
    .help{color:var(--ink);font-size:12px}

    .fields{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .fields .f{grid-column:span 12}
    @media(min-width:860px){.fields .f{grid-column:span 6}}
    .fields .f.sm{grid-column:span 6}
    @media(min-width:860px){.fields .f.sm{grid-column:span 3}}

    label{
      display:flex;
      justify-content:space-between;
      gap:8px;
      color:var(--ink);
      font-size:12.5px;
      margin-bottom:6px;
      align-items:flex-end;
      min-height:36px;
    }
    @media(max-width:859px){
      label{min-height:0;align-items:flex-start;}
    }
    input[type="number"], input[type="month"], input[type="text"]{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(17,24,39,.6);color:var(--ink)
    }

    .kpi{
      display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin-top:6px;
      overflow:visible;
    }
    .kpi .box{grid-column:span 12;min-height:104px}
    @media(min-width:980px){.kpi .box{grid-column:span 4}}
    .box{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;
      position:relative;
    }
    .box .field-label-row{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin:0 0 4px 0;
      color:var(--muted);
      font-size:12.5px;
      font-weight:600;
      line-height:1.3;
      white-space:normal;
      word-break:break-word;
      overflow-wrap:anywhere;
    }
    .box .field-label{display:inline-flex;align-items:center;gap:4px;}
    .box .field-ref{
      font-size:11.5px;
      font-weight:600;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .box .v{
      margin-top:8px;
      font-size:clamp(18px, 2.4vw, 22px);
      font-weight:800;
      line-height:1.2;
      word-break:break-word;
      overflow-wrap:anywhere;
    }
    .output-field{
      cursor:help;
      border-radius:14px;
      transition:box-shadow .16s ease, transform .16s ease;
    }
    .output-field:focus-visible{
      outline:2px solid rgba(148, 163, 184, 0.45);
      outline-offset:4px;
    }
    .output-field:hover{
      box-shadow:0 8px 22px rgba(15,23,42,0.24);
      transform:translateY(-1px);
    }
    .formula-tooltip{
      position:fixed;
      z-index:1200;
      pointer-events:none;
      background:rgba(15, 23, 42, 0.94);
      color:#f8fafc;
      padding:8px 12px;
      border-radius:8px;
      box-shadow:0 10px 28px rgba(15,23,42,0.4);
      font-size:12.5px;
      line-height:1.4;
      max-width:40ch;
      opacity:0;
      transform:translateY(6px) scale(.98);
      transition:opacity 0.14s ease, transform 0.14s ease;
      display:flex;
      align-items:flex-start;
      gap:6px;
    }
    .formula-tooltip.visible{
      opacity:1;
      transform:translateY(0) scale(1);
    }
    .formula-tooltip[data-placement="below"]{
      transform:translateY(-6px) scale(.98);
    }
    .formula-tooltip.visible[data-placement="below"]{
      transform:translateY(0) scale(1);
    }
    .formula-tooltip::after{
      content:'';
      position:absolute;
      width:10px;
      height:10px;
      background:inherit;
      transform:rotate(45deg);
      z-index:-1;
      box-shadow:0 4px 10px rgba(15,23,42,0.3);
    }
    .formula-tooltip[data-placement="above"]::after{
      bottom:-5px;
      left:50%;
      transform:translateX(-50%) rotate(45deg);
    }
    .formula-tooltip[data-placement="below"]::after{
      top:-5px;
      left:50%;
      transform:translateX(-50%) rotate(45deg);
    }
    .unit{font-size:12px;color:var(--muted);margin-left:6px;font-weight:600}

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .accent{color:var(--accent)}
    .violet{color:var(--accent-2)}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}

    .muted{color:var(--muted)}
    .hr{height:1px;background:linear-gradient(90deg, rgba(255,255,255,.15), rgba(255,255,255,.03));margin:14px 0}

    .card-split{
      display:grid;
      grid-template-columns:minmax(0, 1fr);
      grid-template-areas:
        "in"
        "out";
      gap:20px;
      align-items:start;
    }
    .card-out,
    .card-in{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .card-in{grid-area:in;justify-self:start;width:100%;}
    .card-out{
      grid-area:out;
      justify-self:end;
      width:100%;
      max-width:480px;
    }
    @media(max-width:899px){
      .card-out{
        justify-self:start;
        max-width:none;
      }
    }
    @media(min-width:900px){
      .card-split{
        grid-template-columns:minmax(0, 1.45fr) minmax(0, 1fr);
        grid-template-areas:"in out";
        gap:30px;
      }
      .card-in{justify-self:start;}
      .card-out{align-self:start;}
    }
    .kpi-stack{
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:visible;
    }
    .kpi-stack .box{
      grid-column:auto;
      width:100%;
    }
    .adjustments-card .card-split{
      align-items:stretch;
    }
    .adjustments-card .card-in,
    .adjustments-card .card-out{
      height:100%;
    }
    .adjustments-fields .f{
      grid-column:span 12;
    }
    .adjustments-kpis{
      flex:1;
      justify-content:space-between;
    }
    .adjustments-kpis .box{
      flex:0 0 auto;
    }
    @media(max-width:899px){
      .adjustments-card .card-in,
      .adjustments-card .card-out{
        height:auto;
      }
      .adjustments-kpis{
        justify-content:flex-start;
        flex:0 0 auto;
      }
    }

    .weg-card .card-split{
      align-items:stretch;
    }
    .weg-card .card-in,
    .weg-card .card-out{
      height:100%;
    }
    .weg-fields{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:10px;
      align-content:flex-start;
    }
    .weg-fields .f{
      grid-column:auto;
    }
    .weg-generation{
      margin-top:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .weg-generation-fields{
      display:grid;
      grid-template-columns:repeat(12, minmax(0,1fr));
      grid-auto-rows:auto;
      gap:10px;
    }
    .weg-generation-fields .weg-gen-field{
      min-width:0;
    }
    .weg-generation-fields .weg-gen-bit-1,
    .weg-generation-fields .weg-gen-bit-2{
      grid-column:span 6;
    }
    .weg-generation-fields .weg-gen-nan-1,
    .weg-generation-fields .weg-gen-nan-2,
    .weg-generation-fields .weg-gen-nan-3{
      grid-column:span 4;
    }
    .weg-kpis{
      flex:1;
      justify-content:space-between;
    }
    .weg-kpis .box{
      flex:0 0 auto;
    }
    @media(max-width:899px){
      .weg-card .card-in,
      .weg-card .card-out{
        height:auto;
      }
      .weg-fields{
        grid-template-columns:repeat(1, minmax(0,1fr));
      }
      .weg-generation{
        margin-top:0;
      }
      .weg-generation-fields{
        grid-template-columns:repeat(1, minmax(0,1fr));
      }
      .weg-generation-fields .weg-gen-field{
        grid-column:auto;
        grid-row:auto;
      }
      .weg-kpis{
        justify-content:flex-start;
        flex:0 0 auto;
      }
    }

    .wind-card .card-in{
      gap:18px;
    }
    .wind-card .wind-groups{
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .wind-card .wind-group{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .wind-card .wind-divider{
      margin:12px 0;
    }
    .wind-card .wind-heading{
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .wind-card .wind-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(220px,1fr));
      gap:12px;
    }
    .wind-card .wind-grid .f,
    .wind-card .wind-grid .f.sm{
      grid-column:auto;
    }
    .wind-card .wind-extras{
      margin-top:4px;
    }
    .wind-card .wind-grid.wind-grid-debits{
      grid-template-columns:repeat(12, minmax(0,1fr));
    }
    .wind-card .wind-grid.wind-grid-debits .f{
      grid-column:span 4;
    }
    @media(max-width:720px){
      .wind-card .wind-grid{
        grid-template-columns:minmax(0,1fr);
      }
      .wind-card .wind-grid.wind-grid-debits .f{
        grid-column:auto;
      }
    }

    .pill{display:inline-flex;align-items:center;gap:8px;padding:2px 6px;border-radius:999px;
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:11px;
      min-height:34px;flex:0 0 auto;scroll-snap-align:start}
    /* keep pill text on one line, truncate gracefully */
    .pill > span{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%;}
    #finalCheckBadge{
      display:flex;
      align-items:center;
      gap:24px;
      padding:20px 24px 22px;
      border-radius:24px;
      background:linear-gradient(140deg, rgba(22,163,239,.22), rgba(147,51,234,.16));
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 26px 58px rgba(15,23,42,.45);
      width:100%;
      margin:4px 0 0;
    }
    #finalCheckBadge .status-wrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      width:118px;
      border-radius:20px;
      background:rgba(15,23,42,.6);
      color:var(--ink);
      text-align:center;
      gap:10px;
      padding:18px 14px;
      backdrop-filter:blur(10px);
    }
    #finalCheckBadge .status{
      font-size:34px;
      line-height:1;
      font-weight:700;
    }
    #finalCheckBadge .status-label{
      font-size:11px;
      letter-spacing:.26em;
      text-transform:uppercase;
      color:var(--muted);
    }
    #finalCheckBadge .metrics{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(170px, 1fr));
      gap:16px 34px;
      width:100%;
    }
    #finalCheckBadge .metric{
      display:grid;
      grid-template-rows:auto auto;
      gap:6px;
    }
    #finalCheckBadge .metric-label{
      font-size:11px;
      font-weight:600;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:rgba(226,232,240,.75);
    }
    #finalCheckBadge .metric-value{
      font-size:21px;
      font-weight:700;
      color:var(--ink);
      white-space:nowrap;
    }
    #finalCheckBadge.good .status-wrap{
      background:linear-gradient(160deg, rgba(34,197,94,.22), rgba(16,185,129,.18));
      color:#12d17b;
    }
    #finalCheckBadge.bad .status-wrap{
      background:linear-gradient(160deg, rgba(248,113,113,.22), rgba(239,68,68,.18));
      color:#f87171;
    }
    @media(max-width:1024px){
      #finalCheckBadge{
        flex-wrap:wrap;
        justify-content:flex-start;
        gap:18px;
        }
      #finalCheckBadge .status-wrap{width:108px;}
      #finalCheckBadge .metrics{grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));}
    }
    .pill button{padding:2px 6px}
    .pill:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    .pills{
      display:flex;
      gap:6px;
      overflow-x:auto;
      overflow-y:hidden;
      white-space:nowrap;
      max-width:100%;
      -webkit-overflow-scrolling:touch;
      scroll-snap-type:x proximity;
    }
    /* Hide legacy sheet pills strip in favor of Sheets &#9662; menu */
    #sheetList{display:none !important}
    .right{float:right}

    /* Normalize header form-control height to match 34px tap target */
    header .toolbar input[type="month"],
    header .toolbar input[type="text"],
    header .toolbar select{
      height:34px; line-height:34px;
      padding:0 8px; font-size:13px;
      border-radius:8px;
    }
      header .toolbar input{margin:0}  /* avoid UA default margins increasing pill height */
      header .toolbar input[type="checkbox"]{height:auto;width:auto} /* keep checkbox natural */


    /* Dropdowns */
    .menu{position:relative; display:inline-block; z-index:2}
    .menu details{display:inline-block}
    .menu summary{
      list-style:none; cursor:pointer; user-select:none;
      height:34px; line-height:34px; padding:0 10px; border-radius:8px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
    }
      .menu details[open] > summary{outline:2px solid var(--accent); outline-offset:2px}
    .menu-panel{
      position:absolute; top:calc(100% + 4px); left:0; z-index:1000;
      min-width:max(200px, 100%);
      background:var(--card); color:var(--ink); border:1px solid rgba(255,255,255,.10);
      border-radius:12px; box-shadow:var(--shadow);
      padding:6px; display:flex; flex-direction:column; gap:4px;
    }
    .config-panel{
      width:min(460px, 92vw);
      max-height:70vh;
      overflow:auto;
      padding:12px;
      gap:12px;
    }
    .config-group{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:10px;
      border-radius:10px;
      background:rgba(15,23,42,.35);
      border:1px solid rgba(255,255,255,.08);
    }
    .config-group h3{
      margin:0;
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .config-field{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .config-field label{
      font-size:13px;
      color:var(--ink);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .config-field input{
      width:100%;
      min-height:32px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.1);
      background:rgba(17,24,39,.6);
      color:var(--ink);
      padding:6px 8px;
      font-size:13px;
    }
    .config-field input:focus{
      outline:var(--ring);
      outline-offset:2px;
    }
    .config-hint{
      font-size:11px;
      color:var(--muted);
      min-height:13px;
    }
    .config-hint.error{color:#f87171;}
    .config-hint.warn{color:#fbbf24;}
    .config-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
    }
    .config-actions button{
      flex:0 0 auto;
    }
    .menu-panel.drop-up{ top:auto; bottom:calc(100% + 4px); }
    .menu-panel [role="menuitem"]{display:flex; align-items:center; gap:8px; height:32px; padding:0 8px; border-radius:8px}
    .menu-panel [role="menuitem"]:hover,.menu-panel [role="menuitem"]:focus{background:rgba(255,255,255,.06); outline:none}
    /* sheet items inside menu */
    .sheet-menu-item{display:flex;align-items:center;justify-content:space-between;
      height:32px;padding:0 8px;border-radius:8px}
    .sheet-menu-item .del{margin-left:8px}
    .menu-sep{height:1px; background:linear-gradient(90deg, rgba(255,255,255,.15), rgba(255,255,255,.03)); margin:4px 0}
    @media (max-width: 1200px){ header .toolbar{row-gap:6px} }

    details{margin:10px 0}
    summary{cursor:pointer}

    #toasts{position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:1000}
    .toast{background:var(--card);color:var(--ink);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:1;transition:opacity .5s ease, transform .5s ease}
    .toast.info{border-left:4px solid var(--accent)}
    .toast.good{border-left:4px solid var(--good)}
    .toast.bad{border-left:4px solid var(--bad)}
    .toast.warn{border-left:4px solid var(--warn)}
    .toast.hide{opacity:0;transform:translateX(20px)}
    .hint{display:none;color:var(--bad);font-size:11px;margin-top:4px}
    .warn-text{display:none;color:var(--muted);font-size:11px;margin-top:4px}
    .invalid{border-color:var(--bad)!important}
    .rate-cell{display:flex;flex-direction:column;align-items:flex-end;gap:2px}
    .rate-input{display:flex;align-items:center;gap:6px;justify-content:flex-end;width:100%}
    .rate-input.percent{
      position:relative;
      display:block;
      padding-right:0;
    }
    .rate-input.percent input{
      width:100%;
      padding-right:24px;
      text-align:right;
    }
    .rate-input.percent .suffix{
      position:absolute;
      top:50%;
      right:8px;
      transform:translateY(-50%);
      font-size:12px;
      color:var(--muted);
      pointer-events:none;
    }
    .rate-input .suffix{font-size:12px;color:var(--muted);}
    .rate-preview{font-size:11px;color:var(--muted);margin-top:0;display:none;text-align:right;width:100%}
    .rate-cell.editing .rate-preview{display:block}
    .info-tip{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:rgba(148,163,184,.24);color:var(--muted);font-size:11px;margin-left:6px;cursor:help}
    .rate-hint{min-height:0}


    /* Toolbar group layout */
    header .toolbar{ grid-column:1 / -1; }
    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      overflow:visible; min-width:0;
      padding:4px 0;
      position:relative; z-index:1; /* ensure menus sit above content cards */
    }
    /* pills in toolbar should not cause overflow */
    .toolbar .pill{min-width:0; max-width:100%;}
    .group{
      display:flex; align-items:center; gap:6px;
      padding:3px 6px;                /* slightly tighter */
      border-radius:12px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      flex-wrap:wrap; flex:1 1 340px; min-width:240px; max-width:100%;
    }
    .group .label{
      font-size:10px; letter-spacing:.05em; text-transform:uppercase;
      color:var(--muted); margin-right:2px;
      min-width:90px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:120px;
    }
    .group[aria-label="Utilities"]{padding:2px 4px;gap:4px}
    /* Compact on narrow screens */
    @media (max-width: 980px){
      header{ grid-template-columns: 1fr; }
      .group{ width:100%; border-radius:14px; }
      .toolbar > label.pill{ width:100%; }
    }

    /* Encourage earlier wrapping on mid-width laptops to keep header compact */
    @media (max-width: 1280px) and (min-width: 1060px){
      .group{
        flex:1 1 300px;
      }
    }

    /* A4 page layout for HTML preview */
    .sheet {
      width: 210mm;
      min-height: 297mm;
      margin: 12px auto;
      background: #fff;
      color: #111;
      border: 1px solid rgba(0,0,0,.12);
      padding: 16mm 18mm 22mm; /* bottom padding to avoid footer overlap */
      position: relative;
      font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    .doc-header { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:4mm; }
    .doc-header h2 { margin:2mm 0 0; font-size:18pt; }
    .doc-header .company { font-weight:700; }
    .doc-header .dept { font-size:11pt; }
    .doc-meta { color:#555; font-size:10.5pt; text-align:right; }
    .info-bar { background:#f3f4f6; border:1px solid #e5e7eb; padding:2mm 4mm; margin-bottom:8mm; font-size:10.5pt; white-space:normal; overflow:visible; text-overflow:clip; overflow-wrap:anywhere; word-break:break-word; }
    .sec { break-inside: avoid; margin: 7mm 0 0; }
    .sec h3 { margin:0 0 3mm; font-size:12pt; border-bottom:1px solid #ddd; padding-bottom:2.5mm; }
    .kv { display:grid; grid-template-columns: 1fr minmax(52mm,auto) 10mm; gap:2mm; padding:2mm 0; border-bottom:1px dashed #eee; }
    .kv .label { color:#374151; overflow-wrap:anywhere; word-break:break-word; }
    .kv .value { font-weight:600; text-align:right; font-variant-numeric: tabular-nums; }
    .kv .unit { color:#6b7280; text-align:right; }
    .kv .value.total { font-weight:800; }
    .mapping .kv:last-child { background: #f3f4f6; border:1px solid #e5e7eb; }
    .total { font-weight:700; }
    /* Signatures */
    .signatures { break-inside: avoid; }
    .sigs { display:grid; grid-template-columns: 1fr 1fr; gap:6mm; margin-top:6mm; }
    .sig { text-align:left; }
    .sig.right { text-align:right; }
    .sig .line { border-top:1px solid #d1d5db; height:0; margin:14mm 0 2mm; }
    .sig .role { color:#111; font-weight:600; }
    .footer-note { margin-top:8mm; color:#6b7280; font-size:9.5pt; }
    .page-number { position:absolute; bottom:8mm; right:18mm; color:#6b7280; font-size:10pt; }

    /* Ensure print host is visible like the v5 sample */
    #htmlPrintHost { min-height: 1px; }
    /* IOM layout chrome: scope to .sheet.iom to avoid touching receipts */
    #htmlPrintHost .sheet.iom{
      width: 210mm;
      min-height: 297mm;
      padding: 16mm 18mm 22mm;
      margin: 0 auto 12mm;
      background: #fff;
      box-shadow: 0 0 0.6mm rgba(0,0,0,.2);
    }

    @media print{
      :root{
        /* Neutral default; JS sets smaller value only if overflow is detected */
        --iom-scale: 1;
      }
      /* IOM-only guard (activated by html.print-iom) to avoid interfering with receipts */
      html.print-iom .wrap,
      html.print-iom header,
      html.print-iom .toolbar,
      html.print-iom .controls,
      html.print-iom .card:not(.sheet),
      html.print-iom #toasts,
      html.print-iom #modal,
      html.print-iom .ui { display:none !important; }
      html.print-iom #htmlPrintHost{ display:block !important; }
      @page { size: A4; margin: 12mm; }
      /* Fit to a single A4 page for IOM only */
      html.print-iom #htmlPrintHost .sheet.iom{
        /* Fit to a single A4 page without changing on-screen layout */
        box-shadow:none;
        margin:0 auto 0 0;
        transform: scale(var(--iom-scale));
        transform-origin: top left;
        width: calc(210mm / var(--iom-scale));
        min-height: auto;             /* avoid forcing an extra page */
        padding: 12mm 14mm;           /* slightly tighter print padding */
      }
      html.print-iom #htmlPrintHost .sheet.iom .doc-header{ margin-top:0; margin-bottom:8px; }
      html.print-iom #htmlPrintHost .sheet.iom .kv li{ margin:2mm 0; }
      html.print-iom #htmlPrintHost .sheet.iom .sigs .line{ margin:12mm 0 3mm; }
    }

  </style>
<style>
  /* Scoped &ldquo;slim&rdquo; layout for the receipt card only */
  #receiptCard .fields{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px 16px;
  }
  #receiptCard .fields .f{ grid-column: span 1; }
  /* Hard guarantee that the card is typeable/clickable */
  #receiptCard{ position:relative; z-index:1; }
  #receiptCard, #receiptCard *{ pointer-events:auto; }
  #receiptCard .f label{
    display:block;
    font-size:12px;
    opacity:.9;
    margin-bottom:4px;
  }
  #receiptCard input{ 
    height:34px;
    padding:6px 10px;
    border-radius:8px;
  }
  #receiptCard .hint{ display:block; font-size:11px; opacity:.75; margin-top:4px; }
  #receiptCard input.warn{ outline:2px solid var(--warn-outline, rgba(255,120,120,.6)); }
  #receiptCard .row-3up{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px 16px;
    grid-column:1 / -1;
  }
  @media (max-width: 720px){
    #receiptCard .fields{ grid-template-columns: 1fr; }
    #receiptCard .row-3up{ grid-template-columns: 1fr; }
  }
  @media (min-width: 1200px){
    #receiptCard .fields{ grid-template-columns: 1fr 1fr 1fr; }
    #receiptCard .row-3up{ display: contents; }
  }
  #receiptCard .actions{
    display:flex;
    gap:8px;
    justify-content:flex-end;
    margin-top:10px;
    flex-wrap:wrap;
  }
</style>
  <!-- Futuristic on-screen theme (UI only) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <style id="theme-css">
    /* Screen-only polish; keeps calculations/data flow untouched */
    @media screen {
      :root{
        --glow-cyan: rgba(34,211,238,.65);
        --glow-violet: rgba(167,139,250,.55);
        --grid-line: rgba(255,255,255,.04);
        --grid-line-2: rgba(255,255,255,.035);
      }

      /* Futuristic animated grid + soft radial glow */
      html[data-theme="neon"] body::before{
        content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
        background:
          radial-gradient(1200px 600px at 110% -10%, rgba(167,139,250,.12), transparent 60%),
          radial-gradient(900px 520px at -10% 0%, rgba(34,211,238,.12), transparent 60%),
          repeating-linear-gradient( to right, var(--grid-line) 0 1px, transparent 1px 100px ),
          repeating-linear-gradient( to bottom, var(--grid-line-2) 0 1px, transparent 1px 100px );
        mix-blend-mode: overlay;
        opacity:.25;
        transform: translateZ(0);
        animation: gridFloat 48s linear infinite;
      }
      @keyframes gridFloat {
        from { background-position: 0 0, 0 0, 0 0, 0 0; }
        to   { background-position: 0 0, 0 0, 100px 100px, 100px 100px; }
      }

      /* Headings: modern, confident geometry */
      html[data-theme="neon"] .brand h1,
      html[data-theme="neon"] h2,
      html[data-theme="neon"] h3 { font-family: "Space Grotesk", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; letter-spacing:.2px }
      html[data-theme="neon"] .mono { font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace }

      /* Cards: subtle lift + glow on hover */
      html[data-theme="neon"] .card{ position:relative; overflow:clip }
      html[data-theme="neon"] .card::after{
        content:""; position:absolute; inset:-1px; border-radius: inherit; pointer-events:none; z-index:0;
        background: radial-gradient(240px 160px at 10% -10%, rgba(34,211,238,.18), transparent 60%),
                    radial-gradient(240px 160px at 110% -10%, rgba(167,139,250,.18), transparent 60%);
        opacity:.35; filter:saturate(120%);
      }
      html[data-theme="neon"] .card:hover{ transform: translateY(-1px); transition: transform .18s ease }
      html[data-theme="neon"] .card:hover{ box-shadow: 0 24px 60px rgba(0,0,0,.55) }

      /* Buttons: glassy with interactive sheen */
      html[data-theme="neon"] button,
      html[data-theme="neon"] .ghost{
        position:relative; isolation:isolate; transition: filter .15s ease, transform .08s ease;
        outline-offset: 2px;
      }
      html[data-theme="neon"] button::before,
      html[data-theme="neon"] .ghost::before{
        content:""; position:absolute; inset:0; border-radius: inherit; z-index:-1;
        background: linear-gradient(145deg, rgba(167,139,250,.35), rgba(34,211,238,.35));
        filter: blur(12px); opacity:.0; transition: opacity .2s ease;
      }
      html[data-theme="neon"] button:hover::before,
      html[data-theme="neon"] .ghost:hover::before{ opacity:.3 }
      html[data-theme="neon"] button:focus-visible{ box-shadow: 0 0 0 3px rgba(34,211,238,.35), 0 0 0 6px rgba(167,139,250,.22) }

      /* Inputs: clearer focus + subtle glow */
      html[data-theme="neon"] input[type="number"],
      html[data-theme="neon"] input[type="month"],
      html[data-theme="neon"] input[type="text"],
      html[data-theme="neon"] select{
        transition: border-color .15s ease, background-color .15s ease, box-shadow .15s ease;
      }
      html[data-theme="neon"] input[type="number"]:focus,
      html[data-theme="neon"] input[type="month"]:focus,
      html[data-theme="neon"] input[type="text"]:focus,
      html[data-theme="neon"] select:focus{
        border-color: rgba(34,211,238,.45);
        box-shadow: 0 0 0 3px rgba(34,211,238,.18), 0 6px 22px rgba(0,0,0,.35);
      }
      html[data-theme="neon"] input[type="number"]:hover,
      html[data-theme="neon"] input[type="month"]:hover,
      html[data-theme="neon"] input[type="text"]:hover,
      html[data-theme="neon"] select:hover{
        border-color: rgba(255,255,255,.20);
      }

      /* Toolbar groups: cleaner label emphasis */
      html[data-theme="neon"] .group .label{ color: color-mix(in oklab, var(--muted), white 10%) }

      /* Menu summary: hint that it&rsquo;s interactive */
      html[data-theme="neon"] .menu summary{ transition: background-color .15s ease, border-color .15s ease }
      html[data-theme="neon"] .menu summary:hover{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.16) }

      /* Toasts: add gentle shadow depth */
      html[data-theme="neon"] .toast{ box-shadow: 0 10px 30px rgba(0,0,0,.45) }
    }
    </style>
    <script>
      // Apply saved theme early (default: neon)
      (function(){
        try{
          var pref = localStorage.getItem('ui-theme');
          if(pref){ document.documentElement.setAttribute('data-theme', pref); }
        }catch(e){/* ignore */}
      })();
    </script>
<style>
  .table-wrap{
    overflow:auto;
    border-radius:8px;
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);
    box-shadow:var(--shadow);
  }
  table.data{
    width:100%;
    border-collapse:collapse;
    font-size:12px;
  }
  table.data thead th{
    position:sticky;top:0;
    background:rgba(15,23,42,.85);
    border-bottom:1px solid rgba(255,255,255,.1);
    backdrop-filter:blur(4px);
    z-index:1;
  }
  table.data tbody tr:nth-child(even){background:rgba(255,255,255,.03);}
  table.data tbody tr:hover{background:rgba(255,255,255,.06);}
  table.data th, table.data td{padding:4px 6px;}
  table.data .num{text-align:right;font-variant-numeric:tabular-nums;}
  table.data input[type="number"]{
    width:100%;
    max-width:100px;
    padding:2px 4px;
    height:24px;
    border-radius:6px;
    border:1px solid rgba(255,255,255,.15);
    background:rgba(17,24,39,.6);
    color:var(--ink);
    text-align:right;
  }
  @media(max-width:480px){
    table.data input[type="number"]{max-width:80px;}
  }
  .good{color:var(--good);}
  .bad{color:var(--bad);}
  .muted{color:var(--muted);}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="32" y2="32" gradientUnits="userSpaceOnUse">
              <stop stop-color="#22d3ee"/>
              <stop offset="1" stop-color="#a78bfa"/>
            </linearGradient>
          </defs>
          <path d="M16 3c7.18 0 13 5.82 13 13s-5.82 13-13 13S3 23.18 3 16 8.82 3 16 3Zm0 4a9 9 0 1 0 0 18 9 9 0 0 0 0-18Zm0 3.2a5.8 5.8 0 1 1 0 11.6A5.8 5.8 0 0 1 16 10.2Z" fill="url(#g)"/>
        </svg>
        <div>
          <h1>WEG Billing Calculator</h1>
          <div class="sub">Single&#8209;file tool for HT bill + wind credits &bull; Excel export with month sheets</div>
        </div>
      </div>
      <div class="toolbar">
        <!-- Theme toggle (UI only) -->
        <label class="pill" id="themeTogglePill" title="Toggle Neon/Classic">
          <span>Theme</span>
          <input type="checkbox" id="themeToggle" aria-label="Neon theme" checked />
        </label>
        <!-- Month -->
        <label class="pill"><span>Billing Month</span><input type="month" id="billMonth"/></label>
        <!-- Sheets menu (searchable) -->
        <div class="menu" aria-label="Sheets">
          <details id="sheetsMenu">
            <summary aria-haspopup="menu">Sheets &#9662;</summary>
            <div class="menu-panel" role="menu">
              <div class="pill" style="display:flex;gap:6px;align-items:center;min-height:30px">
                <input id="sheetSearch" type="text" placeholder="Search sheets&hellip;" aria-label="Search sheets" style="height:28px;line-height:28px;padding:0 8px;width:100%">
              </div>
              <div id="sheetMenuList" style="max-height:320px;overflow:auto"></div>
            </div>
          </details>
        </div>
        <div id="sheetList" class="pills" role="listbox" hidden aria-hidden="true"></div>

        <!-- Workbook menu -->
        <div class="menu" aria-label="Workbook">
          <details>
            <summary aria-haspopup="menu">Workbook &#9662;</summary>
            <div class="menu-panel" role="menu">
              <button id="addSheet" role="menuitem" class="ghost">Add/Update Sheet</button>
              <button id="uploadExcel" role="menuitem" class="ghost">Upload</button>
              <input type="file" id="uploadXlsx" accept=".xlsx" hidden>
                <label id="autoUpdateToggle" role="menuitemcheckbox" aria-checked="true" class="ghost">
                  <input type="checkbox" id="autoUpdateOnDownload" checked> Auto-update on Download
                </label>
              <div class="menu-sep"></div>
              <button id="downloadExcel" role="menuitem" class="ghost">Download</button>
            </div>
          </details>
        </div>

        <!-- IOM Output menu -->
        <div class="menu" aria-label="IOM Output">
          <details>
            <summary aria-haspopup="menu">Make IOM &#9662;</summary>
            <div class="menu-panel" role="menu">
              <button id="renderHtml" role="menuitem" class="ghost">Render IOM</button>
              <button id="menuSavePdf" role="menuitem" class="ghost">Save as PDF</button>
              <button id="menuOpenPdf" role="menuitem" class="ghost">Open PDF View</button>
              <label role="menuitemcheckbox" aria-checked="false" class="ghost"><input type="checkbox" id="autoPrintHtml"> Auto-print</label>
            </div>
          </details>
        </div>
        <!-- Hidden export buttons for logic; keep IDs for scripting -->
        <button id="saveHtmlPdf" style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden;"
                aria-hidden="true" tabindex="-1" disabled aria-disabled="true">Save as PDF</button>
        <button id="openHtmlPdf" class="ghost"
                style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden;"
                aria-hidden="true" tabindex="-1" disabled aria-disabled="true">Open PDF View</button>

        <!-- Utilities menu -->
        <div class="menu" aria-label="Utilities">
          <details>
            <summary aria-haspopup="menu">Utilities &#9662;</summary>
            <div class="menu-panel" role="menu">
              <button id="resetSample" role="menuitem" class="ghost">Sample Data</button>
              <button id="resetAll" role="menuitem" class="ghost">Reset</button>
              <button id="clearSheets" role="menuitem" class="ghost">Clear Sheets</button>
            </div>
          </details>
        </div>
        <!-- Analysis menu -->
        <div class="menu" aria-label="Analysis">
          <details>
            <summary aria-haspopup="menu">Analysis &#9662;</summary>
            <div class="menu-panel" role="menu">
              <button id="analyzeWorkbook" role="menuitem" class="ghost">Build Monthly Trends</button>
              <button id="exportAnalysisCsv" role="menuitem" class="ghost">Export Analysis CSV</button>
            </div>
          </details>
        </div>
        <!-- Configuration menu -->
        <div class="menu" aria-label="Configuration">
          <details id="configMenu">
            <summary id="configMenuSummary" aria-haspopup="dialog">Configuration &#9662;</summary>
            <div class="menu-panel config-panel" role="group" aria-label="Configuration panel">
              <div class="config-group" data-config-group="A">
                <h3>A. WEG &mdash; Inputs</h3>
                <div class="config-field">
                  <label for="config_share_bitlavadia_pct">Share Bitlavadia (%)</label>
                  <input type="number" step="0.01" min="0" max="100" id="config_share_bitlavadia_pct" aria-label="Share Bitlavadia percentage" inputmode="decimal">
                  <div class="config-hint" id="config_share_bitlavadia_pct_hint" data-default="0–100 (max two decimals)"></div>
                </div>
                <div class="config-field">
                  <label for="config_share_nanisindhodi_pct">Share Nanisindhodi (%)</label>
                  <input type="number" step="0.01" min="0" max="100" id="config_share_nanisindhodi_pct" aria-label="Share Nanisindhodi percentage" inputmode="decimal">
                  <div class="config-hint" id="config_share_nanisindhodi_pct_hint" data-default="0–100 (max two decimals)"></div>
                </div>
              </div>
              <div class="config-group" data-config-group="B">
                <h3>B. Central Dak Receipt &mdash; Inputs</h3>
                <div class="config-field">
                  <label for="config_vendor_code">Vendor Code</label>
                  <input type="text" id="config_vendor_code" aria-label="Vendor Code" autocomplete="off">
                  <div class="config-hint" id="config_vendor_code_hint"></div>
                </div>
                <div class="config-field">
                  <label for="config_vendor_name">Vendor Name</label>
                  <input type="text" id="config_vendor_name" aria-label="Vendor Name" autocomplete="off">
                  <div class="config-hint" id="config_vendor_name_hint"></div>
                </div>
                <div class="config-field">
                  <label for="config_eic_name">EIC Name</label>
                  <input type="text" id="config_eic_name" aria-label="EIC Name" autocomplete="off">
                  <div class="config-hint" id="config_eic_name_hint"></div>
                </div>
              </div>
              <div class="config-group" data-config-group="C">
                <h3>C. Central Dak Receipt &mdash; Rendered sheet</h3>
                <div class="config-field">
                  <label for="config_ips_samakhiali">Unit Name</label>
                  <input type="text" id="config_ips_samakhiali" aria-label="IPS unit name placeholder">
                  <div class="config-hint" id="config_ips_samakhiali_hint"></div>
                </div>
              </div>
              <div class="config-group" data-config-group="D">
                <h3>D. IOM Sheet &mdash; Rendered</h3>
                <div class="config-field">
                  <label for="config_iom_location">Location</label>
                  <input type="text" id="config_iom_location" aria-label="IOM location placeholder">
                  <div class="config-hint" id="config_iom_location_hint" data-default="Auto-fills from Unit Name; adjust if needed."></div>
                </div>
                <div class="config-field">
                  <label for="config_iom_company_name">Vendor Name</label>
                  <input type="text" id="config_iom_company_name" aria-label="IOM vendor name">
                  <div class="config-hint" id="config_iom_company_name_hint" data-default="Auto-fills from Central Dak vendor name."></div>
                </div>
                <div class="config-field">
                  <label for="config_iom_vendor_code">Vendor Code</label>
                  <input type="text" id="config_iom_vendor_code" aria-label="IOM vendor code">
                  <div class="config-hint" id="config_iom_vendor_code_hint" data-default="Auto-fills from Central Dak vendor code."></div>
                </div>
                <div class="config-field">
                  <label for="config_bank_ac_no">Bank A/C No.</label>
                  <input type="text" id="config_bank_ac_no" aria-label="Bank account number" autocomplete="off">
                  <div class="config-hint" id="config_bank_ac_no_hint"></div>
                </div>
                <div class="config-field">
                  <label for="config_ifsc">RTGS/NEFT IFSC</label>
                  <input type="text" id="config_ifsc" aria-label="IFSC code" autocapitalize="characters" autocomplete="off" maxlength="11">
                  <div class="config-hint" id="config_ifsc_hint" data-default="Uppercase, 11 characters"></div>
                </div>
                <div class="config-field">
                  <label for="config_branch">Branch</label>
                  <input type="text" id="config_branch" aria-label="Bank branch">
                  <div class="config-hint" id="config_branch_hint"></div>
                </div>
                <div class="config-field">
                  <label for="config_approver_dgm_wic">Approver &mdash; DGM (O&amp;M)/WIC</label>
                  <input type="text" id="config_approver_dgm_wic" aria-label="Approver DGM O and M WIC">
                  <div class="config-hint" id="config_approver_dgm_wic_hint"></div>
                </div>
                <div class="config-field">
                  <label for="config_approver_sm_ele">Approver &mdash; Senior Manager (ELE)</label>
                  <input type="text" id="config_approver_sm_ele" aria-label="Approver Senior Manager ELE">
                  <div class="config-hint" id="config_approver_sm_ele_hint"></div>
                </div>
                <div class="config-field">
                  <label for="config_approver_dgm_fa">Approver &mdash; DGM (F&amp;A)</label>
                  <input type="text" id="config_approver_dgm_fa" aria-label="Approver DGM F and A">
                  <div class="config-hint" id="config_approver_dgm_fa_hint"></div>
                </div>
              </div>
              <div class="config-actions">
                <button type="button" id="configApply">Apply</button>
                <button type="button" id="configDefaults" class="ghost">Defaults</button>
                <button type="button" id="configSave" class="ghost">Save</button>
                <button type="button" id="configDownload" class="ghost">Download</button>
                <button type="button" id="configLoad" class="ghost">Load/Import</button>
                <button type="button" id="configClose" class="ghost">Close</button>
              </div>
            </div>
          </details>
        </div>
        <input type="file" id="configFileInput" accept="application/json" hidden>
      </div>
      </header>
      <script>
        // Lightweight UI-only theme toggle wiring
        document.addEventListener('DOMContentLoaded', function(){
          var cb = document.getElementById('themeToggle');
          if(!cb) return;
          function apply(mode){
            document.documentElement.setAttribute('data-theme', mode);
            try{ localStorage.setItem('ui-theme', mode); }catch(e){}
          }
          var current = document.documentElement.getAttribute('data-theme') || 'neon';
          cb.checked = current !== 'classic';
          cb.addEventListener('change', function(){ apply(cb.checked ? 'neon' : 'classic'); });
        });
      </script>

      <div class="grid">
        <!-- Main HT Bill Inputs -->
      <section class="card span-12">
        <h2>HT Bill &mdash; Inputs <span class="help">Manual entries from utility bill</span></h2>
        <div class="card-split">
          <div class="card-in">
            <div class="fields">
              <div class="f"><label>Monthly Consumption (kWh) <span class="mono">A4</span></label><input type="number" id="A4" step="0.001" min="0"/><span class="hint"></span></div>
              <div class="f"><label>Demand Charges (&#8377;) <span class="mono">B4</span></label><input type="text" id="B4"/><span class="hint"></span></div>
              <div class="f"><label>Energy Charges (&#8377;) <span class="mono">C4</span></label><input type="text" id="C4"/><span class="hint"></span></div>
              <div class="f"><label>Fuel Charge (&#8377;) <span class="mono">E4</span></label><input type="text" id="E4"/><span class="hint"></span></div>
              <div class="f"><label>PF Rebate (&#8377;) <span class="mono">F4</span></label><input type="text" id="F4"/><span class="hint"></span></div>
              <div class="f"><label>Night Rebate (&#8377;) <span class="mono">D4</span></label><input type="text" id="D4"/><span class="hint"></span></div>
              <div class="f"><label>EHV Rebate (&#8377;) <span class="mono">G4</span></label><input type="text" id="G4"/><span class="hint"></span></div>
              <div class="f"><label>TOU (&#8377;) <span class="mono">H4</span></label><input type="text" id="H4"/><span class="hint"></span></div>
              <div class="f"><label>Time DISC Charges (&#8377;) <span class="mono">J4</span></label><input type="text" id="J4" placeholder="Include sign as on bill, e.g. -410.50 (credit) or 210.75 (charge)" title="Include sign as on bill, e.g. -410.50 (credit) or 210.75 (charge)"/><span class="hint"></span></div>
              <div class="f"><label>GT Charges (&#8377;) <span class="mono">I4</span></label><input type="text" id="I4"/><span class="hint"></span></div>
            </div>
          </div>
          <div class="card-out">
            <div class="kpi kpi-stack">
              <div class="box output-field" data-formula="A9 = B4+C4−D4+E4−F4−G4+H4+J4+I4" tabindex="0">
                <div class="field-label-row">
                  <span class="field-label">Tot Consumption Charge</span>
                  <span class="field-ref mono">A9</span>
                </div>
                <div class="v" id="A9v">&#8377;0</div>
              </div>
              <div class="box output-field" data-formula="B9 = A9×0.2" tabindex="0">
                <div class="field-label-row">
                  <span class="field-label">ED @ 20%</span>
                  <span class="field-ref mono">B9</span>
                </div>
                <div class="v" id="B9v">&#8377;0</div>
              </div>
              <div class="box output-field" data-formula="C9 = A9+B9" tabindex="0">
                <div class="field-label-row">
                  <span class="field-label">Current Month Bill</span>
                  <span class="field-ref mono">C9</span>
                </div>
                <div class="v" id="C9v">&#8377;0</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Adjustments -->
      <section class="card span-12 adjustments-card">
        <h2>Adjustments & Carry&#8209;forward <span class="help">Manual entries</span></h2>
        <div class="card-split">
          <div class="card-in">
            <div class="fields adjustments-fields">
              <div class="f adjustments-field"><label>Outstanding Arrears (&#8377;) <span class="mono">D9</span></label><input type="text" id="D9"/><span class="hint"></span></div>
              <div class="f adjustments-field"><label>Delayed Payment Charges (&#8377;) <span class="mono">F9</span></label><input type="text" id="F9"/><span class="hint"></span></div>
              <div class="f adjustments-field"><label>Advance Payment / Adjust. (&#8377;) <span class="mono">G9</span></label><input type="text" id="G9" placeholder="Include sign as on bill, e.g. -5241084.60 (credit) or 4102.69 (charge)" title="Include sign as on bill, e.g. -5241084.60 (credit) or 4102.69 (charge)"/><span class="hint"></span></div>
              <div class="f adjustments-field"><label>Freeze Amount (&#8377;) <span class="mono">E9</span></label><input type="text" id="E9"/><span class="hint"></span></div>
            </div>
          </div>
          <div class="card-out">
            <div class="kpi kpi-stack adjustments-kpis">
              <div class="box output-field" data-formula="H9 = C9+D9+F9+G9" tabindex="0">
                <div class="field-label-row">
                  <span class="field-label">Net Payable</span>
                  <span class="field-ref mono">H9</span>
                </div>
                <div class="v" id="H9v">&#8377;0</div>
              </div>
              <div class="box output-field" data-formula="I9 = H9−E9" tabindex="0">
                <div class="field-label-row">
                  <span class="field-label">Actual Amount to be Paid</span>
                  <span class="field-ref mono">I9</span>
                </div>
                <div class="v" id="I9v">&#8377;0</div>
              </div>
              <div class="box output-field" data-formula="A31 = D9−E9" tabindex="0">
                <div class="field-label-row">
                  <span class="field-label">Balance Pending from Previous Month</span>
                  <span class="field-ref mono">A31</span>
                </div>
                <div class="v" id="A31v">&#8377;0</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- WEG Credits -->
      <section class="card span-12 wind-card">
        <h2>Wind Credits & Debits <span class="help">Prior&#8208;month adjustments</span></h2>
        <div class="card-split">
          <div class="card-in">
            <div class="wind-groups">
              <div class="wind-group">
                <div class="wind-heading">Credit Adjustments</div>
                <div class="fields wind-grid">
                  <div class="f"><label>Credit Board Charges (&#8377;) <span class="mono">A24</span></label><input type="text" id="A24"/><span class="hint"></span></div>
                  <div class="f"><label>Credit ED Charges (&#8377;) <span class="mono">B24</span></label><input type="text" id="B24"/><span class="hint"></span></div>
                </div>
                <div class="extras-group wind-extras">
                  <details class="extras-panel" id="creditsExtrasPanel">
                    <summary>Credits Extras (optional)</summary>
                    <div class="extras-body">
                      <div class="extras-empty" id="creditsExtrasEmpty">No extras added.</div>
                      <div class="extras-list" id="creditsExtrasList"></div>
                    </div>
                    <button type="button" class="ghost extras-add" id="creditsExtrasAdd">Add item</button>
                  </details>
                </div>
              </div>
              <div class="hr wind-divider"></div>
              <div class="wind-group">
                <div class="wind-heading">Final Adjustments</div>
                <div class="fields wind-grid">
                  <div class="f"><label>Credit TDS (&#8377;) <span class="mono">C24</span></label><input type="text" id="C24"/><span class="hint"></span></div>
                </div>
                <div class="extras-group wind-extras">
                  <details class="extras-panel" id="finalExtrasPanel">
                    <summary>Final Adjustments Extras (optional)</summary>
                    <div class="extras-body">
                      <div class="extras-empty" id="finalExtrasEmpty">No extras added.</div>
                      <div class="extras-list" id="finalExtrasList"></div>
                    </div>
                    <button type="button" class="ghost extras-add" id="finalExtrasAdd">Add item</button>
                  </details>
                </div>
              </div>
              <div class="hr wind-divider"></div>
              <div class="wind-group">
                <div class="wind-heading">Debits</div>
                <div class="fields wind-grid wind-grid-debits">
                  <div class="f"><label>Debit Board Charges (&#8377;) <span class="mono">D24</span></label><input type="text" id="D24"/><span class="hint"></span></div>
                  <div class="f"><label>Debit Electricity Duty (&#8377;) <span class="mono">E24</span></label><input type="text" id="E24"/><span class="hint"></span></div>
                  <div class="f"><label>Debit Wheeling Charges (&#8377;) <span class="mono">F24</span></label><input type="text" id="F24"/><span class="hint"></span></div>
                </div>
                <div class="extras-group wind-extras">
                  <details class="extras-panel" id="debitsExtrasPanel">
                    <summary>Debits Extras (optional)</summary>
                    <div class="extras-body">
                      <div class="extras-empty" id="debitsExtrasEmpty">No extras added.</div>
                      <div class="extras-list" id="debitsExtrasList"></div>
                    </div>
                    <button type="button" class="ghost extras-add" id="debitsExtrasAdd">Add item</button>
                  </details>
                </div>
              </div>
            </div>
          </div>
          <div class="card-out">
            <div class="kpi kpi-stack">
              <div class="box output-field" data-formula="A26 = A24+B24" tabindex="0">
                <div class="field-label-row">
                  <span class="field-label">Total Credit (₹)</span>
                  <span class="field-ref mono">A26</span>
                </div>
                <div class="v" id="A26v">&#8377;0</div>
              </div>
              <div class="box output-field" data-formula="B26 = D24+E24+F24" tabindex="0">
                <div class="field-label-row">
                  <span class="field-label">Total Debit (₹)</span>
                  <span class="field-ref mono">B26</span>
                </div>
                <div class="v" id="B26v">&#8377;0</div>
              </div>
              <div class="box output-field" data-formula="C26 = A26−B26" tabindex="0">
                <div class="field-label-row">
                  <span class="field-label">Net Wind Credit (₹)</span>
                  <span class="field-ref mono">C26</span>
                </div>
                <div class="v" id="C26v">&#8377;0</div>
              </div>
              <div class="box output-field" data-formula="B19 = IF(A19=0,0,C26/A19)" tabindex="0">
                <div class="field-label-row">
                  <span class="field-label">Wind Rate (₹ / kWh)</span>
                  <span class="field-ref mono">B19</span>
                </div>
                <div class="v" id="B19v">&#8377;0</div>
                <small class="warn-text" id="windRateWarn">kWh allocated is zero; rate shown as &#8377;0.00/kWh</small>
              </div>
              <div class="box output-field" data-formula="F16 = B19×A18" tabindex="0">
                <div class="field-label-row">
                  <span class="field-label">Share of 4.5 MW WEG (₹)</span>
                  <span class="field-ref mono">F16</span>
                </div>
                <div class="v" id="F16v">&#8377;0</div>
              </div>
              <div class="box output-field" data-formula="G16 = B19×C18" tabindex="0">
                <div class="field-label-row">
                  <span class="field-label">Share of 14.7 MW WEG (₹)</span>
                  <span class="field-ref mono">G16</span>
                </div>
                <div class="v" id="G16v">&#8377;0</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- WEG Inputs -->
      <section class="card span-12 weg-card">
        <h2>WEG &mdash; Inputs <span class="help">Bitlavadia (4.5 MW) & Nanisindhodi (14.7 MW)</span></h2>
        <div class="card-split">
          <div class="card-in">
            <div class="fields weg-fields">
              <div class="f"><label>Share Bitlavadia (%) <span class="mono">B15</span></label><input type="number" id="B15" step="0.01" min="0" max="100"/><span class="hint"></span></div>
              <div class="f"><label>Share Nanisindhodi (%) <span class="mono">D15</span></label><input type="number" id="D15" step="0.01" min="0" max="100"/><span class="hint"></span></div>
              <div class="f"><label>Transmission Loss (%) <span class="mono">C16</span></label><input type="number" id="C16" step="0.01" min="0" max="100"/><span class="hint"></span></div>
            </div>
            <div class="weg-generation">
              <div class="muted" style="font-size:12px;letter-spacing:.08em;text-transform:uppercase;">Monthly Generation (MWh)</div>
              <div class="fields weg-generation-fields">
                <div class="f weg-gen-field weg-gen-bit-1"><label>Bitlavadia MWh #1 <span class="mono">A17</span></label><input type="number" id="A17" step="0.001" min="0"/><span class="hint"></span></div>
                <div class="f weg-gen-field weg-gen-bit-2"><label>Bitlavadia MWh #2 <span class="mono">B17</span></label><input type="number" id="B17" step="0.001" min="0"/><span class="hint"></span></div>
                <div class="f weg-gen-field weg-gen-nan-1"><label>Nanisindhodi MWh #1 <span class="mono">C17</span></label><input type="number" id="C17" step="0.001" min="0"/><span class="hint"></span></div>
                <div class="f weg-gen-field weg-gen-nan-2"><label>Nanisindhodi MWh #2 <span class="mono">D17</span></label><input type="number" id="D17" step="0.001" min="0"/><span class="hint"></span></div>
                <div class="f weg-gen-field weg-gen-nan-3"><label>Nanisindhodi MWh #3 <span class="mono">E17</span></label><input type="number" id="E17" step="0.001" min="0"/><span class="hint"></span></div>
              </div>
            </div>
          </div>
          <div class="card-out">
            <div class="kpi kpi-stack weg-kpis">
              <div class="box output-field" data-formula="A18 = ROUNDUP((A17+B17)*1000*B15%*(1−C16%),0)" tabindex="0">
                <div class="field-label-row">
                  <span class="field-label">Bitlavadia Share (kWh)</span>
                  <span class="field-ref mono">A18</span>
                </div>
                <div class="v" id="A18v">0 kWh</div>
              </div>
              <div class="box output-field" data-formula="C18 = ROUNDUP((C17+D17+E17)*1000*D15%*(1−C16%),0)" tabindex="0">
                <div class="field-label-row">
                  <span class="field-label">Nanisindhodi Share (kWh)</span>
                  <span class="field-ref mono">C18</span>
                </div>
                <div class="v" id="C18v">0 kWh</div>
              </div>
              <div class="box output-field" data-formula="A19 = A18+C18" tabindex="0">
                <div class="field-label-row">
                  <span class="field-label">Total Allocated (kWh)</span>
                  <span class="field-ref mono">A19</span>
                </div>
                <div class="v" id="A19v">0 kWh</div>
              </div>
            </div>
          </div>
        </div>
      </section>

        <!-- Final Bill -->
        <section class="card span-7 main-final">
          <h2>Final Bill for IOM</h2>
          <div class="final-card">
            <div class="final-main">
              <div class="formula mono">Formula: C9 &minus; F16 &minus; G16 &minus; C24 + A31 + F9</div>
              <div class="amount" id="FINALv">&#8377;0</div>
              <div class="mapping muted">Mapping: Current Month Bill &minus; Share(4.5MW) &minus; Share(14.7MW) &minus; Credit TDS + Balance Pending (prev) + Delay Charges</div>
            </div>
            <div class="final-breakdown">
              <div class="item">
                <div class="label">Current Month Bill <span class="mono">C9</span></div>
                <div class="value base" id="FINAL_C9v">&#8377;0</div>
              </div>
              <div class="item">
                <div class="label">Share of 4.5 MW WEG <span class="mono">F16</span></div>
                <div class="value minus" id="FINAL_F16v">&#8377;0</div>
              </div>
              <div class="item">
                <div class="label">Share of 14.7 MW WEG <span class="mono">G16</span></div>
                <div class="value minus" id="FINAL_G16v">&#8377;0</div>
              </div>
              <div class="item">
                <div class="label">Credit TDS <span class="mono">C24</span></div>
                <div class="value minus" id="FINAL_C24v">&#8377;0</div>
              </div>
              <div class="item">
                <div class="label">Balance Pending (prev) <span class="mono">A31</span></div>
                <div class="value plus" id="FINAL_A31v">&#8377;0</div>
              </div>
              <div class="item">
                <div class="label">Delay Charges <span class="mono">F9</span></div>
                <div class="value plus" id="FINAL_F9v">&#8377;0</div>
              </div>
            </div>
          </div>
        </section>
        <!-- Rates Manager -->
        <section class="card span-5 final-check-card">
          <h2>Final Bill Check</h2>
          <p class="muted" style="margin-top:-4px;margin-bottom:12px;">Reconcile FINAL against I9 before approval.</p>
          <div id="finalCheckBadge" class="pill pill-check" role="status" aria-live="polite">
            <div class="status-wrap" aria-hidden="true">
              <span id="FINALstatusv" class="status">✓</span>
              <span id="FINALstatusLabel" class="status-label">Check</span>
            </div>
            <div class="metrics">
              <div class="metric">
                <span class="metric-label">I9 (= H9 &minus; E9)</span>
                <span class="metric-value" id="I9checkv">&#8377;0</span>
              </div>
              <div class="metric">
                <span class="metric-label">Final Bill for IOM</span>
                <span class="metric-value" id="FINALexpectedv">&#8377;0</span>
              </div>
              <div class="metric">
                <span class="metric-label">&Delta;</span>
                <span class="metric-value" id="FINALdeltav">&#8377;0</span>
              </div>
            </div>
          </div>
        </section>
        <section class="card span-12" id="ratesCard">
          <h2>Rates Manager (Tariffs &amp; PO Rates)</h2>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
            <button id="importRates">Load/Import</button>
            <button id="downloadTariffs" class="ghost">Download Tariffs</button>
            <button id="downloadPoRates" class="ghost">Download PO Rates</button>
            <button id="editRates" class="ghost">Edit Rates</button>
            <button id="saveRates">Save</button>
            <button id="exportCsv" class="ghost">Export CSV</button>
          </div>
          <div class="hr"></div>
          <div class="table-wrap">
            <table id="ratesTable" class="data">
              <thead>
                <tr>
                  <th style="text-align:left;">Service</th>
                  <th class="num">Qty (B)</th>
                  <th class="num">Tariff (C) &mdash; number | % for PF &amp; TOD Night</th>
                  <th class="num">Amt (D)</th>
                  <th class="num">Contract Rate (E)</th>
                  <th class="num">Unit Adj (F)</th>
                  <th class="num">Amount SES (G)</th>
                </tr>
              </thead>
              <tbody id="ratesBody"></tbody>
            </table>
          </div>
          <div id="parityBadge" class="pill" style="margin-top:8px;">&Sigma;D &#8377;0.00 | &Sigma;G &#8377;0.00 | &Delta; &#8377;0.00</div>
          <input type="file" id="ratesFile" accept="application/json" style="display:none" multiple>
        </section>
        <!-- Long Text for SAP -->
        <section class="card span-12" aria-labelledby="sapLongTextH">
        <h2 id="sapLongTextH">Long Text for SAP</h2>
        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <button id="genSapText">Generate</button>
          <button id="copySapText" class="ghost">Copy</button>
        </div>
        <textarea id="sapText" rows="14" readonly aria-label="SAP long text" style="width:100%;"></textarea>
        <div class="muted" style="margin-top:4px;">Click Generate, review, then Copy and paste into SAP.</div>
      </section>
        <!-- Central Dak Receipt Inputs -->
        <section class="card span-8" id="receiptCard">
          <h2>Central Dak Receipt &mdash; Inputs</h2>
          <div class="fields">
            <!-- Row 1 -->
            <div class="f">
              <label for="rc_vendorCode">Vendor Code</label>
              <input type="text" id="rc_vendorCode" placeholder="e.g., ZG0435"/>
            </div>
            <div class="f">
              <label for="rc_vendorName">Vendor Name</label>
              <input type="text" id="rc_vendorName" placeholder="e.g., Paschim Gujarat Vij Company Ltd"/>
            </div>
            <!-- Single-line 3-up row -->
            <div class="row-3up">
              <div class="f">
                <label for="rc_billNo">Bill No.</label>
                <input type="text" id="rc_billNo" placeholder="e.g., DAK-ZG0435-20250308-0912"/>
              </div>
              <div class="f">
                <label for="rc_billDate">Bill Date</label>
                <input type="text" id="rc_billDate" placeholder="DD-MM-YYYY" inputmode="numeric" autocomplete="off"/>
              </div>
              <div class="f">
                <label for="rc_eic">EIC Name</label>
                <input type="text" id="rc_eic" placeholder="e.g., Vijendra Singh"/>
              </div>
            </div>
            <!-- Amount -->
            <div class="f">
              <label for="rc_amount">Amount</label>
              <input type="text" id="rc_amount" placeholder="e.g., 13108871.45"/>
              <small class="hint">Indian grouping applied on render</small>
            </div>
          </div>
          <div class="actions" role="group" aria-label="Receipt actions">
            <button id="renderReceiptInCard" type="button" aria-label="Render Central Dak Receipt">Render Receipt</button>
            <button id="saveReceiptPdfInCard" type="button" class="ghost" aria-label="Save Central Dak Receipt as PDF">Save as PDF</button>
          </div>
        </section>
        <!-- Data Analysis card -->
        <section class="card span-12" id="analysisCard" hidden>
          <h2>Data Analysis <span class="help">Trends across YYYY-MM sheets</span></h2>
          <div id="analysisMeta" class="muted"></div>
          <div id="analysisControls" class="muted analysis-controls">
            <label for="analysisMetric">Metric</label>
            <select id="analysisMetric">
              <option value="A4">A4</option>
              <option value="C9" selected>C9</option>
              <option value="I9">I9</option>
              <option value="B19">B19</option>
              <option value="A18">A18</option>
              <option value="C18">C18</option>
              <option value="C26">C26</option>
              <option value="EffRate">EffRate</option>
              <option value="&Delta;C9">&Delta;C9</option>
              <option value="&Delta;%C9">&Delta;%C9</option>
            </select>
          </div>
          <div id="analysisStats" class="analysis-stats" role="list" hidden></div>
          <div id="analysisChartHost">
            <canvas id="analysisChart" height="220" aria-label="Analysis trend chart"></canvas>
          </div>
          <div class="hr"></div>
          <div style="max-height:320px;overflow:auto">
            <table id="analysisTable" style="width:100%;border-collapse:collapse;font-size:12px">
              <thead>
                <tr>
                  <th style="text-align:left">Month</th>
                  <th>A4 kWh</th><th>C9 &#8377;</th><th>I9 &#8377;</th>
                  <th>B19 &#8377;/kWh</th><th>A18 kWh</th><th>C18 kWh</th><th>C26 &#8377;</th>
                  <th>Eff Rate &#8377;/kWh</th><th>&Delta; C9 MoM &#8377;</th><th>&Delta;% C9</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
        <script>
          // Normalize Data Analysis table headers to human-friendly labels while keeping cell refs
          window.addEventListener('DOMContentLoaded', () => {
            try{
              const tr = document.querySelector('#analysisTable thead tr');
              if(!tr) return;
              tr.innerHTML = [
                '<th style="text-align:left">Month</th>',
                ' <th>Monthly Consumption (A4)</th>',
                ' <th>Current Month Bill (C9)</th>',
                ' <th>Actual Paid (I9)</th>',
                ' <th>Wind Rate &#8377;/kWh (B19)</th>',
                ' <th>Bitlavadia Share (A18)</th>',
                ' <th>Nanisindhodi Share (C18)</th>',
                ' <th>Net Wind Credit (C26)</th>',
                ' <th>Effective Rate &#8377;/kWh</th>',
                ' <th>MoM Change in Bill (&Delta;C9)</th>',
                ' <th>% Change in Bill (&Delta;C9)</th>'
              ].join('');
            }catch(_){ }
          });
        </script>
    </div>

  </div>

  <div id="htmlPrintHost" role="region" aria-label="A4 print preview" aria-busy="false" tabindex="-1"></div>
  <div id="toasts" role="status" aria-live="polite"></div>
  <div id="modal" role="dialog" aria-modal="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1100; align-items:center; justify-content:center;">
    <div style="background:var(--card); color:var(--ink); padding:16px; border-radius:12px; min-width:300px; box-shadow:var(--shadow)">
      <div id="modalText" style="margin-bottom:12px"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end">
        <button id="modalCancel" class="ghost">Cancel</button>
        <button id="modalOk">Replace</button>
      </div>
    </div>
  </div>

  <script>
    function toast(msg, type='info'){
      const host = document.getElementById('toasts');
      if(!host){
        try{ console.warn('[toast] container #toasts not found; message:', msg); }catch(_){ }
        return;
      }
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.textContent = msg;
      host.appendChild(t);
      setTimeout(()=>{
        t.classList.add('hide');
        t.addEventListener('transitionend',()=>t.remove());
      },3000);
    }
  </script>

    <!-- SheetJS for Excel export -->
    <!-- Prefer a local copy for offline/file:// usage; keep dynamic loader as fallback -->
    <script src="./xlsx.full.min.js"></script>
    <!-- pdfMake support removed -->
    <script>
      // Tries: ?xlsx=override &rarr; ./xlsx.full.min.js (local) &rarr; CDNs
      let __xlsxLoading = null;
    async function loadXLSX(){
      if (window.XLSX) return true; // already present (e.g., local tag succeeded)
      if (__xlsxLoading) return __xlsxLoading;
      __xlsxLoading = (async () => {
        const qp = new URLSearchParams(location.search);
        const override = qp.get('xlsx'); // optional: ?xlsx=/path/to/xlsx.full.min.js
        const urls = [
          ...(override ? [override] : []),
          './xlsx.full.min.js',
          'https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js',
          'https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js'
        ];
        let lastTried = '';
        for (const src of urls){
          lastTried = src;
          try{
            await new Promise((resolve, reject) => {
              const s = document.createElement('script');
              s.src = src;
              s.async = true;
              s.onload = resolve;
              s.onerror = reject;
              document.head.appendChild(s);
            });
            if (window.XLSX) return true;
          }catch{/* try next */}
        }
        toast(`Excel library failed to load (last: ${lastTried}). You are likely offline or a CSP blocked CDNs. Place "xlsx.full.min.js" next to this HTML or pass ?xlsx=/path/to/xlsx.full.min.js`, 'bad');
        return false;
      })();
      const ok = await __xlsxLoading;
      __xlsxLoading = null;
      return ok;
    }

    // Restore the small UX helper to show a temporary busy state on buttons.
    // Many toolbar handlers call withBusy('buttonId', async () => { ... }).
    async function withBusy(btnId, fn){
      const btn = document.getElementById(btnId);
      const prevDisabled = btn ? btn.disabled : false;
      const prevText = btn ? btn.textContent : '';
      if (btn){
        btn.disabled = true;
        btn.dataset.prevText = prevText;
        btn.textContent = 'Working&hellip;';
      }
      try{
        return await fn();
      } finally {
        if (btn){
          btn.disabled = prevDisabled;
          btn.textContent = btn.dataset.prevText || prevText;
          delete btn.dataset.prevText;
        }
      }
    }

  </script>
  <script>
    // Receipt card: bind AFTER DOM is ready so targets/handlers exist.
    window.addEventListener('DOMContentLoaded', () => {
      // De-dupe accidental duplicate IDs (keep the first; remove others)
      const dedupeById = (id) => {
        const nodes = document.querySelectorAll(`#${id}`);
        for (let i = 1; i < nodes.length; i++) nodes[i].remove();
      };
      ['receiptCard','htmlPrintHost','saveHtmlPdf','openHtmlPdf',
       'renderReceiptInCard','saveReceiptPdfInCard','toasts','modal']
        .forEach(dedupeById);

      const card = document.getElementById('receiptCard');
      if (card?.dataset.bound === '1') return;
      if (card) card.dataset.bound = '1';
      const ids = ['rc_vendorCode','rc_vendorName','rc_billNo','rc_billDate','rc_eic','rc_amount'];
      // Strip any stale disabling to keep inputs interactive
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.removeAttribute('disabled');
        el.removeAttribute('readonly');
        el.style.pointerEvents = '';
        if(!el.getAttribute('type')) el.setAttribute('type','text'); // ensure plain text behavior
      });
      // defaults handled separately
      // Card-level actions wired like "Make IOM" (proxy to existing flow)
      const host    = document.getElementById('htmlPrintHost');
      const btnSave = document.getElementById('saveHtmlPdf');
      const btnOpen = document.getElementById('openHtmlPdf');
      const btnRenderInCard = document.getElementById('renderReceiptInCard');
      const btnSaveInCard   = document.getElementById('saveReceiptPdfInCard');
      if (btnRenderInCard && !btnRenderInCard.getAttribute('type')) btnRenderInCard.setAttribute('type','button');
      if (btnSaveInCard   && !btnSaveInCard.getAttribute('type'))   btnSaveInCard.setAttribute('type','button');

      function pickReceiptRenderer(){
        if (typeof window.renderDakReceipt === 'function') return window.renderDakReceipt;
        if (typeof window.renderHtmlReceipt === 'function') return window.renderHtmlReceipt;
        if (typeof window.renderHtml === 'function') return window.renderHtml; // last resort
        return null;
      }

      function ensureReceiptRenderedThen(fnAfter){
        const needsRender = !host || host.children.length === 0 || btnSave?.disabled;
        // Resolve a renderer; fall back to any legacy toolbar hook.
        const doRender = () => {
          const fn = pickReceiptRenderer();
          if (fn) { try { return fn(); } catch(_){} }
          const tbBtn = document.getElementById('renderReceipt'); // legacy (may be missing)
          if (tbBtn) { try { tbBtn.click(); return; } catch(_){} }
          try { toast('No receipt renderer is available. Please enable renderDakReceipt.', 'bad'); } catch(_){}
        };
        if (needsRender){
          host?.setAttribute('aria-busy','true');
          doRender();
          host?.scrollIntoView({behavior:'smooth'});
          // Resolve on first .sheet (or timeout)
          let done = false;
          const finish = () => {
            if (done) return; done = true;
            host?.removeAttribute('aria-busy');
            const hasSheet = !!(host && host.querySelector('.sheet'));
            if (hasSheet) { try { btnSave && (btnSave.disabled = false); btnOpen && (btnOpen.disabled = false); } catch(_){} }
            try{ toast(hasSheet ? 'Receipt ready.' : 'Render did not produce a sheet.', hasSheet ? 'good' : 'bad'); }catch(_){ }
            fnAfter?.();
          };
          try{
            const observer = new MutationObserver(() => {
              if (host && host.querySelector('.sheet')) { observer.disconnect(); finish(); }
            });
            if (host) observer.observe(host, {childList:true, subtree:true});
            setTimeout(() => { try{ observer.disconnect(); }catch(_){} finish(); }, 1500);
          }catch(_){ setTimeout(finish, 300); }
        } else {
          host?.scrollIntoView({behavior:'smooth'});
          fnAfter?.();
        }
      }

      btnRenderInCard?.addEventListener('click', (e) => {
        e.preventDefault();
        const fn = window.renderDakReceipt;
        if (typeof fn === 'function') return fn();
        try { toast('No receipt renderer available. Please enable renderDakReceipt.', 'bad'); } catch {}
      });

      // Receipt: Save as PDF (ensure title is set BEFORE print dialog appears)
      btnSaveInCard?.addEventListener('click', async (e) => {
        e.preventDefault();
        // Ensure filename/title is captured by the UA immediately
        const safeBill = sanitizeFileStem(document.getElementById('rc_billNo')?.value);
        const prevTitle = document.title;
        document.title = safeBill ? `Central Dak Receipt - ${safeBill}` : 'Central Dak Receipt';
          await withBusy('saveReceiptPdfInCard', async () => {
            ensureReceiptRenderedThen(() => {
              const host  = document.getElementById('htmlPrintHost');
              document.documentElement.classList.add('print-rcpt');
              const sheet = host && (host.querySelector('.sheet.receipt') || host.querySelector('.sheet.rcpt'));
              const doFit = () => {
                try {
                  if (typeof window.setRcptPrintScaleIfNeeded === 'function') window.setRcptPrintScaleIfNeeded(sheet);
                } catch(_) {}
              };
              // Wait for fonts & a frame so height is stable, then fit & print once.
              const fontsReady = (document.fonts && document.fonts.ready) ? document.fonts.ready : Promise.resolve();
              fontsReady
                .then(() => new Promise(r => requestAnimationFrame(r)))
                .then(() => {
                  doFit();
                  try { window.focus(); } catch {}
                  prunePrintSheets(host);
                  window.print();
                });
            const cleanup = () => {
              document.title = prevTitle;
              document.documentElement.classList.remove('print-rcpt');
              document.documentElement.style.removeProperty('--rcpt-scale');
            };
            addEventListener('afterprint', cleanup, { once:true });
            const onVis = () => {
              // Cleanup only when back from print (dialog closed)
              if (document.visibilityState === 'visible' && !window.matchMedia('print').matches){
                document.removeEventListener('visibilitychange', onVis, true);
                cleanup();
              }
            };
            // fallback in case afterprint is suppressed by the UA/extension
            document.addEventListener('visibilitychange', onVis, true);
          });
        });
      });
    });
  </script>
  <script>
    // Utility helpers (extended for receipt card)
      // Produce a filesystem-safe, UI-friendly filename stem (no extension).
      // Matches existing behavior: replace illegal chars, collapse spaces/dashes, trim, and cap length.
        function sanitizeFileStem(input, maxLen = 120){
          const s = String(input ?? '').trim();
          if (!s) return '';
          return s
            .replace(/[\\\/:*?"<>|]/g, '-')  // illegal on Windows/macOS
            .replace(/\s+/g, ' ')            // collapse whitespace
            .replace(/-+/g, '-')             // collapse dashes
            .replace(/[.\s-]+$/g, '')        // no trailing dot/space/dash
            .slice(0, maxLen);
      }

      function prunePrintSheets(host){
        if (!host) return;

        // 1) Remove non-sheet nodes and whitespace-only text nodes to avoid stray breaks
        try {
          Array.from(host.childNodes).forEach(n => {
            if (n.nodeType === 3) { // text
              if (!/\S/.test(n.nodeValue || '')) n.remove();
              return;
            }
            if (n.nodeType === 1) { // element
              const el = n;
              if (!el.classList.contains('sheet')) el.remove();
            }
          });
        } catch(_){ }

        // 2) Clean hidden/empty sheets
        const sheets = Array.from(host.children).filter(el => el.classList.contains('sheet'));
        for (const el of sheets){
          const cs = window.getComputedStyle(el);
          const hidden = el.hasAttribute('hidden') ||
                         cs.display === 'none' ||
                         cs.visibility === 'hidden';
          const empty  = !el.textContent.trim();
          if (hidden || empty) el.remove();
        }

        // 3) Keep exactly one preferred sheet (receipt/rcpt if present)
        const remaining = Array.from(host.children).filter(el => el.classList.contains('sheet'));
        if (remaining.length <= 1) return;
        let keep = null;
        for (let i = remaining.length - 1; i >= 0; i--){
          const el = remaining[i];
          if (el.classList.contains('receipt') || el.classList.contains('rcpt')){
            keep = el;
            break;
          }
        }
        keep = keep || remaining[remaining.length - 1];
        for (const el of remaining){
          if (el !== keep) el.remove();
        }
      }

      window.prunePrintSheets = prunePrintSheets;

      const esc = (s) => String(s ?? '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])).replace(/'/g,'&#39;');
      const INR = new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR', maximumFractionDigits:2 });
      // Ensure receipt helpers are defined where they are used
      const inr = (n) => {
        try { return new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR', minimumFractionDigits:2, maximumFractionDigits:2}).format(Number(n)||0) + '/-'; }
        catch { return '&#8377;' + (Number(n)||0).toFixed(2) + '/-'; }
      };
      const cleanAmount = (str) => {
        const cleaned = String(str ?? '').replace(/[^0-9.\-]/g,''); const n = parseFloat(cleaned);
        return Number.isFinite(n) ? n : 0;
      };
      const EM_DASH = '\u2014';
      const validDDMMYYYY = (s) => {
        if(!/^\d{2}-\d{2}-\d{4}$/.test(String(s||''))) return false;
        const [dd,mm,yyyy] = s.split('-').map(Number); const dt = new Date(yyyy, mm-1, dd);
        return dt.getFullYear()===yyyy && dt.getMonth()===mm-1 && dt.getDate()===dd;
      };
      const KWH = new Intl.NumberFormat('en-IN', { maximumFractionDigits:0 });
      const RATE = new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR', maximumFractionDigits:6 });
      const SAMPLE = {
        A4:1000,B4:5000,C4:8000,D4:200,E4:300,F4:100,G4:50,H4:400,I4:600,J4:0,
        D9:200,E9:50,F9:30,G9:0,
        B15:30,D15:70,C16:2,
        A17:1,B17:1,C17:2,D17:1,E17:1,
        A24:500,B24:200,C24:100,D24:50,E24:25,F24:25
      };

    const CONFIG_META = {
      share_bitlavadia_pct: { inputId:'config_share_bitlavadia_pct', hintId:'config_share_bitlavadia_pct_hint', percent:true },
      share_nanisindhodi_pct: { inputId:'config_share_nanisindhodi_pct', hintId:'config_share_nanisindhodi_pct_hint', percent:true },
      vendor_code: { inputId:'config_vendor_code', hintId:'config_vendor_code_hint', trim:true },
      vendor_name: { inputId:'config_vendor_name', hintId:'config_vendor_name_hint', trim:true },
      eic_name: { inputId:'config_eic_name', hintId:'config_eic_name_hint', trim:true },
      ips_samakhiali: { inputId:'config_ips_samakhiali', hintId:'config_ips_samakhiali_hint', trim:true },
      iom_location: { inputId:'config_iom_location', hintId:'config_iom_location_hint', trim:true },
      iom_company_name: { inputId:'config_iom_company_name', hintId:'config_iom_company_name_hint', trim:true },
      iom_vendor_code: { inputId:'config_iom_vendor_code', hintId:'config_iom_vendor_code_hint', trim:true },
      bank_ac_no: { inputId:'config_bank_ac_no', hintId:'config_bank_ac_no_hint', trim:true },
      ifsc: { inputId:'config_ifsc', hintId:'config_ifsc_hint', trim:true, uppercase:true },
      branch: { inputId:'config_branch', hintId:'config_branch_hint', trim:true },
      approver_dgm_wic: { inputId:'config_approver_dgm_wic', hintId:'config_approver_dgm_wic_hint', trim:true },
      approver_sm_ele: { inputId:'config_approver_sm_ele', hintId:'config_approver_sm_ele_hint', trim:true },
      approver_dgm_fa: { inputId:'config_approver_dgm_fa', hintId:'config_approver_dgm_fa_hint', trim:true }
    };
    const CONFIG_KEYS = Object.keys(CONFIG_META);
    const CONFIG_INPUT_TARGETS = [
      ['share_bitlavadia_pct','B15'],
      ['share_nanisindhodi_pct','D15'],
      ['vendor_code','rc_vendorCode'],
      ['vendor_name','rc_vendorName'],
      ['eic_name','rc_eic']
    ];
    const CONFIG_LS_KEY = 'app_config_v1';
    const isConfigInput = (el) => {
      if(!el) return false;
      if(el.id === 'configFileInput') return true;
      return !!el.closest('#configMenu');
    };
    const CONFIG_DEFAULTS = {
      share_bitlavadia_pct:'',
      share_nanisindhodi_pct:'',
      vendor_code:'ZG0435',
      vendor_name:'Paschim Gujarat Vij Company Ltd',
      eic_name:'Vijendra Singh',
      ips_samakhiali:'IPS Samakhiali',
      iom_location:'Samakhiali, Gujarat',
      iom_company_name:'Paschim Gujarat Vij Company Ltd',
      iom_vendor_code:'ZG0435',
      bank_ac_no:'31729314272',
      ifsc:'SBIN0000554',
      branch:'SBI – Bhachau',
      approver_dgm_wic:'DGM (O&M)/WIC, Samakhiali',
      approver_sm_ele:'Senior Manager (ELE)',
      approver_dgm_fa:'DGM (F&A), Jaipur'
    };

    function coerceConfigValue(key, value){
      const meta = CONFIG_META[key] || {};
      let out = value;
      if(out == null){
        out = '';
      }else if(typeof out === 'number'){
        out = Number.isFinite(out) ? String(out) : '';
      }else if(typeof out === 'boolean'){
        out = out ? 'true' : 'false';
      }else{
        out = String(out);
      }
      if(meta.trim !== false){
        out = out.trim();
      }
      if(meta.uppercase){
        out = out.toUpperCase();
      }
      return out;
    }

    function normalizeConfigValues(src){
      const out = {};
      if(!src || typeof src !== 'object') return out;
      CONFIG_KEYS.forEach(key=>{
        if(Object.prototype.hasOwnProperty.call(src, key)){
          out[key] = coerceConfigValue(key, src[key]);
        }
      });
      return out;
    }

    function buildConfigPayload(cfg){
      const payload = {};
      CONFIG_KEYS.forEach(key=>{
        payload[key] = coerceConfigValue(key, cfg ? cfg[key] : '');
      });
      return payload;
    }

    function persistAppConfig(cfg){
      try{
        localStorage.setItem(CONFIG_LS_KEY, JSON.stringify(buildConfigPayload(cfg)));
      }catch(err){
        console.warn('Could not save configuration:', err);
      }
    }

    function setAppConfig(patch, opts={}){
      const normalized = normalizeConfigValues(patch);
      const current = (window.appConfig && typeof window.appConfig === 'object') ? window.appConfig : {};
      window.appConfig = { ...CONFIG_DEFAULTS, ...current, ...normalized };
      window.appConfig.iom_vendor_code = window.appConfig.iom_vendor_code || window.appConfig.vendor_code;
      window.appConfig.iom_company_name = window.appConfig.iom_company_name || window.appConfig.vendor_name;
      window.appConfig.iom_location = window.appConfig.iom_location || window.appConfig.ips_samakhiali;
      if(opts.persist){
        persistAppConfig(window.appConfig);
      }
      return window.appConfig;
    }

    function getConfigInputEl(key){
      const meta = CONFIG_META[key];
      return meta ? document.getElementById(meta.inputId) : null;
    }

    function getConfigHintEl(key){
      const meta = CONFIG_META[key];
      return meta ? document.getElementById(meta.hintId) : null;
    }

    function setConfigHint(key, message='', type=''){
      const hintEl = getConfigHintEl(key);
      if(!hintEl) return;
      const defaultMsg = hintEl.getAttribute('data-default') || '';
      hintEl.textContent = message || defaultMsg;
      hintEl.classList.remove('error','warn');
      if(type){
        hintEl.classList.add(type);
      }
    }

    function hydrateConfigForm(cfg, opts={}){
      CONFIG_KEYS.forEach(key=>{
        const el = getConfigInputEl(key);
        if(el){
          el.value = coerceConfigValue(key, cfg ? cfg[key] : '');
          if(opts.resetManual) el.dataset.configManual = '';
        }
        setConfigHint(key, '', '');
      });
    }

    function readConfigForm(){
      const values = {};
      CONFIG_KEYS.forEach(key=>{
        const el = getConfigInputEl(key);
        if(!el) return;
        const coerced = coerceConfigValue(key, el.value);
        if(CONFIG_META[key]?.uppercase && el.value !== coerced){
          el.value = coerced;
        }
        values[key] = coerced;
      });
      return values;
    }

    function validateConfigValues(values){
      let blocked = false;
      ['share_bitlavadia_pct','share_nanisindhodi_pct'].forEach(key=>{
        const raw = values[key];
        if(!raw){
          setConfigHint(key, '', '');
          return;
        }
        const numVal = Number(raw);
        if(!Number.isFinite(numVal)){
          setConfigHint(key, 'Enter a valid number.', 'error');
          blocked = true;
          return;
        }
        if(numVal < 0 || numVal > 100){
          setConfigHint(key, 'Enter a value between 0 and 100.', 'error');
          blocked = true;
          return;
        }
        if(!hasAtMostTwoDecimals(numVal)){
          setConfigHint(key, 'Max two decimals recommended.', 'warn');
        }else{
          setConfigHint(key, '', '');
        }
      });
      const ifscVal = values.ifsc;
      if(ifscVal){
        let msg = '';
        let type = '';
        if(!/^[A-Z0-9]+$/.test(ifscVal)){
          msg = 'Use A–Z and digits only.';
          type = 'warn';
        }
        if(ifscVal.length !== 11){
          msg = msg ? `${msg} 11 characters expected.` : '11 characters expected.';
          type = 'warn';
        }
        setConfigHint('ifsc', msg, type);
      }else{
        setConfigHint('ifsc', '', '');
      }
      return { blocked };
    }

    function applyConfigToInputs(values, options={}){
      const onlyBlank = options.onlyBlank === true;
      CONFIG_INPUT_TARGETS.forEach(([key, inputId])=>{
        const el = $(inputId);
        if(!el) return;
        const next = coerceConfigValue(key, values[key]);
        if(onlyBlank){
          const current = typeof el.value === 'string' ? el.value.trim() : el.value;
          if(current) return;
        }
        if(el.type === 'number' || el.type === 'range'){
          el.value = next;
          if(next === '') delete el.dataset.value;
          else el.dataset.value = next;
        }else{
          el.value = next;
        }
      });
    }

    function initConfigurationPanel(){
      const details = document.getElementById('configMenu');
      if(!details || details.dataset.bound === '1') return;
      details.dataset.bound = '1';
      hydrateConfigForm(window.appConfig);
      validateConfigValues(window.appConfig);
      applyConfigToInputs(window.appConfig, { onlyBlank:true });
      const summary = document.getElementById('configMenuSummary');

      const focusFirstField = () => {
        const firstEl = getConfigInputEl(CONFIG_KEYS[0]);
        if(firstEl) firstEl.focus();
      };

      details.addEventListener('toggle', ()=>{
        if(details.open){
          requestAnimationFrame(focusFirstField);
        }
      });
      details.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape'){
          e.preventDefault();
          details.removeAttribute('open');
          summary?.focus();
        }
      });

      CONFIG_KEYS.forEach(key=>{
        const el = getConfigInputEl(key);
        if(!el || el.dataset.configBound === '1') return;
        el.dataset.configBound = '1';
        el.addEventListener('input', ()=>{
          const current = readConfigForm();
          validateConfigValues(current);
        });
      });

      function autoSyncConfigField(sourceKey, targetKey){
        if(sourceKey === targetKey) return;
        const srcEl = getConfigInputEl(sourceKey);
        const destEl = getConfigInputEl(targetKey);
        if(!srcEl || !destEl) return;
        const sync = () => {
          if(destEl.dataset.configManual === '1') return;
          destEl.value = srcEl.value;
        };
        srcEl.addEventListener('input', () => {
          if(destEl.dataset.configManual !== '1'){
            destEl.value = srcEl.value;
          }
        });
        destEl.addEventListener('input', () => {
          destEl.dataset.configManual = destEl.value && destEl.value !== srcEl.value ? '1' : '';
        });
        sync();
      }

      autoSyncConfigField('vendor_code','iom_vendor_code');
      autoSyncConfigField('vendor_name','iom_company_name');
      autoSyncConfigField('ips_samakhiali','iom_location');

      const defaultsBtn = $('configDefaults');
      defaultsBtn?.addEventListener('click', ()=>{
        hydrateConfigForm(CONFIG_DEFAULTS, { resetManual:true });
        ['vendor_code','vendor_name','ips_samakhiali'].forEach(key=>{
          const el = getConfigInputEl(key);
          if(el){
            el.dataset.configManual = '';
            el.dispatchEvent(new Event('input', { bubbles:true }));
          }
        });
        const currentValues = readConfigForm();
        validateConfigValues(currentValues);
        toast('Configuration restored to defaults. Click Apply to update inputs.', 'info');
      });

      const applyBtn = $('configApply');
      applyBtn?.addEventListener('click', ()=>{
        const values = readConfigForm();
        const result = validateConfigValues(values);
        if(result.blocked){
          toast('Fix configuration inputs before applying.', 'bad');
          return;
        }
        setAppConfig(values);
        applyConfigToInputs(window.appConfig);
        compute();
        toast('Configuration applied.', 'good');
      });

      const saveBtn = $('configSave');
      saveBtn?.addEventListener('click', ()=>{
        const values = readConfigForm();
        const result = validateConfigValues(values);
        if(result.blocked){
          toast('Fix configuration inputs before saving.', 'bad');
          return;
        }
        setAppConfig(values, { persist:true });
        toast('Configuration saved.', 'good');
      });

      const downloadBtn = $('configDownload');
      downloadBtn?.addEventListener('click', ()=>{
        const values = readConfigForm();
        const result = validateConfigValues(values);
        if(result.blocked){
          toast('Fix configuration inputs before downloading.', 'bad');
          return;
        }
        setAppConfig(values);
        const payload = buildConfigPayload(window.appConfig);
        try{
          const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'config.json';
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(()=>URL.revokeObjectURL(url), 1000);
          toast('Configuration downloaded.', 'good');
        }catch(err){
          console.error(err);
          toast('Download failed.', 'bad');
        }
      });

      const fileInput = $('configFileInput');
      const loadBtn = $('configLoad');
      loadBtn?.addEventListener('click', ()=>{
        fileInput?.click();
      });
      fileInput?.addEventListener('change', (event)=>{
        const file = event.target.files && event.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          try{
            const text = reader.result;
            const parsed = JSON.parse(text);
            if(!parsed || typeof parsed !== 'object'){
              throw new Error('Invalid configuration file.');
            }
            const normalized = normalizeConfigValues(parsed);
            const merged = { ...window.appConfig };
            Object.keys(normalized).forEach(key=>{
              merged[key] = normalized[key];
            });
            setAppConfig(merged, { persist:true });
            hydrateConfigForm(window.appConfig);
            validateConfigValues(window.appConfig);
            toast('Configuration loaded. Click Apply to update inputs.', 'good');
          }catch(err){
            console.error(err);
            toast('Could not load configuration.', 'bad');
          }finally{
            event.target.value = '';
          }
        };
        reader.onerror = ()=>{
          toast('Could not load configuration.', 'bad');
          event.target.value = '';
        };
        reader.readAsText(file);
      });

      const closeBtn = $('configClose');
      closeBtn?.addEventListener('click', ()=>{
        details.removeAttribute('open');
        summary?.focus();
      });
    }

    const storedConfigRaw = (()=>{ try{ return JSON.parse(localStorage.getItem(CONFIG_LS_KEY) || 'null'); }catch{ return null; } })();
    const initialConfig = normalizeConfigValues(storedConfigRaw);
    window.appConfig = { ...CONFIG_DEFAULTS, ...(window.appConfig && typeof window.appConfig === 'object' ? window.appConfig : {}), ...initialConfig };

    const EXTRA_BUCKET_KEYS = ['credits','final','debits'];
    const CDR_EXTRAS_KEY = 'cdr_extras_v1';
    const extrasState = {
      credits: [],
      final: [],
      debits: []
    };
    window.cdrExtras = extrasState;

    const makeExtraId = () => {
      try{
        if(typeof crypto !== 'undefined' && crypto.randomUUID){
          return crypto.randomUUID();
        }
      }catch(e){}
      return 'ex_' + Date.now().toString(16) + Math.random().toString(16).slice(2,8);
    };
    const toFiniteNumber = (value) => {
      const num = Number(value);
      return Number.isFinite(num) ? num : 0;
    };
    function normalizeExtrasArray(arr){
      if(!Array.isArray(arr)) return [];
      return arr.map(item=>{
        if(!item || typeof item !== 'object') return null;
        const id = typeof item.id === 'string' && item.id.trim() ? item.id.trim() : makeExtraId();
        const label = typeof item.label === 'string' ? item.label : '';
        const amount = toFiniteNumber(item.amount);
        const include = item.include !== false;
        return { id, label, amount, include };
      }).filter(Boolean);
    }
    function persistExtras(){
      const payload = {};
      EXTRA_BUCKET_KEYS.forEach(bucket=>{
        payload[bucket] = (extrasState[bucket] || []).map(item=>({
          id: item.id,
          label: item.label,
          amount: toFiniteNumber(item.amount),
          include: !!item.include
        }));
      });
      try{
        localStorage.setItem(CDR_EXTRAS_KEY, JSON.stringify(payload));
      }catch(err){
        console.warn('Could not persist extras:', err);
      }
    }
    function loadExtras(){
      let data = null;
      try{
        data = JSON.parse(localStorage.getItem(CDR_EXTRAS_KEY) || 'null');
      }catch(err){
        console.warn('Could not read extras:', err);
      }
      EXTRA_BUCKET_KEYS.forEach(bucket=>{
        const arr = data && Array.isArray(data[bucket]) ? normalizeExtrasArray(data[bucket]) : [];
        extrasState[bucket] = arr;
      });
      renderExtras();
    }
    const extrasSum = (bucket) => {
      const arr = extrasState[bucket] || [];
      return arr.reduce((sum, item)=>{
        if(!item || !item.include) return sum;
        const num = toFiniteNumber(item.amount);
        return sum + num;
      }, 0);
    };
    const snapshotExtras = (bucket) => {
      return (extrasState[bucket] || []).map(item=>({
        id: item.id,
        label: item.label,
        amount: toFiniteNumber(item.amount),
        include: !!item.include
      }));
    };

    const EXTRA_UI_CONFIG = {
      credits: {
        listId: 'creditsExtrasList',
        emptyId: 'creditsExtrasEmpty',
        panelId: 'creditsExtrasPanel',
        addId: 'creditsExtrasAdd',
        labelAria: 'Credits extra label',
        amountAria: 'Credits extra amount',
        includeAria: 'Include credits extra',
        removeAria: 'Remove credits extra'
      },
      final: {
        listId: 'finalExtrasList',
        emptyId: 'finalExtrasEmpty',
        panelId: 'finalExtrasPanel',
        addId: 'finalExtrasAdd',
        labelAria: 'Final adjustment extra label',
        amountAria: 'Final adjustment extra amount',
        includeAria: 'Include final adjustment extra',
        removeAria: 'Remove final adjustment extra'
      },
      debits: {
        listId: 'debitsExtrasList',
        emptyId: 'debitsExtrasEmpty',
        panelId: 'debitsExtrasPanel',
        addId: 'debitsExtrasAdd',
        labelAria: 'Debits extra label',
        amountAria: 'Debits extra amount',
        includeAria: 'Include debits extra',
        removeAria: 'Remove debits extra'
      }
    };

    function refreshExtrasOutputs(){
      const container = document.querySelector('.final-breakdown');
      if(!container) return;
      container.querySelectorAll('.item[data-extra-bucket="final"]').forEach(el=>el.remove());
      const extras = snapshotExtras('final').filter(item=>item.include);
      if(!extras.length) return;
      const anchor = $('FINAL_C24v')?.closest('.item');
      const parent = anchor?.parentElement || container;
      let ref = anchor;
      extras.forEach(extra=>{
        const itemEl = document.createElement('div');
        itemEl.className = 'item';
        itemEl.dataset.extraBucket = 'final';
        itemEl.dataset.extraId = extra.id;

        const labelEl = document.createElement('div');
        labelEl.className = 'label';
        const labelText = (extra.label && extra.label.trim()) ? extra.label.trim() : 'Final adjustment extra';
        labelEl.textContent = labelText;
        const tag = document.createElement('span');
        tag.className = 'mono';
        tag.textContent = 'extra';
        labelEl.appendChild(document.createTextNode(' '));
        labelEl.appendChild(tag);

        const valueEl = document.createElement('div');
        const amt = toFiniteNumber(extra.amount);
        const abs = Math.abs(amt);
        let cls = 'base';
        let text = toInr(amt);
        if(abs > 0.004){
          if(amt >= 0){
            cls = 'minus';
            text = '−\u00A0' + toInr(abs);
          }else{
            cls = 'plus';
            text = '+\u00A0' + toInr(abs);
          }
        }
        valueEl.className = `value ${cls}`;
        valueEl.textContent = text;

        itemEl.appendChild(labelEl);
        itemEl.appendChild(valueEl);

        if(ref && ref.parentElement){
          ref.insertAdjacentElement('afterend', itemEl);
        }else{
          parent.appendChild(itemEl);
        }
        ref = itemEl;
      });
    }

    function buildExtraRow(bucket, item){
      const config = EXTRA_UI_CONFIG[bucket];
      const row = document.createElement('div');
      row.className = 'extras-row';
      row.dataset.extraId = item.id;

      const labelInput = document.createElement('input');
      labelInput.type = 'text';
      labelInput.className = 'extras-label';
      labelInput.value = item.label || '';
      labelInput.placeholder = 'Label';
      labelInput.setAttribute('aria-label', config.labelAria);
      labelInput.addEventListener('input', ()=>{
        item.label = labelInput.value;
        persistExtrasDebounced();
        refreshExtrasOutputs();
      });

      const amountInput = document.createElement('input');
      amountInput.type = 'text';
      amountInput.inputMode = 'decimal';
      amountInput.className = 'extras-amount';
      amountInput.setAttribute('aria-label', config.amountAria);
      amountInput.dataset.value = toFiniteNumber(item.amount);
      const hasValue = item.amount || item.amount === 0;
      amountInput.value = hasValue ? toInr(toFiniteNumber(item.amount)) : '';
      amountInput.addEventListener('input', ()=>{
        parseInrInput(amountInput, false);
        item.amount = toFiniteNumber(amountInput.dataset.value);
        persistExtrasDebounced();
        refreshExtrasOutputs();
        compute();
      });
      amountInput.addEventListener('blur', ()=>parseInrInput(amountInput));

      const includeWrap = document.createElement('div');
      includeWrap.className = 'extras-include';
      const includeInput = document.createElement('input');
      includeInput.type = 'checkbox';
      includeInput.checked = item.include !== false;
      includeInput.setAttribute('aria-label', config.includeAria);
      includeInput.addEventListener('change', ()=>{
        item.include = includeInput.checked;
        persistExtrasDebounced();
        refreshExtrasOutputs();
        compute();
      });
      const includeLabel = document.createElement('span');
      includeLabel.textContent = 'Include';
      includeWrap.appendChild(includeInput);
      includeWrap.appendChild(includeLabel);

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'ghost extras-remove';
      removeBtn.textContent = 'Remove';
      removeBtn.setAttribute('aria-label', config.removeAria);
      removeBtn.addEventListener('click', ()=>{
        extrasState[bucket] = (extrasState[bucket] || []).filter(x=>x.id !== item.id);
        persistExtras();
        renderExtrasPanel(bucket);
        refreshExtrasOutputs();
        compute();
      });

      row.appendChild(labelInput);
      row.appendChild(amountInput);
      row.appendChild(includeWrap);
      row.appendChild(removeBtn);
      return row;
    }

    function renderExtrasPanel(bucket){
      const config = EXTRA_UI_CONFIG[bucket];
      const listEl = $(config.listId);
      const emptyEl = $(config.emptyId);
      const addBtn = $(config.addId);
      if(addBtn && !addBtn.dataset.bound){
        addBtn.dataset.bound = '1';
        addBtn.addEventListener('click', ()=>{
          const newItem = { id: makeExtraId(), label:'', amount:0, include:true };
          extrasState[bucket] = [...(extrasState[bucket] || []), newItem];
          persistExtras();
          renderExtrasPanel(bucket);
          const panelEl = $(config.panelId);
          if(panelEl) panelEl.open = true;
          refreshExtrasOutputs();
          compute();
          requestAnimationFrame(()=>{
            const focusEl = document.querySelector(`[data-extra-id=\"${newItem.id}\"] .extras-label`);
            focusEl?.focus();
          });
        });
      }
      if(!listEl) return;
      const items = extrasState[bucket] || [];
      listEl.innerHTML = '';
      if(emptyEl) emptyEl.style.display = items.length ? 'none' : 'block';
      items.forEach(item=>{
        const row = buildExtraRow(bucket, item);
        listEl.appendChild(row);
      });
      const panel = $(config.panelId);
      if(panel){
        if(items.length === 0 && panel.hasAttribute('open')){
          panel.removeAttribute('open');
        }
        panel.dataset.count = String(items.length);
      }
    }

    function renderExtras(){
      EXTRA_BUCKET_KEYS.forEach(renderExtrasPanel);
      refreshExtrasOutputs();
    }

    const $ = id => document.getElementById(id);
    const num = id => {
      const el = $(id);
      return parseFloat(el.dataset.value || el.value || 0) || 0;
    };
    const roundUp0 = x => Math.ceil(x);
    const round2 = x => Math.round(x * 100) / 100;
    const hasAtMostTwoDecimals = v => Math.abs(Math.round(v * 100) - v * 100) < 1e-6;

    // Final reconciliation tolerance (INR); hoisted for clarity & micro-perf.
    // Stability guard: updated per business requirement from &#8377;0.05 &rarr; &#8377;50.00.
    const FINAL_CHECK_TOL = 50;

    const SERVICE_LIST = [
      { code:'FIXED_METER_RENT', name:'Fixed Meter Rent' },
      { code:'MD_SLAB1', name:'MD Slab 1' },
      { code:'MD_SLAB2', name:'MD Slab 2' },
      { code:'MD_SLAB3', name:'MD Slab 3' },
      { code:'PENAL_ABOVE_CD', name:'Penal Above CD' },
      { code:'EC_SLAB1', name:'Energy Charge Slab 1' },
      { code:'FCA', name:'FCA' },
      { code:'TOD_PEAK', name:'TOD Peak' },
      { code:'TOD_NIGHT_REBATE', name:'TOD Night Rebate' },
      { code:'PF_CHARGE_SLAB1', name:'PF Charge Slab 1' },
      { code:'TOU_DISC', name:'TOU Disc' },
      { code:'ARREAR_FCA', name:'Arrear FCA (legacy)', hidden:true },
      { code:'ARREAR_ED', name:'Arrear ED' },
      { code:'ARREAR_CESS', name:'Arrear Cess' },
      { code:'ARREAR_PF', name:'Arrear PF' },
      { code:'ARREAR_ENERGY', name:'Arrear Energy' },
      { code:'WIND_ENERGY_CREDIT', name:'Wind Energy Credit' }
    ];
    const SERVICE_HINTS = {
      EC_SLAB1: 'KWh billed.',
      TOD_PEAK: 'Hint: from &ldquo;TOU&rdquo; (HT Bill &rarr; H4)',
      TOD_NIGHT_REBATE: 'Qty auto = EC_SLAB1 Amt (D)',
      TOU_DISC: 'Qty auto = Time DISC Charges ÷ tariff',
      PF_CHARGE_SLAB1: 'Qty auto = EC_SLAB1 Amt (D); PF rate acts as a multiplier (credit)',
      ARREAR_ED: 'Hint: Enter Consumption Charges (base for ED)'
    };
    const QTY_PLACEHOLDERS = {
      PF_CHARGE_SLAB1: 'Auto: EC_SLAB1 Amt (D)',
      EC_SLAB1: 'KWh billed.',
      TOD_PEAK: 'kWh @ TOU (peak)',
      TOD_NIGHT_REBATE: 'Auto: EC_SLAB1 Amt (D)',
      TOU_DISC: 'Auto: Time DISC ÷ tariff',
      ARREAR_ED: 'Consumption Charges (&#8377;)'
    };
    const SERVICE_CODES = SERVICE_LIST.map(s=>s.code);
    const PERCENT_FIELDS = new Set(['PF_CHARGE_SLAB1','TOD_NIGHT_REBATE']);
    const PERCENT_PATTERN = /^\d{1,3}(\.\d{0,2})?$/;

    const DEFAULT_TARIFFS = {
      FIXED_METER_RENT:0,
      MD_SLAB1:150,
      MD_SLAB2:260,
      MD_SLAB3:475,
      PENAL_ABOVE_CD:0,
      EC_SLAB1:4.2,
      FCA:2.45,
      TOD_PEAK:0.85,
      TOD_NIGHT_REBATE:1.5,
      PF_CHARGE_SLAB1:2.35,
      TOU_DISC:0.6,
      ARREAR_FCA:1,
      ARREAR_ED:0.2,
      ARREAR_CESS:1,
      ARREAR_PF:1,
      ARREAR_ENERGY:1,
      WIND_ENERGY_CREDIT:0
    };

    const DEFAULT_PO_RATES = {
      FIXED_METER_RENT:750,
      MD_SLAB1:150,
      MD_SLAB2:260,
      MD_SLAB3:475,
      PENAL_ABOVE_CD:370,
      EC_SLAB1:4.2,
      FCA:1.81,
      TOD_PEAK:0.85,
      TOD_NIGHT_REBATE:0.43,
      PF_CHARGE_SLAB1:0.02,
      TOU_DISC:0,
      ARREAR_FCA:1,
      ARREAR_ED:1,
      ARREAR_CESS:1,
      ARREAR_PF:1,
      ARREAR_ENERGY:1,
      WIND_ENERGY_CREDIT:-1
    };

    let tariffs = { version:1, meta:{supplier:'PGVCL',currency:'INR',units:{}}, effective:'', rates:{...DEFAULT_TARIFFS} };
    let poRates = { version:1, meta:{po_number:'',currency:'INR'}, rates:{...DEFAULT_PO_RATES} };
    let sesRows = [];
    const rateErrors = new Map();

    function sanitizeRates(obj, defaults, opts){
      const percentAware = typeof opts === 'boolean' ? opts : opts?.percentAware !== false;
      obj = obj || {};
      obj.meta = obj.meta || {};
      obj.meta.units = obj.meta.units || {};
      if(percentAware){
        PERCENT_FIELDS.forEach(code=>{ obj.meta.units[code] = 'percent'; });
      }
      obj.rates = obj.rates || {};
      const unknown = Object.keys(obj.rates).filter(k=>!SERVICE_CODES.includes(k));
      if(unknown.length) toast(`Unknown service codes: ${unknown.join(', ')}`, 'warn');
      unknown.forEach(k=>delete obj.rates[k]);
      SERVICE_CODES.forEach(code=>{
        let value = obj.rates.hasOwnProperty(code) ? obj.rates[code] : defaults[code] ?? 0;
        value = parseFloat(value);
        if(percentAware && PERCENT_FIELDS.has(code)){
          if(Number.isFinite(value) && value > 0 && value <= 1){
            value = value * 100;
            console.info(`[migration] converted ${code} from decimal to percent`);
          }
          if(!Number.isFinite(value)) value = defaults[code] ?? 0;
          value = Math.max(0, Math.min(100, value));
          value = Math.round(value * 100) / 100;
        }else{
          if(!Number.isFinite(value)) value = defaults[code] ?? 0;
        }
        obj.rates[code] = value;
      });
      return obj;
    }

    function percentValueValid(v){
      return Number.isFinite(v) && v >= 0 && v <= 100 && hasAtMostTwoDecimals(v);
    }

    function setRateError(code, msg){
      const input = $('tar_'+code);
      const hint = $('hint_tar_'+code);
      const cell = input?.closest('.rate-cell');
      if(msg){
        if(input) input.classList.add('invalid');
        if(hint){ hint.textContent = msg; hint.style.display = 'block'; }
        rateErrors.set(code, msg);
      }else{
        if(input) input.classList.remove('invalid');
        if(hint){ hint.textContent = ''; hint.style.display = 'none'; }
        rateErrors.delete(code);
      }
      if(cell) cell.classList.toggle('has-error', !!msg);
      updateSaveButtonState();
    }

    function updateSaveButtonState(){
      const btn = $('saveRates');
      if(!btn) return;
      btn.toggleAttribute('disabled', rateErrors.size > 0);
    }

    function percentPreview(value){
      const applied = (value/100).toFixed(6).replace(/0+$/, '').replace(/\.$/, '');
      return `Applied as ${applied || '0'} in formulas`;
    }

    function updatePercentPreview(code){
      const preview = $('preview_tar_'+code);
      const input = $('tar_'+code);
      const cell = input?.closest('.rate-cell');
      if(!preview || !input) return;
      const val = parseFloat(input.value);
      if(Number.isFinite(val)){
        preview.textContent = percentPreview(val);
        preview.style.display = '';
      }else{
        preview.textContent = '';
        preview.style.display = 'none';
      }
      if(cell){
        cell.classList.toggle('editing', !input.disabled);
      }
    }

    function enforcePercentInput(code){
      const input = $('tar_'+code);
      if(!input) return;
      input.dataset.prev = input.value;
      input.addEventListener('input', ()=>{
        const { value } = input;
        if(value === ''){
          setRateError(code, 'Required.');
          input.dataset.prev = '';
          updatePercentPreview(code);
          return;
        }
        if(/e/i.test(value) || value.startsWith('-') || !PERCENT_PATTERN.test(value)){
          input.value = input.dataset.prev || '';
          return;
        }
        const numVal = parseFloat(value);
        if(!Number.isFinite(numVal) || numVal > 100){
          input.value = input.dataset.prev || '';
          return;
        }
        input.dataset.prev = value;
        if(percentValueValid(numVal)){
          setRateError(code, '');
        }else{
          setRateError(code, 'Max 2 decimals.');
        }
        updatePercentPreview(code);
      });
      input.addEventListener('blur', ()=>{
        const val = parseFloat(input.value);
        if(!percentValueValid(val)){
          if(input.value===''){
            setRateError(code, 'Required.');
          }else{
            setRateError(code, '0–100 with max 2 decimals.');
          }
        }else{
          setRateError(code, '');
          input.value = val.toFixed(2);
        }
        updatePercentPreview(code);
        computeSes();
      });
      updatePercentPreview(code);
    }

    function loadRates(){
      let t=null,p=null;
      try{ t = JSON.parse(localStorage.getItem('tariffs.v1')); }catch{}
      try{ p = JSON.parse(localStorage.getItem('po_rates.v1')); }catch{}
      if(!t) toast('Tariff defaults loaded; Save to persist.', 'info');
      if(!p) toast('PO rate defaults loaded; Save to persist.', 'info');
      tariffs = sanitizeRates(t || tariffs, DEFAULT_TARIFFS);
      poRates = sanitizeRates(p || poRates, DEFAULT_PO_RATES, false);
    }

    function updateRatesFromInputs(){
      SERVICE_LIST.forEach(s=>{
        const tEl=$('tar_'+s.code);
        if(tEl){
          const val=parseFloat(tEl.value);
          if(PERCENT_FIELDS.has(s.code)){
            if(percentValueValid(val)) tariffs.rates[s.code]=Math.round(val*100)/100;
          }else{
            tariffs.rates[s.code]=Number.isFinite(val)?val:0;
          }
        }
        const pEl=$('po_'+s.code); if(pEl) poRates.rates[s.code]=parseFloat(pEl.value)||0;
      });
    }

    function renderRatesTable(){
      const body=$('ratesBody'); if(!body) return;
      rateErrors.clear();
      body.innerHTML='';
      SERVICE_LIST.forEach(s=>{
      const tr=document.createElement('tr');
      const qtyAttrs = 'step="0.01"';
      const qtyDis = s.code==='FCA' ? 'disabled' : '';
      const hint = SERVICE_HINTS[s.code];
      const hintHtml = hint ? `<div class="muted" style="font-size:11px">${hint}</div>` : '';
        const ph = QTY_PLACEHOLDERS[s.code] ? `placeholder="${QTY_PLACEHOLDERS[s.code]}"` : '';
        const percent = PERCENT_FIELDS.has(s.code);
        const infoTip = percent ? `<span class="info-tip" role="img" tabindex="0" aria-label="Enter percent (0–100). Example: 2.35" title="Enter percent (0–100). Example: 2.35">&#9432;</span>` : '';
        const tariffInput = percent
          ? `<div class="rate-cell"><div class="rate-input percent"><input type="number" min="0" max="100" step="0.01" inputmode="decimal" pattern="^\\d{1,3}(\\.\\d{0,2})?$" id="tar_${s.code}" disabled/><span class="suffix">%</span></div><div class="rate-preview muted" id="preview_tar_${s.code}"></div><div class="hint rate-hint" id="hint_tar_${s.code}"></div></div>`
          : `<input type="number" step="0.000001" id="tar_${s.code}" disabled/>`;
        tr.innerHTML=`
          <td><span class="mono">${s.code}</span>${infoTip}<div class="muted">${s.name}</div>${hintHtml}</td>
          <td class="num"><input type="number" ${qtyAttrs} id="qty_${s.code}" ${qtyDis} ${ph}/></td>
          <td class="num">${tariffInput}</td>
          <td class="num"><span id="d_${s.code}" class="muted">${EM_DASH}</span></td>
          <td class="num"><input type="number" step="0.000001" id="po_${s.code}" disabled/></td>
          <td class="num"><span id="f_${s.code}" class="muted">${EM_DASH}</span></td>
          <td class="num"><span id="g_${s.code}" class="muted">${EM_DASH}</span></td>`;
        if(s.hidden){
          tr.hidden = true;
          tr.dataset.legacy = '1';
        }
        body.appendChild(tr);
      });
      SERVICE_LIST.forEach(s=>{
        const tarInput = $('tar_'+s.code);
        if(tarInput){
          const value = tariffs.rates[s.code];
          if(PERCENT_FIELDS.has(s.code)){
            const parsed = Number(value);
            const safe = Number.isFinite(parsed) ? parsed : 0;
            tarInput.value = safe.toFixed(2);
          }else{
            tarInput.value = value;
          }
        }
        $('po_'+s.code).value = poRates.rates[s.code];
        if(PERCENT_FIELDS.has(s.code)){
          enforcePercentInput(s.code);
          updatePercentPreview(s.code);
          setRateError(s.code, percentValueValid(tariffs.rates[s.code]) ? '' : 'Required.');
        }
      });
      body.querySelectorAll('input').forEach(el=>el.addEventListener('input', compute));
      computeSes();
      updateSaveButtonState();
    }

    function toggleEditRates(){
      const editing = $('tar_'+SERVICE_CODES[0])?.disabled;
      SERVICE_LIST.forEach(s=>{
        const tarInput = $('tar_'+s.code);
        tarInput?.toggleAttribute('disabled', !editing);
        $('po_'+s.code)?.toggleAttribute('disabled', !editing);
        if(PERCENT_FIELDS.has(s.code) && tarInput){
          updatePercentPreview(s.code);
        }
      });
      const btn=$('editRates'); if(btn) btn.textContent = editing ? 'Done' : 'Edit Rates';
    }

    function validatePercentRates(){
      for(const code of PERCENT_FIELDS){
        const input = $('tar_'+code);
        const val = parseFloat(input?.value);
        if(!percentValueValid(val)){
          toast(`${code} must be a percent between 0 and 100 (max 2 decimals).`, 'warn');
          input?.focus();
          return false;
        }
      }
      return true;
    }

    function saveRates(){
      if(!$('ratesCard')) return;
      if(rateErrors.size){
        toast('Resolve validation errors before saving.', 'warn');
        return;
      }
      if(!validatePercentRates()) return;
      updateRatesFromInputs();
      tariffs.effective = monthLabel();
      tariffs.meta = tariffs.meta || {};
      tariffs.meta.units = tariffs.meta.units || {};
      PERCENT_FIELDS.forEach(code=>{ tariffs.meta.units[code] = 'percent'; });
      for(const code of PERCENT_FIELDS){
        const value = tariffs.rates[code];
        if(!percentValueValid(value)){
          toast(`${code} must be a percent between 0 and 100 (max 2 decimals).`, 'warn');
          return;
        }
      }
      localStorage.setItem('tariffs.v1', JSON.stringify(tariffs));
      localStorage.setItem('po_rates.v1', JSON.stringify(poRates));
      downloadJson(tariffs,'tariffs.json');
      downloadJson(poRates,'po_rates.json');
      toast('Rates saved.', 'good');
      compute();
    }

    function handleImport(ev){
      const files=ev.target.files; if(!files) return;
      Array.from(files).forEach(file=>{
        const reader=new FileReader();
        reader.onload=()=>{
          try{
            const data=JSON.parse(reader.result);
            if(data.meta && data.meta.supplier){
              tariffs = sanitizeRates(data, DEFAULT_TARIFFS);
              toast('Tariffs loaded.', 'good');
            }else if(data.meta && 'po_number' in data.meta){
              poRates = sanitizeRates(data, DEFAULT_PO_RATES);
              toast('PO rates loaded.', 'good');
            }else{
              toast('Unknown rates file.', 'warn');
            }
            renderRatesTable();
          }catch{ toast('Malformed JSON.', 'warn'); }
        };
        reader.readAsText(file);
      });
      ev.target.value='';
    }

    function downloadJson(obj,name){
      const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=name;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},1000);
    }

    function exportCsv(){
      computeSes();
      if(!sesRows.length){ toast('No data for CSV.', 'warn'); return; }
      const note=monthLabel();
      const lines=['ServiceCode,ServiceName,UnitAdjusted,ContractRate,AmountSES,TariffValue,TariffUnit,Note'];
      sesRows.forEach(r=>{
        if(Math.abs(r.ses)<=0.004) return;
        const qty=r.adj.toFixed(2);
        const tariffVal = Number.isFinite(r.tariff) ? (r.unit==='percent' ? r.tariff.toFixed(2) : r.tariff.toFixed(6)) : '';
        lines.push(`${r.code},${r.name},${qty},${r.rate.toFixed(2)},${r.ses.toFixed(2)},${tariffVal},${r.unit},${note}`);
      });
      const csv=lines.join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=`SES_${note}.csv`;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},1000);
    }

    function computeSes(){
      const body=$('ratesBody'); if(!body) return;
      sesRows=[];
      let totalD=0,totalG=0,dEnergy=0;
      SERVICE_LIST.forEach(s=>{
        const qtyEl=$('qty_'+s.code);
        const tarEl=$('tar_'+s.code);
        const poEl=$('po_'+s.code);
        const dEl=$('d_'+s.code);
        const fEl=$('f_'+s.code);
        const gEl=$('g_'+s.code);
        const C=parseFloat(tarEl?.value)||0;
        const E=parseFloat(poEl?.value)||0;
        let B=parseFloat(qtyEl?.value)||0;
        switch(s.code){
          case 'MD_SLAB1':
          case 'MD_SLAB2':
            B=500; break;
          case 'MD_SLAB3':{
            const demand=num('B4');
            const t1=parseFloat($('tar_MD_SLAB1')?.value)||0;
            const t2=parseFloat($('tar_MD_SLAB2')?.value)||0;
            if(C){
              B=round2((demand - 500*t1 - 500*t2)/C);
            }else{
              B=0;
            }
            break;
          }
          case 'EC_SLAB1':
            B=num('A4'); break;
          case 'TOD_PEAK':{
            const tou=num('H4'); B=C?round2(tou/C):0; break; }
          case 'TOD_NIGHT_REBATE':{
            const dTxt = $('d_EC_SLAB1')?.textContent || '';
            const dVal = parseFloat(String(dTxt).replace(/[^0-9.\-]/g,'')) || 0;
            B = dVal; break; }
          case 'PF_CHARGE_SLAB1':{
            const dTxt = $('d_EC_SLAB1')?.textContent || '';
            const dVal = parseFloat(String(dTxt).replace(/[^0-9.\-]/g,'')) || 0;
            B = dVal; break; }
          case 'TOU_DISC':{
            const disc = num('J4');
            B = C ? round2(disc / C) : 0;
            break;
          }
          case 'ARREAR_ED':{
            const tot=num('B4')+num('C4')-num('D4')+num('E4')-num('F4')-num('G4')+num('H4')+num('J4')+num('I4');
            B=round2(tot); break; }
          case 'FCA':
            B=parseFloat($('qty_EC_SLAB1')?.value)||0; break;
        }
        if(qtyEl) qtyEl.value = Number.isInteger(B) ? B : B.toFixed(2);
        let D=0,F=0,G=0;
        const isPercent = PERCENT_FIELDS.has(s.code);
        if(s.code.startsWith('ARREAR_')){
          D=B*C;
          F=D;
        }else if(isPercent){
          const applied = (C||0)/100;
          D = -Math.abs(B * applied);
          F=E?D/E:0;
        }else{
          D=B*C;
          F=E?D/E:0;
        }
        if(s.code==='EC_SLAB1') dEnergy=D;
        G=(s.code==='WIND_ENERGY_CREDIT'||s.code.startsWith('ARREAR_'))?D:E*F;
        totalD+=D; totalG+=G;
        sesRows.push({code:s.code,name:s.name,qty:B,amt:D,adj:F,rate:E,ses:G,tariff:C,unit:isPercent?'percent':'number'});
        if(dEl){
          dEl.textContent = Math.abs(D)<0.005 ? EM_DASH : INR.format(D);
          dEl.classList.toggle('bad', D < -0.004);
          dEl.classList.toggle('good', D > 0.004);
          dEl.classList.toggle('muted', Math.abs(D) <= 0.004);
        }
        if(fEl){const prec=2; fEl.textContent=Math.abs(F)<0.005?EM_DASH:F.toFixed(prec);}
        if(gEl){
          gEl.textContent = Math.abs(G)<0.005 ? EM_DASH : INR.format(G);
          gEl.classList.toggle('bad', G < -0.004);
          gEl.classList.toggle('good', G > 0.004);
          gEl.classList.toggle('muted', Math.abs(G) <= 0.004);
        }
      });
      const badge=$('parityBadge');
      if(badge){
        // Prefer authoritative C9 = A9 + B9; fallback to C9v if A9/B9 not present
        const parseMoney = (t)=> Number(String(t||'').replace(/[^0-9.\-]/g,'')) || 0;
        const a9El = $('A9v');
        const b9El = $('B9v');
        const haveAB = !!(a9El && b9El);
        const c9FromAB = haveAB ? (parseMoney(a9El.textContent) + parseMoney(b9El.textContent)) : 0;
        const c9Fallback = parseMoney($('C9v')?.textContent);
        const c9 = haveAB ? c9FromAB : c9Fallback;

        const delta=totalG-totalD;
        const deltaC9=totalD-c9;
        badge.textContent=`ΣD ${INR.format(totalD)} | ΣG ${INR.format(totalG)} | Δ ${INR.format(delta)} | vs C9 ${INR.format(deltaC9)}`;
        badge.classList.remove('good','bad');
        badge.classList.add(Math.abs(delta)<=FINAL_CHECK_TOL && Math.abs(deltaC9)<=FINAL_CHECK_TOL ? 'good' : 'bad');
      }
    }

    function initRatesManager(){
      if(!$('ratesCard')) return;
      loadRates();
      renderRatesTable();
      $('importRates')?.addEventListener('click', ()=>$('ratesFile')?.click());
      $('ratesFile')?.addEventListener('change', handleImport);
      $('downloadTariffs')?.addEventListener('click', ()=>{updateRatesFromInputs();downloadJson(tariffs,'tariffs.json');});
      $('downloadPoRates')?.addEventListener('click', ()=>{updateRatesFromInputs();downloadJson(poRates,'po_rates.json');});
      $('editRates')?.addEventListener('click', toggleEditRates);
      $('saveRates')?.addEventListener('click', saveRates);
      $('exportCsv')?.addEventListener('click', exportCsv);
    }

    const toInr = v => INR.format(Number.isFinite(v) ? v : 0);
      const toRate = v => RATE.format(Number.isFinite(v) ? v : 0) + ' /kWh';
    function showSciHint(el){
      const hint = el.nextElementSibling;
      if(hint && hint.classList.contains('hint')){
        hint.textContent = 'Scientific notation not allowed.';
        hint.style.display = 'block';
        el.classList.add('invalid');
      }
    }
    function parseInrInput(el, format=true){
      if(/e/i.test(el.value)){
        showSciHint(el);
        el.dataset.sci = '1';
        el.value = el.value.replace(/e/ig,'');
      }else{
        delete el.dataset.sci;
        const hint = el.nextElementSibling;
        if(hint && hint.classList.contains('hint')){
          hint.textContent='';
          hint.style.display='none';
          el.classList.remove('invalid');
        }
      }
      const raw = el.value.replace(/[^0-9.\-]/g,'');
      const v = parseFloat(raw);
      if(Number.isFinite(v)){
        el.dataset.value = v;
        if(format) el.value = toInr(v);
      }else{
        el.dataset.value = '';
        if(format) el.value = '';
      }
    }

    const debounce = (fn, delay=200) => {
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); };
    };

    const persistExtrasDebounced = debounce(persistExtras, 200);

    function confirmModal(msg){
      return new Promise(resolve=>{
        const m = $('modal');
        const okBtn = $('modalOk');
        const cancelBtn = $('modalCancel');
        const prev = document.activeElement;
        $('modalText').textContent = msg;
        m.style.display = 'flex';
        okBtn.focus();
        const ok = ()=>{ cleanup(); resolve(true); };
        const cancel = ()=>{ cleanup(); resolve(false); };
        const esc = e=>{ if(e.key==='Escape') cancel(); };
        const backdrop = e=>{ if(e.target===m) cancel(); };
        function cleanup(){
          okBtn.removeEventListener('click', ok);
          cancelBtn.removeEventListener('click', cancel);
          document.removeEventListener('keydown', esc);
          m.removeEventListener('click', backdrop);
          m.style.display = 'none';
          if(prev) prev.focus();
        }
        okBtn.addEventListener('click', ok, { once:true });
        cancelBtn.addEventListener('click', cancel, { once:true });
        document.addEventListener('keydown', esc);
        m.addEventListener('click', backdrop);
      });
    }

    function validate(){
      let ok = true;
      const percentIds = ['B15','D15','C16'];
      const negativeOkIds = ['G9','J4'];
      document.querySelectorAll('input').forEach(el=>{
        if(el.type==='month' || el.type==='file') return;
        const hint = el.nextElementSibling;
        if(!hint || !hint.classList.contains('hint')) return;
        hint.textContent=''; hint.style.display='none';
        el.classList.remove('invalid');

        const raw = el.dataset.value ?? el.value;
        if (el.dataset.sci === '1' || /e/i.test(String(raw))) {
          hint.textContent='Scientific notation not allowed.'; hint.style.display='block'; el.classList.add('invalid'); ok = false; return;
        }
        const val = parseFloat(raw);
        if (!Number.isFinite(val)) return; // allow empty/unfilled during typing

        if (percentIds.includes(el.id)) {
          if (val < 0 || val > 100) { hint.textContent='0&ndash;100 only.'; hint.style.display='block'; el.classList.add('invalid'); ok = false; }
        } else if (!negativeOkIds.includes(el.id) && val < 0) {
          hint.textContent='&ge; 0 only.'; hint.style.display='block'; el.classList.add('invalid'); ok = false;
        }
      });
      return ok;
    }

    function compute(strict=false){
      const ok = validate();
      // HT Bill
      const A4=num('A4'), B4=num('B4'), C4=num('C4'), D4=num('D4'), E4=num('E4'), F4=num('F4'), G4=num('G4'), H4=num('H4'), I4=num('I4'), J4=num('J4');
      const A9 = B4 + C4 - D4 + E4 - F4 - G4 + H4 + J4 + I4;
      const B9 = A9 * 0.2;
      const C9 = A9 + B9;
      $('A9v').textContent = toInr(A9);
      $('B9v').textContent = toInr(B9);
      $('C9v').textContent = toInr(C9);

      // Adjustments
      const D9=num('D9'), E9=num('E9'), F9=num('F9'), G9=num('G9');
      const H9 = C9 + D9 + F9 + G9;
      const I9 = H9 - E9;
      const A31 = D9 - E9;
      $('H9v').textContent = toInr(H9);
      $('I9v').textContent = toInr(I9);
      $('A31v').textContent = toInr(A31);

      // WEG Inputs
      const B15=num('B15'), D15=num('D15'), C16=num('C16');
      const A17=num('A17'), B17=num('B17'), C17=num('C17'), D17=num('D17'), E17=num('E17');
      const bit_mwh = A17 + B17;
      const nan_mwh = C17 + D17 + E17;
      const A18 = roundUp0((bit_mwh)*1000*(B15/100)*(1-(C16/100)));
      const C18 = roundUp0((nan_mwh)*1000*(D15/100)*(1-(C16/100)));
      const A19 = A18 + C18;
      $('A18v').textContent = KWH.format(A18) + ' kWh';
      $('C18v').textContent = KWH.format(C18) + ' kWh';
      $('A19v').textContent = KWH.format(A19) + ' kWh';

      // Credits/Debits
      const A24=num('A24'), B24=num('B24'), C24=num('C24'), D24=num('D24'), E24=num('E24'), F24=num('F24');
      const creditsExtraTotal = extrasSum('credits');
      const debitsExtraTotal = extrasSum('debits');
      const finalExtrasTotal = extrasSum('final');
      const A26 = A24 + B24 + creditsExtraTotal;
      const B26 = D24 + E24 + F24 + debitsExtraTotal;
      const C26 = A26 - B26;
      $('A26v').textContent = toInr(A26);
      $('B26v').textContent = toInr(B26);
      $('C26v').textContent = toInr(C26);

      // Rates & Shares
      const B19 = (A19===0) ? 0 : (C26 / A19);
      const F16 = B19 * A18;
      const G16 = B19 * C18;
      $('B19v').textContent = toRate(B19);
      $('windRateWarn').style.display = (A19===0) ? 'block' : 'none';
      $('F16v').textContent = toInr(F16);
      $('G16v').textContent = toInr(G16);

      // Final Bill for IOM
      const FINAL = C9 - F16 - G16 - (C24 + finalExtrasTotal) + A31 + F9; // C9 &minus; F16 &minus; G16 &minus; Credit TDS (+ extras) + Balance Pending + Delay Charges
      $('FINALv').textContent = toInr(FINAL);
      const mappingText = finalExtrasTotal
        ? 'Mapping: Current Month Bill − Share(4.5MW) − Share(14.7MW) − Credit TDS − Final adj. extras + Balance Pending (prev) + Delay Charges'
        : 'Mapping: Current Month Bill − Share(4.5MW) − Share(14.7MW) − Credit TDS + Balance Pending (prev) + Delay Charges';
      document.querySelectorAll('.final-main .mapping').forEach(el=>{ el.textContent = mappingText; });
      const setFinalLine = (id, val, mode='base') => {
        const el = $(id);
        if (!el) return;
        const abs = Math.abs(val);
        const sign =
          mode === 'minus' ? (abs > 0.004 ? '−\u00A0' : '') :
          mode === 'plus'  ? (abs > 0.004 ? '+\u00A0' : '') : '';
        el.textContent = sign ? sign + toInr(abs) : toInr(val);
        el.classList.remove('minus','plus','base');
        if (mode === 'minus' && abs > 0.004) el.classList.add('minus');
        else if (mode === 'plus' && abs > 0.004) el.classList.add('plus');
        else el.classList.add('base');
      };
      setFinalLine('FINAL_C9v', C9, 'base');
      setFinalLine('FINAL_F16v', F16, 'minus');
      setFinalLine('FINAL_G16v', G16, 'minus');
      setFinalLine('FINAL_C24v', C24, 'minus');
      setFinalLine('FINAL_A31v', A31, 'plus');
      setFinalLine('FINAL_F9v', F9, 'plus');

      // Cross-check: I9 (= H9 &minus; E9) should reconcile with FINAL
      const I9_check = (Number(H9) || 0) - (Number(E9) || 0);
      const deltaFinal = I9_check - FINAL;
      const badge = $('finalCheckBadge');
      if (badge) {
        const i9Span = $('I9checkv'), finalSpan = $('FINALexpectedv'), dSpan = $('FINALdeltav');
        const statusSpan = $('FINALstatusv'), statusLabelSpan = $('FINALstatusLabel');
        const withinTol = Math.abs(deltaFinal) <= FINAL_CHECK_TOL;
        if (i9Span) i9Span.textContent = toInr(I9_check);
        if (finalSpan) finalSpan.textContent = toInr(FINAL);
        if (dSpan) {
          dSpan.textContent = toInr(deltaFinal);
          dSpan.classList.toggle('good', withinTol);
          dSpan.classList.toggle('bad', !withinTol);
        }
        // Visual state + symbol
        badge.classList.remove('good','bad');
        badge.classList.add(withinTol ? 'good' : 'bad');
        if (statusSpan) statusSpan.textContent = withinTol ? '✓' : '✕';
        if (statusLabelSpan) statusLabelSpan.textContent = withinTol ? 'Check' : 'Review';
        // Accessibility: narrate current status & values
        const a11y =
          `Final check: I9 ${toInr(I9_check)}, Final Bill for IOM ${toInr(FINAL)}, delta ${toInr(deltaFinal)}, `
          + (withinTol ? 'status OK' : 'status NOT OK');
        badge.setAttribute('aria-label', a11y);
        badge.title = a11y;
      }
      refreshExtrasOutputs();
      computeSes();
      persistDebounced();
      try { window.dispatchEvent(new CustomEvent('receipt:refresh')); } catch(_){ }
      return strict && !ok ? null : {
        A4,B4,C4,D4,E4,F4,G4,H4,I4,J4,
        A9,B9,C9,
        D9,E9,F9,G9,H9,I9,
        B15,D15,C16,
        A17,B17,C17,D17,E17,
        A18,C18,A19,
        A24,B24,C24,D24,E24,F24,
        A26,B26,C26,
        B19,F16,G16,
        A31,
        FINAL,
        I9_check,
        creditsExtrasTotal: creditsExtraTotal,
        debitsExtrasTotal: debitsExtraTotal,
        finalExtrasTotal,
        creditsExtras: snapshotExtras('credits'),
        debitsExtras: snapshotExtras('debits'),
        finalExtras: snapshotExtras('final')
      };
    }

    let formulaTooltipEl = null;
    let tooltipActiveField = null;
    let tooltipHideTimer = null;
    let tooltipMutationObserver = null;
    let tooltipRebindScheduled = false;
    const TOOLTIP_SELECTOR = '.output-field[data-formula]';

    function scheduleTooltipRebind(){
      if (tooltipRebindScheduled) return;
      const run = ()=>{
        tooltipRebindScheduled = false;
        bindOutputFieldTooltips();
      };
      tooltipRebindScheduled = true;
      if (typeof requestAnimationFrame === 'function') {
        requestAnimationFrame(run);
      } else {
        setTimeout(run, 16);
      }
    }

    function ensureTooltipObserver(){
      if (tooltipMutationObserver || typeof MutationObserver !== 'function' || !document.body) return;
      tooltipMutationObserver = new MutationObserver(mutations=>{
        for (const mutation of mutations) {
          if (!mutation.addedNodes || mutation.addedNodes.length === 0) continue;
          for (const node of mutation.addedNodes) {
            if (!node || node.nodeType !== 1) continue;
            const el = node;
            if (el.matches && el.matches(TOOLTIP_SELECTOR)) {
              scheduleTooltipRebind();
              return;
            }
            if (el.querySelector && el.querySelector(TOOLTIP_SELECTOR)) {
              scheduleTooltipRebind();
              return;
            }
          }
        }
      });
      tooltipMutationObserver.observe(document.body, { childList:true, subtree:true });
    }

    function ensureFormulaTooltip(){
      if (formulaTooltipEl) return formulaTooltipEl;
      const tip = document.createElement('div');
      tip.className = 'formula-tooltip';
      tip.id = 'formulaTooltip';
      tip.setAttribute('role','tooltip');
      tip.style.visibility = 'hidden';
      tip.style.left = '-1000px';
      tip.style.top = '-1000px';
      document.body.appendChild(tip);
      formulaTooltipEl = tip;
      return tip;
    }

    function isTooltipVisible(){
      return !!(formulaTooltipEl && formulaTooltipEl.classList.contains('visible'));
    }

    function positionFormulaTooltip(field){
      if (!formulaTooltipEl || !field) return;
      const rect = field.getBoundingClientRect();
      const gap = 10;
      const tip = formulaTooltipEl;
      const placementDefault = 'above';
      tip.dataset.placement = placementDefault;
      tip.style.visibility = 'hidden';
      const tipRect = tip.getBoundingClientRect();
      const viewportPadding = 8;
      let left = rect.left + rect.width / 2 - tipRect.width / 2;
      const maxLeft = window.innerWidth - tipRect.width - viewportPadding;
      if (maxLeft < viewportPadding) {
        left = viewportPadding;
      } else {
        left = Math.max(viewportPadding, Math.min(left, maxLeft));
      }
      let top = rect.top - tipRect.height - gap;
      let placement = placementDefault;
      if (top < 4) {
        placement = 'below';
        top = rect.bottom + gap;
      }
      tip.dataset.placement = placement;
      tip.style.left = `${left}px`;
      tip.style.top = `${top}px`;
      tip.style.visibility = 'visible';
    }

    function hideFormulaTooltip(immediate=false){
      if (!formulaTooltipEl) return;
      if (tooltipHideTimer) {
        clearTimeout(tooltipHideTimer);
        tooltipHideTimer = null;
      }
      const tip = formulaTooltipEl;
      const cleanup = () => {
        tip.classList.remove('visible');
        tip.style.visibility = 'hidden';
        tip.style.left = '-1000px';
        tip.style.top = '-1000px';
        tooltipHideTimer = null;
      };
      if (immediate) {
        cleanup();
      } else {
        tip.classList.remove('visible');
        tooltipHideTimer = setTimeout(cleanup, 110);
      }
      if (tooltipActiveField) {
        tooltipActiveField.removeAttribute('aria-describedby');
        tooltipActiveField = null;
      }
    }

    function showFormulaTooltip(field){
      if (!field || !field.dataset || !field.dataset.formula) return;
      const tip = ensureFormulaTooltip();
      if (tooltipHideTimer) {
        clearTimeout(tooltipHideTimer);
        tooltipHideTimer = null;
      }
      const formula = field.dataset.formula;
      tooltipActiveField = field;
      field.setAttribute('aria-describedby', tip.id);
      tip.textContent = formula;
      tip.classList.remove('visible');
      tip.style.visibility = 'hidden';
      positionFormulaTooltip(field);
      requestAnimationFrame(()=>{
        if (!formulaTooltipEl) return;
        tip.style.visibility = 'visible';
        tip.classList.add('visible');
        positionFormulaTooltip(field);
      });
    }

    function bindOutputFieldTooltips(){
      const fields = document.querySelectorAll('.output-field[data-formula]');
      fields.forEach(field=>{
        if (field.dataset.tooltipBound === '1') return;
        field.dataset.tooltipBound = '1';
        const onEnter = (ev)=>{
          if(ev.pointerType === 'touch') return;
          if(ev.target && ev.target !== field && !field.contains(ev.target)) return;
          const rel = ev.relatedTarget;
          if(rel && field.contains(rel)) return;
          showFormulaTooltip(field);
        };
        const onLeave = (ev)=>{
          if(ev.pointerType === 'touch') return;
          const rel = ev.relatedTarget;
          if(rel && field.contains(rel)) return;
          hideFormulaTooltip();
        };
        field.addEventListener('pointerover', onEnter);
        field.addEventListener('pointerout', onLeave);
        field.addEventListener('focus', ()=>showFormulaTooltip(field));
        field.addEventListener('blur', ()=>hideFormulaTooltip());
        field.addEventListener('keydown', (ev)=>{ if(ev.key === 'Escape'){ hideFormulaTooltip(true); }});
        field.addEventListener('pointerup', (ev)=>{
          if(ev.pointerType !== 'touch') return;
          if(tooltipActiveField === field && isTooltipVisible()){
            hideFormulaTooltip(true);
          }else{
            showFormulaTooltip(field);
          }
        });
      });
    }

    window.addEventListener('scroll', ()=>{
      if(tooltipActiveField && isTooltipVisible()){
        positionFormulaTooltip(tooltipActiveField);
      }
    }, { passive:true });

    window.addEventListener('resize', ()=>{
      if(tooltipActiveField && isTooltipVisible()){
        positionFormulaTooltip(tooltipActiveField);
      }
    });

    document.addEventListener('pointerdown', (ev)=>{
      if(!tooltipActiveField || !isTooltipVisible()) return;
      if(tooltipActiveField.contains(ev.target)) return;
      hideFormulaTooltip();
    }, true);

    function initFormulaTooltips(){
      bindOutputFieldTooltips();
      ensureTooltipObserver();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFormulaTooltips, { once:true });
    } else {
      initFormulaTooltips();
    }

    // Reuse formatters from existing code:
    const INR_FMT = new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR', maximumFractionDigits:2 });
    const asINR = v => Number.isFinite(+v) ? INR_FMT.format(+v) : (v ?? '');
    // DO NOT EDIT &mdash; Stability Guard:
    // Per stakeholder directive these identifiers never change and must NOT be read from inputs/models.
    const SAP_VENDOR_CODE = 'ZG0435';
    const SAP_BANKT = 'SBI1';

    function buildHtmlSections(model) {
      const order = [
        ['HT Bill','HT Bill (calc)'],
        ['Adjust','Adjust (calc)'],
        ['WEG','WEG (calc)'],
        ['Wind Credits','Wind Debits','Wind (calc)'],
        ['FINAL']
      ];
      const secs = {};
      const add = (s, field, cell, val, unit='') => {
        (secs[s] ||= []).push({ field, cell, val, unit });
      };

      // HT Bill
      add('HT Bill','Monthly Consumption','A4', model.A4,'kWh');
      add('HT Bill','Demand Charges','B4', model.B4,'&#8377;');
      add('HT Bill','Energy Charges','C4', model.C4,'&#8377;');
      add('HT Bill','Fuel Charge','E4', model.E4,'&#8377;');
      add('HT Bill','PF Rebate','F4', model.F4,'&#8377;');
      add('HT Bill','Night Rebate','D4', model.D4,'&#8377;');
      add('HT Bill','EHV Rebate','G4', model.G4,'&#8377;');
      add('HT Bill','TOU','H4', model.H4,'&#8377;');
      add('HT Bill','Time DISC Charges','J4', model.J4,'&#8377;');
      add('HT Bill','GT Charges','I4', model.I4,'&#8377;');

      add('HT Bill (calc)','Total Consumption Charge','A9', model.A9,'&#8377;');
      add('HT Bill (calc)','ED @ 20%','B9', model.B9,'&#8377;');
      add('HT Bill (calc)','Current Month Bill','C9', model.C9,'&#8377;');

      // Adjust
      add('Adjust','Outstanding Arrears','D9', model.D9,'&#8377;');
      add('Adjust','Freeze Amount','E9', model.E9,'&#8377;');
      add('Adjust','Delayed Payment Charges','F9', model.F9,'&#8377;');
      add('Adjust','Advance Payment / Adjust.','G9', model.G9,'&#8377;');
      add('Adjust (calc)','Net Payable','H9', model.H9,'&#8377;');
      add('Adjust (calc)','Actual Amount to be Paid','I9', model.I9,'&#8377;');
      add('Adjust (calc)','Balance Pending from Previous Month','A31', model.A31,'&#8377;');

      // WEG
      add('WEG','Share Bitlavadia (%)','B15', model.B15,'%');
      add('WEG','Share Nanisindhodi (%)','D15', model.D15,'%');
      add('WEG','Transmission Loss (%)','C16', model.C16,'%');
      add('WEG','Bitlavadia MWh #1','A17', model.A17,'MWh');
      add('WEG','Bitlavadia MWh #2','B17', model.B17,'MWh');
      add('WEG','Nanisindhodi MWh #1','C17', model.C17,'MWh');
      add('WEG','Nanisindhodi MWh #2','D17', model.D17,'MWh');
      add('WEG','Nanisindhodi MWh #3','E17', model.E17,'MWh');
      add('WEG (calc)','Bitlavadia Share (kWh)','A18', model.A18,'kWh');
      add('WEG (calc)','Nanisindhodi Share (kWh)','C18', model.C18,'kWh');
      add('WEG (calc)','Total Allocated (kWh)','A19', model.A19,'kWh');

      // Wind Credits / Debits
      add('Wind Credits','Credit Board Charges','A24', model.A24,'&#8377;');
      add('Wind Credits','Credit ED Charges','B24', model.B24,'&#8377;');
      add('Wind Credits','Credit TDS','C24', model.C24,'&#8377;');
      (model.creditsExtras || []).filter(e=>e && e.include).forEach(extra=>{
        const label = (extra.label && extra.label.trim()) ? extra.label.trim() : 'Credits extra';
        add('Wind Credits', `${label} (extra)`, 'extra', extra.amount,'&#8377;');
      });
      add('Wind Debits','Debit Board Charges','D24', model.D24,'&#8377;');
      add('Wind Debits','Debit Electricity Duty','E24', model.E24,'&#8377;');
      add('Wind Debits','Debit Wheeling Charges','F24', model.F24,'&#8377;');
      (model.debitsExtras || []).filter(e=>e && e.include).forEach(extra=>{
        const label = (extra.label && extra.label.trim()) ? extra.label.trim() : 'Debits extra';
        add('Wind Debits', `${label} (extra)`, 'extra', extra.amount,'&#8377;');
      });
      add('Wind (calc)','Total Credit','A26', model.A26,'&#8377;');
      add('Wind (calc)','Total Debit','B26', model.B26,'&#8377;');
      add('Wind (calc)','Net Wind Credit','C26', model.C26,'&#8377;');
      add('Wind (calc)','Wind Rate (&#8377;/kWh)','B19', model.B19,'&#8377;/kWh');
      add('Wind (calc)','Share 4.5 MW (&#8377;)','F16', model.F16,'&#8377;');
      add('Wind (calc)','Share 14.7 MW (&#8377;)','G16', model.G16,'&#8377;');

      // FINAL
      (model.finalExtras || []).filter(e=>e && e.include).forEach(extra=>{
        const label = (extra.label && extra.label.trim()) ? extra.label.trim() : 'Final adjustment extra';
        add('FINAL', `${label} (extra)`, 'extra', extra.amount,'&#8377;');
      });
      add('FINAL','Final Bill for IOM','&mdash;', model.FINAL,'&#8377;');

      return { secs, order };
    }

    function buildIomStatementHtml(model, monthLabel, generatedAt){
      // Remove leading rupee sign plus any regular/NBSP/NNBSP spacing
      const inrNoSymbol = (v) => String(asINR(v) || '')
        .replace(/^[&#8377;\s\u00A0\u202F]+/, '')
        .trim();
      const el = document.createElement('div');
      el.className = 'sheet';
      const meta = generatedAt || new Date().toLocaleString();
      const metaISO = (() => { try { const d = generatedAt ? new Date(generatedAt) : new Date(); return isNaN(d) ? new Date().toISOString() : d.toISOString(); } catch { return new Date().toISOString(); } })();
      const bankT = SAP_BANKT;
      const cfg = window.appConfig || {};
      const asTrimmed = val => typeof val === 'string' ? val.trim() : '';
      const domVal = id => {
        const el = document.getElementById(id);
        return el && typeof el.value === 'string' ? el.value.trim() : '';
      };
      const vendorCode = asTrimmed(cfg.iom_vendor_code) || asTrimmed(cfg.vendor_code) || domVal('rc_vendorCode') || SAP_VENDOR_CODE;
      const companyName = asTrimmed(cfg.iom_company_name) || asTrimmed(cfg.vendor_name) || domVal('rc_vendorName') || 'Paschim Gujarat Vij Company Ltd';
      const locationText = asTrimmed(cfg.iom_location) || 'Samakhiali, Gujarat';
      const bankAccount = asTrimmed(cfg.bank_ac_no) || '31729314272';
      const ifsc = (asTrimmed(cfg.ifsc) || 'SBIN0000554').toUpperCase();
      const branch = asTrimmed(cfg.branch) || 'SBI – Bhachau';
      const approverDgmWic = asTrimmed(cfg.approver_dgm_wic) || 'DGM (O&M)/WIC, Samakhiali';
      const approverSmEle = asTrimmed(cfg.approver_sm_ele) || 'Senior Manager (ELE)';
      const approverDgmFa = asTrimmed(cfg.approver_dgm_fa) || 'DGM (F&A), Jaipur';
      const infoBarPlain = `Please pay to ${companyName} (Vendor Code: ${vendorCode}). Bank A/C No.: ${bankAccount}; RTGS/NEFT IFSC: ${ifsc}; Branch: ${branch}`;
      const companyNbsp = esc(companyName).replace(/ /g,'&nbsp;');
      const infoBarAttr = esc(infoBarPlain);
      const finalExtras = (model.finalExtras || []).filter(e=>e && e.include);
      const mappingRows = [
        ['Current Month Bill',           'C9',    model.C9,  'none'],
        ['Share of 4.5MW WEG',           'F16',   model.F16, 'minus'],
        ['Share of 14.7MW WEG',          'G16',   model.G16, 'minus'],
        ['Credit TDS',                   'C24',   model.C24, 'minus'],
      ];
      finalExtras.forEach(extra=>{
        const label = (extra.label && extra.label.trim()) ? `${extra.label.trim()} (extra)` : 'Final adjustment extra (extra)';
        mappingRows.push([label, '—', extra.amount, 'final-extra']);
      });
      const hasFinalExtras = mappingRows.length > 4;
      mappingRows.push(
        ['Balance Pending (prev)',       'A31',   model.A31, 'plus'],
        ['Delay Charges',                'F9',    model.F9,  'plus']
      );
      try { document.title = `IOM - HT Bill – ${monthLabel}`; } catch {}
      el.innerHTML = `
        <div class="doc-header">
          <div>
            <div class="company">GAIL (India) Limited &ndash; ${esc(locationText)}</div>
            <div class="dept">Electrical Department</div>
            <h2 role="heading" aria-level="1">IOM - HT Bill</h2>
            <div class="mini">Billing Month: <b>${monthLabel}</b></div>
          </div>
          <div class="doc-meta">
            Generation Date: <b><time datetime="${metaISO}">${meta}</time></b>
          </div>
        </div>
        <div
          class="info-bar"
          title="${infoBarAttr}"
          aria-label="${infoBarAttr}"
        >Please pay to <b>${companyNbsp}</b> (Vendor Code: <b>${esc(vendorCode)}</b>). Bank A/C No.: <b>${esc(bankAccount)}</b>; RTGS/NEFT IFSC: <b>${esc(ifsc)}</b>; Branch: <b>${esc(branch)}</b></div>
        <section class="sec mapping" role="table" aria-label="Amount Mapping (per formula)">
          <h3>Amount Mapping (per formula)</h3>
          <div class="footer-note" style="margin:0 0 6px 0;">
            Mapping: Current Month Bill &ndash; Share(4.5MW) &ndash; Share(14.7MW) &ndash; Credit TDS${hasFinalExtras ? ' &ndash; Final adj. extras' : ''} + Balance Pending (prev) + Delay Charges
          </div>
          <div class="kv" role="row" aria-roledescription="header">
            <div class="label" role="columnheader" style="color:#6b7280;text-transform:uppercase;font-size:11px;">Component <span class="mono">(cell)</span></div>
            <div class="value" role="columnheader" style="color:#6b7280;text-transform:uppercase;font-size:11px;">Amount</div>
            <div class="unit" role="columnheader" style="color:#6b7280;text-transform:uppercase;font-size:11px;">&#8377;</div>
          </div>
          ${mappingRows.map(([label, cell, val, sign]) => {
            const valNum = Number(val) || 0;
            const amt = Math.abs(valNum);
            let sym = '';
            if (sign === 'minus') sym = amt === 0 ? '' : '&minus;';
            else if (sign === 'plus') sym = amt === 0 ? '' : '+';
            else if (sign === 'final-extra') {
              sym = amt === 0 ? '' : (valNum >= 0 ? '&minus;' : '+');
            }
            const cellText = cell && cell.trim() ? cell.trim() : '—';
            return `
            <div class="kv" role="row">
              <div class="label" role="rowheader">${esc(label)} <span class="mono">${esc(cellText)}</span></div>
              <div class="value" role="cell">${sym}${inrNoSymbol(amt)}</div>
              <div class="unit" role="cell">&#8377;</div>
            </div>`;
          }).join('')}
          <div class="kv" role="row" aria-roledescription="total">
            <div class="label" role="rowheader"><b>Net Payable</b></div>
            <div class="value total" role="cell">${inrNoSymbol(model.FINAL)}</div>
            <div class="unit" role="cell">&#8377;</div>
          </div>
        </section>
        <section class="sec" role="region" aria-labelledby="cert-h">
          <h3 id="cert-h">Certification & Attachments</h3>
          <div class="footer-note">
            The amount claimed here has not been previously paid.<br/>
            The payment of ${asINR(model.FINAL)} is certified and verified.<br/>
            The expenditure is in the interest of the company.<br/>
            Certified copies of the bills are attached.<br/>
            <span data-testid="receipt-note">Bill received via central post.</span>
          </div>
          <div class="footer-note" style="margin-top:6px;">
            Attachments: Bill copy; Credit & Debit Adjustment Details (PGVCL); SES sheet; BWS receipt.
          </div>
        </section>
        <section class="sec signatures" role="group" aria-labelledby="sig-h">
          <h3 id="sig-h">Authorizations & Signatures</h3>
          <div class="sigs">
            <div class="sig">
              <div class="line" aria-hidden="true"></div>
              <div class="role" data-testid="sig-dgm-om">${esc(approverDgmWic)}</div>
            </div>
            <div class="sig right">
              <div class="line" aria-hidden="true"></div>
              <div class="role" data-testid="sig-sm-ele">${esc(approverSmEle)}</div>
            </div>
            <div class="sig">
              <div class="line" aria-hidden="true"></div>
              <div class="role" data-testid="sig-dgm-fa">${esc(approverDgmFa)}</div>
            </div>
          </div>
        </section>
        <div class="footer-note" style="margin-top:6mm;">Keep this PDF with the source data for audit.</div>
        <div class="page-number" aria-hidden="true">Page 1</div>`;
      // Accessibility: hide decorative page number from AT if present
      try {
        const pn = el.querySelector('.page-number');
        if (pn) pn.setAttribute('aria-hidden','true');
      } catch {}
      return el;
    }


    /* ---- Central Dak Receipt: presentation layer (scoped to #htmlPrintHost) ---- */
    function ensureReceiptCss(){
      if (document.getElementById('receipt-css-v2')) return;
      const css = `
      #htmlPrintHost .rcpt{position:relative;font:13px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#111;padding:16mm 18mm 22mm}
      #htmlPrintHost .rcpt .hdr{text-align:center;margin-bottom:8mm}
      #htmlPrintHost .rcpt .hdr .title{font-weight:800;font-size:16pt;letter-spacing:.2px}
      #htmlPrintHost .rcpt .hdr .unit{color:#374151}
      #htmlPrintHost .rcpt .hdr .subtitle{font-size:12.5pt;margin-top:1mm}
      #htmlPrintHost .rcpt .meta{display:flex;justify-content:space-between;align-items:flex-end;margin:2mm 0 1mm}
      #htmlPrintHost .rcpt .meta .right{white-space:nowrap}
      #htmlPrintHost .rcpt .kvgrid{display:grid;grid-template-columns:40mm 1fr 32mm 1fr;column-gap:8mm;row-gap:3.5mm;
                                   padding:5mm 0;border-top:1px dashed #e5e7eb;border-bottom:1px dashed #e5e7eb}
      #htmlPrintHost .rcpt .label{color:#374151;white-space:nowrap}
      #htmlPrintHost .rcpt .value{font-weight:700;font-variant-numeric:tabular-nums}
      #htmlPrintHost .rcpt .amount{text-align:right}
      #htmlPrintHost .rcpt .sign{margin-top:16mm;display:flex;justify-content:flex-end}
      #htmlPrintHost .rcpt .sign .line{width:60mm;border-top:1px solid #000;height:0;margin-bottom:3mm}
      #htmlPrintHost .rcpt .sign .cap{font-size:12px;color:#111;text-align:center}
      #htmlPrintHost .rcpt .foot{position:absolute;left:18mm;right:18mm;bottom:8mm;display:flex;justify-content:space-between;
                                 align-items:center;color:#6b7280;font-size:10pt}
      /* print guard for the receipt */
      @media print{
        header,.toolbar,.card:not(.sheet),#toasts,.ui{display:none !important}
        #htmlPrintHost{display:block !important}
        #htmlPrintHost .sheet{display:block !important;border:none;width:auto;min-height:auto;margin:0;padding:0 0 16mm 0;break-inside:avoid;
                              -webkit-print-color-adjust:exact;print-color-adjust:exact}
        @page{size:A4;margin:14mm}
      }`;
      const s = document.createElement('style');
      s.id = 'receipt-css-v2';
      s.textContent = css;
    document.head.appendChild(s);
  }

    function setIomPrintScaleIfNeeded(sheetEl){
      try{
        if(!sheetEl) return;
        // Convert mm to px by measuring a probe element; avoids hard-coding DPI.
        const mmToPx = (mm) => {
          const probe = document.createElement('div');
          probe.style.height = mm + 'mm';
          probe.style.position = 'absolute';
          probe.style.visibility = 'hidden';
          document.body.appendChild(probe);
          const px = probe.getBoundingClientRect().height || 0;
          probe.remove();
          return px;
        };
        const pagePx = mmToPx(297);
        const sheetPx = sheetEl.getBoundingClientRect().height || 0;
        if(pagePx > 0 && sheetPx > 0 && sheetPx > pagePx){
          const scale = Math.max(0.88, Math.min(0.98, pagePx / sheetPx));
          document.documentElement.style.setProperty('--iom-scale', String(scale));
        }
      }catch(_){ }
    }

    function renderHtmlPreview(model, monthLabel, generatedAt) {
      const host = document.getElementById('htmlPrintHost');
      host.innerHTML = '';
      host.dataset.monthLabel = monthLabel || '';
      const sheet = buildIomStatementHtml(model, monthLabel, generatedAt);
      sheet.classList.add('iom'); // scope print scaling to IOM only
      host.appendChild(sheet);
      // Best-effort dynamic fit (no-op in environments that don't compute layout)
      setIomPrintScaleIfNeeded(sheet);
      sheet.scrollIntoView({ behavior: 'smooth' });
      host.focus({ preventScroll: true });
    }

    // --- Central Dak Receipt: concrete implementations (ported from standalone)
    // Uses existing helpers: esc, cleanAmount, inr, validDDMMYYYY
    window.buildDakReceiptHtml = function buildDakReceiptHtml(d){
      const wrap = document.createElement('section');
      wrap.className = 'sheet rcpt';
      wrap.setAttribute('role','document');
      const amtNum = cleanAmount(d.amount);
      const cfg = window.appConfig || {};
      const unitName = (() => {
        const raw = cfg.ips_samakhiali;
        if (typeof raw === 'string' && raw.trim()) return raw.trim();
        return 'IPS Samakhiali';
      })();
      wrap.innerHTML = `
        <div class="hdr" aria-label="Receipt header">
          <div class="title">GAIL (India) LIMITED</div>
          <div class="unit">${esc(unitName)}</div>
          <div class="subtitle">Central Dak Receipt</div>
        </div>
        <div class="meta">
          <div></div>
          <div class="right"><b>Bill No.:</b> ${esc(d.billNo)}</div>
        </div>
        <div class="kvgrid" aria-label="Key values">
          <div class="label">Vendor Code</div><div class="value">${esc(d.vendorCode)}</div>
          <div class="label">Vendor Name</div><div class="value">${esc(d.vendorName)}</div>
          <div class="label">Bill Date</div><div class="value">${esc(d.billDate)}</div>
          <div class="label">Amount</div><div class="value amount">${esc(inr(amtNum))}</div>
          <div class="label">EIC Name</div><div class="value">${esc(d.eic)}</div>
        </div>
        <div class="sign" aria-label="Signature block">
          <div>
            <div class="line" aria-hidden="true"></div>
            <div class="cap">Sign. Of Initiator</div>
          </div>
        </div>
        <div class="foot" aria-label="Footer">
          <small>Generated locally in your browser.</small>
          <span>1</span>
        </div>`;
      return wrap;
    }

    window.renderDakReceipt = function renderDakReceipt(){
      let host = document.getElementById('htmlPrintHost');
      if (!host) {
        host = document.createElement('div');
        host.id = 'htmlPrintHost';
        document.body.appendChild(host);
      }
      ensureReceiptCss();

      const v = (x)=>String(x||'').trim();
      const billNoEl   = document.getElementById('rc_billNo');
      const billDateEl = document.getElementById('rc_billDate');
      let billNo = v(billNoEl?.value);
      if (!billNo){
        const now = new Date();
        const MMM = now.toLocaleString('en-US',{month:'short'}).toUpperCase();
        const YY  = String(now.getFullYear()).slice(-2);
        billNo = `HT-BILL_${MMM}-${YY}`;
        if (billNoEl) billNoEl.value = billNo;
      }
      const billDate = v(billDateEl?.value);
      if (billDateEl) billDateEl.classList.toggle('warn', !!billDate && !validDDMMYYYY(billDate));

      const cfg = window.appConfig || {};
      const data = {
        vendorCode: v(document.getElementById('rc_vendorCode')?.value) || (cfg.vendor_code || ''),
        vendorName: v(document.getElementById('rc_vendorName')?.value) || (cfg.vendor_name || ''),
        billNo,
        billDate,
        amount: v(document.getElementById('rc_amount')?.value),
        eic: v(document.getElementById('rc_eic')?.value) || (cfg.eic_name || '')
      };

      const btnSave = document.getElementById('saveHtmlPdf');
      const btnOpen = document.getElementById('openHtmlPdf');
      const chkAuto = document.getElementById('autoPrintHtml'); // optional

      host.setAttribute('aria-busy','true');
      try{
        host.innerHTML = '';
        const sheet = buildDakReceiptHtml(data);
        host.appendChild(sheet);
        sheet.scrollIntoView({behavior:'smooth', block:'start'});
        host.focus({preventScroll:true});
        // styles are already scoped; nothing else to hide here

        // Enable Save/Open for parity with toolbar, but do not bind a second
        // click handler to #saveHtmlPdf here to avoid double print dialogs.
        if (btnSave){ btnSave.disabled = false; btnSave.setAttribute('aria-disabled','false'); }
        if (btnOpen){ btnOpen.disabled = false; btnOpen.setAttribute('aria-disabled','false');
          if (!btnOpen.dataset.bound){ btnOpen.dataset.bound = '1';
            btnOpen.addEventListener('click', () => {
              // Clean print view (about:blank). Reuse receipt CSS for parity.
              const minimalCSS =
                `@page{size:A4;margin:14mm}html,body{height:100%}` +
                `body{margin:0;background:#fff;color:#000;font:14px system-ui,-apple-system,Segoe UI,Roboto,Arial}` +
                `.sheet{width:210mm;min-height:297mm;margin:0 auto;padding:14mm;box-sizing:border-box}`;
              const rawRcptCss = (document.getElementById('receipt-css-v2')?.textContent || '') +
                                (document.getElementById('print-guard-receipt')?.textContent || '');
              // De-scope rules anchored to '#htmlPrintHost ' or 'html.print-rcpt '
              const popupRcptCss = rawRcptCss ? rawRcptCss.replace(/#htmlPrintHost\s+/g, '').replace(/html\.print-rcpt\s+/g,'') : '';
              const mergedCss = minimalCSS + (popupRcptCss ? `\n/* receipt-css */\n` + popupRcptCss : '');
              const printScript =
                `(function(){`+
                `  function mmToPx(mm){var d=document.createElement('div');d.style.height=mm+"mm";d.style.position='absolute';d.style.visibility='hidden';document.body.appendChild(d);var px=d.getBoundingClientRect().height||0;d.remove();return px;}`+
                `  function fit(){var s=document.querySelector('.sheet.rcpt')||document.querySelector('.sheet.receipt');if(!s)return;var pagePx=mmToPx(297-14*2);var h=s.getBoundingClientRect().height||0;if(h>pagePx){var scale=Math.max(0.98,Math.min(1,pagePx/h));s.style.transform='scale('+scale+')';s.style.transformOrigin='top left';s.style.width=(210/scale)+'mm';}}`+
                `  window.addEventListener('load',function(){fit();setTimeout(function(){try{window.focus();window.print();}catch(e){}},150);});`+
                `})();`;
              // sanitize bill no for window title / filename (reuse helper)
              const safeBn = sanitizeFileStem(data.billNo);
              // Popup title drives filename in many UAs:
              const title = safeBn ? `Central Dak Receipt - ${esc(safeBn)}` : 'Central Dak Receipt';
              const html =
                `<!doctype html><html><head><meta charset="utf-8">` +
                `<title>${title}</title><style>${mergedCss}</style></head>` +
                `<body>${sheet.outerHTML}<script>${printScript}<\/script></body></html>`;
              try{ const w = window.open('', '_blank', 'noopener,noreferrer');
                   if (w){ w.document.open(); w.document.write(html); w.document.close(); return; } }catch(_){ }
              try{ const blob = new Blob([html], {type:'text/html'}); const url = URL.createObjectURL(blob);
                   const w2 = window.open(url, '_blank', 'noopener,noreferrer');
                   setTimeout(() => URL.revokeObjectURL(url), 1000);
                   if(!w2){ alert('Popup blocked. Allow popups or use &ldquo;Save as PDF&rdquo;.'); } }catch(e){ alert('Could not open print view: ' + (e?.message||e)); }
            });
          }
        }
        if (chkAuto?.checked){ requestAnimationFrame(()=> setTimeout(()=> window.print(), 100)); }
        try{ toast('Receipt ready.', 'good'); }catch(_){ }
      } finally {
        host.removeAttribute('aria-busy');
      }
    }


      // Excel workbook in memory (lazy init)
      let WB = null;
  function getWB(){
        if(!window.XLSX) return null;
        if(!WB){
          WB = XLSX.utils.book_new();
          WB.Props = { Title:'WEG Billing Workbook', Author:'WEG Billing Calculator', CreatedDate:new Date() };
        }
        return WB;
      }

    const LS_KEY = 'weg-billing-v1';

    function persist(){
      const inputs = {};
      document.querySelectorAll('input').forEach(el=>{
        if(!el.id || isConfigInput(el)) return;
        inputs[el.id] = el.value;
      });
      const _wb = getWB();
      canonicalizeWorkbook();
      const data = { inputs, sheets: _wb ? _wb.SheetNames.slice() : [] };
      localStorage.setItem(LS_KEY, JSON.stringify(data));
    }

    const persistDebounced = debounce(persist, 200);

    function restore(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return false;
        const data = JSON.parse(raw);
        if(data.inputs){
          Object.entries(data.inputs).forEach(([id,val])=>{
            const el = $(id);
            if(el){
              el.value = val;
              if(!isConfigInput(el) && el.type==='text' && !el.closest('#receiptCard')) parseInrInput(el);
            }
          });
        }
        if(Array.isArray(data.sheets)){
          const _wb = getWB();
          if(_wb){
            _wb.SheetNames = data.sheets;
            canonicalizeWorkbook();
          }
        }
        return true;
      }catch(err){
        console.error(err);
      }
      return false;
    }

    function refreshSheetList(){
      canonicalizeWorkbook();
      const list = $('sheetList');
      list.innerHTML = '';
      const _wb = getWB();
      if(!_wb) return;
      const names = _wb.SheetNames || [];
      const renderNames = sortDisplayNames(names);
      const active = $('billMonth').value;
      let hasFocusable = false;
      renderNames.forEach((name, idx) => {
        const pill = document.createElement('span');
        pill.className = 'pill';
        pill.setAttribute('role','option');
        const isActive = name === active;
        if (isActive) {
          pill.setAttribute('aria-selected','true');
          pill.tabIndex = 0;
          hasFocusable = true;
        } else {
          pill.tabIndex = -1;
        }

        const btnGo = document.createElement('button');
        btnGo.className = 'ghost';
        btnGo.tabIndex = -1;
        btnGo.textContent = name;
        btnGo.setAttribute('aria-label', `Open ${name}`);
        btnGo.addEventListener('click', () => {
          // Only write to <input type="month"> if the sheet name is canonical YYYY-MM.
          const mm = /^\d{4}-(0[1-9]|1[0-2])$/.test(name) ? name : null;
          if (mm) {
            $('billMonth').value = mm;
          } else {
            // Keep UX calm: just inform without breaking flow.
            toast(`Sheet "${name}" isn&rsquo;t a YYYY-MM label. Month picker left unchanged.`, 'info');
          }
          // Continue with compute() so the action still proceeds as before.
          compute();
          list.querySelectorAll('[role="option"]').forEach(o => { o.tabIndex = -1; o.removeAttribute('aria-selected'); });
          pill.setAttribute('aria-selected','true');
          pill.tabIndex = 0;
          pill.focus();
        });

        const btnDel = document.createElement('button');
        btnDel.className = 'ghost';
        btnDel.tabIndex = -1;
        btnDel.setAttribute('aria-label', `Remove ${name}`);
        btnDel.textContent = '&times;';
        btnDel.addEventListener('click', async (e) => {
          e.stopPropagation();
          const options = [...list.querySelectorAll('[role="option"]')];
          const i = options.indexOf(pill);
          if(!(await confirmModal(`Remove sheet "${name}" from the workbook?`))) return;
          const wb = getWB(); if(!wb) return;
          delete wb.Sheets[name];
          wb.SheetNames = wb.SheetNames.filter(n => n !== name);
          canonicalizeWorkbook();
          toast(`Removed sheet: ${name}`, 'good');
          refreshSheetList();
          const next = list.querySelectorAll('[role="option"]')[i] || list.querySelector('[role="option"]:last-child');
          // Only move focus if the strip is visible
          if (list && list.offsetParent) next?.focus();
        });

        pill.append(btnGo, btnDel);
        pill.addEventListener('keydown', (e) => {
          const focusOption = dir => {
            const options = [...list.querySelectorAll('[role="option"]')];
            const i = options.indexOf(document.activeElement);
            const j = Math.max(0, Math.min(options.length - 1, i + dir));
            options[j]?.focus();
          };
          if (e.key === 'ArrowRight') { e.preventDefault(); focusOption(1); }
          if (e.key === 'ArrowLeft')  { e.preventDefault(); focusOption(-1); }
          if (e.key === 'Home')       { e.preventDefault(); list.querySelector('[role="option"]')?.focus(); }
          if (e.key === 'End')        { e.preventDefault(); [...list.querySelectorAll('[role="option"]')].pop()?.focus(); }
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btnGo.click(); }
          if (e.key === 'Delete') { e.preventDefault(); btnDel.click(); }
        });

        list.appendChild(pill);
      });
      if (!hasFocusable) {
        const last = list.querySelector('[role="option"]:last-child');
        if (last) last.tabIndex = 0;
      }
      list.scrollLeft = list.scrollWidth;
      persistDebounced();
      const search = document.getElementById('sheetSearch');
      renderSheetMenu(search ? search.value : '');
    }

    function buildSheetData(model, monthLabel){
      const rows = [];
      // Always push a row array, even if r(['a','b']) or r('a','b') is used.
      function r(...cells){
        const row = (cells.length === 1 && Array.isArray(cells[0])) ? cells[0] : cells;
        rows.push(row);
      }

        const DANGEROUS_FORMULA = /^[=+@]/;
        const isPlainNegativeNumber = s => /^-\d+(\.\d+)?$/.test(s);
        const looksLikeYYYYMM = s => /^\d{4}-(0[1-9]|1[0-2])$/.test(s);
        const INR_SYMBOL = '\u20B9';
        const decodeHtmlEntities = (() => {
          const textarea = document.createElement('textarea');
          return (value) => {
            if (typeof value !== 'string' || value.indexOf('&') === -1) return value;
            textarea.innerHTML = value;
            return textarea.value;
          };
        })();
        function forceText(v){
          if (v == null) return '';
          if (typeof v === 'object') return v;
          let s = String(v);
          if (s.indexOf('&') !== -1) {
            const decoded = decodeHtmlEntities(s);
            if (typeof decoded === 'string') s = decoded;
          }
          if (DANGEROUS_FORMULA.test(s)) return { t:'s', v:s, z:'@' };
          if (s.startsWith('-') && !isPlainNegativeNumber(s)) return { t:'s', v:s, z:'@' };
          return looksLikeYYYYMM(s) ? { t:'s', v:s, z:'@' } : s;
        }

      // Header row
      r(['WEG Billing &ndash; Month', monthLabel]);
      r(['Generated at', new Date().toLocaleString()]);
      r([]);

      r(['SECTION','FIELD','CELL','VALUE','UNITS/NOTES']);
      // HT Bill
      r(['HT Bill','Monthly Consumption','A4', model.A4, 'kWh']);
      r(['HT Bill','Demand Charges','B4', model.B4, '&#8377;']);
      r(['HT Bill','Energy Charges','C4', model.C4, '&#8377;']);
      r(['HT Bill','Fuel Charge','E4', model.E4, '&#8377;']);
      r(['HT Bill','PF Rebate','F4', model.F4, '&#8377;']);
      r(['HT Bill','Night Rebate','D4', model.D4, '&#8377;']);
      r(['HT Bill','EHV Rebate','G4', model.G4, '&#8377;']);
      r(['HT Bill','TOU','H4', model.H4, '&#8377;']);
      r(['HT Bill','Time DISC Charges','J4', model.J4, '&#8377;']);
      r(['HT Bill','GT Charges','I4', model.I4, '&#8377;']);
      // mark calculated rows as currency so Excel formats them
      r(['HT Bill (calc)','Total Consumption Charge','A9', model.A9, '&#8377;']);
      r(['HT Bill (calc)','ED @ 20%','B9', model.B9, '&#8377;']);
      r(['HT Bill (calc)','Current Month Bill','C9', model.C9, '&#8377;']);
      r([]);

      // Adjustments
      r(['Adjust','Outstanding Arrears','D9', model.D9, '&#8377;']);
      r(['Adjust','Freeze Amount','E9', model.E9, '&#8377;']);
      r(['Adjust','Delayed Payment Charges','F9', model.F9, '&#8377;']);
      r(['Adjust','Advance Payment / Adjust.','G9', model.G9, '&#8377;']);
      r(['Adjust (calc)','Net Payable','H9', model.H9, '&#8377;']);
      r(['Adjust (calc)','Actual Amount to be Paid','I9', model.I9, '&#8377;']);
      r(['Adjust (calc)','Balance Pending from Previous Month','A31', model.A31, '&#8377;']);
      r([]);

      // WEG Inputs
      r(['WEG','Share Bitlavadia (%)','B15', model.B15, '%']);
      r(['WEG','Share Nanisindhodi (%)','D15', model.D15, '%']);
      r(['WEG','Transmission Loss (%)','C16', model.C16, '%']);
      r(['WEG','Bitlavadia MWh #1','A17', model.A17, 'MWh']);
      r(['WEG','Bitlavadia MWh #2','B17', model.B17, 'MWh']);
      r(['WEG','Nanisindhodi MWh #1','C17', model.C17, 'MWh']);
      r(['WEG','Nanisindhodi MWh #2','D17', model.D17, 'MWh']);
      r(['WEG','Nanisindhodi MWh #3','E17', model.E17, 'MWh']);
      r(['WEG (calc)','Bitlavadia Share (kWh)','A18', model.A18, 'kWh']);
      r(['WEG (calc)','Nanisindhodi Share (kWh)','C18', model.C18, 'kWh']);
      r(['WEG (calc)','Total Allocated (kWh)','A19', model.A19, 'kWh']);
      r([]);

      // Credits & Debits
      r(['Wind Credits','Credit Board Charges','A24', model.A24, '&#8377;']);
      r(['Wind Credits','Credit ED Charges','B24', model.B24, '&#8377;']);
      r(['Wind Credits','Credit TDS','C24', model.C24, '&#8377;']);
      r(['Wind Debits','Debit Board Charges','D24', model.D24, '&#8377;']);
      r(['Wind Debits','Debit Electricity Duty','E24', model.E24, '&#8377;']);
      r(['Wind Debits','Debit Wheeling Charges','F24', model.F24, '&#8377;']);
      r(['Wind (calc)','Total Credit','A26', model.A26, '&#8377;']);
      (model.creditsExtras || []).filter(e=>e && e.include).forEach(extra=>{
        const label = (extra.label && extra.label.trim()) ? extra.label.trim() : 'Credits extra';
        r(['Wind Credits (extra)', label, 'extra', extra.amount, '&#8377;']);
      });
      r(['Wind (calc)','Total Debit','B26', model.B26, '&#8377;']);
      (model.debitsExtras || []).filter(e=>e && e.include).forEach(extra=>{
        const label = (extra.label && extra.label.trim()) ? extra.label.trim() : 'Debits extra';
        r(['Wind Debits (extra)', label, 'extra', extra.amount, '&#8377;']);
      });
      r(['Wind (calc)','Net Wind Credit','C26', model.C26, '&#8377;']);
      r(['Wind (calc)','Wind Rate (&#8377;/kWh)','B19', model.B19, '&#8377;/kWh']);
      r(['Wind (calc)','Share 4.5 MW (&#8377;)','F16', model.F16, '&#8377;']);
      r(['Wind (calc)','Share 14.7 MW (&#8377;)','G16', model.G16, '&#8377;']);
      r([]);

      // Final
      (model.finalExtras || []).filter(e=>e && e.include).forEach(extra=>{
        const label = (extra.label && extra.label.trim()) ? extra.label.trim() : 'Final adjustment extra';
        r(['FINAL (extra)', label, 'extra', extra.amount, '&#8377;']);
      });
      r(['FINAL','Final Bill for IOM','&mdash;', model.FINAL, '&#8377;']);

      const valueCol = 3;          // VALUE index
      const NUM = x => (typeof x === 'number' ? x
                : (x==='' || x==null ? null : Number(String(x).replace(/[, ]/g,''))));

      const typedRows = rows.map(row => {
        // Guard: row must be an array
        if (!Array.isArray(row)) row = [String(row)];   // last-resort safety net
        const out = row.slice();

        // A,B,C,E -> text
        [0,1,2,4].forEach(ci => { if (ci in out) out[ci] = forceText(out[ci]); });

        // VALUE -> numeric or blank
        if (valueCol in out) {
          const n = NUM(out[valueCol]);
          out[valueCol] = (n==null || !isFinite(n)) ? { t:'z' } : { t:'n', v:n };
        }
        return out;
      });

      if (window.DEV) {
        const bad = typedRows.find(r => !Array.isArray(r));
        if (bad) console.error('Export row not array:', bad);
      }

      const ws = XLSX.utils.aoa_to_sheet(typedRows);

      const firstDataRow = 4;                    // month, generated-at, blank, header
      const lastRow = typedRows.length - 1;
      const unitAt = ri => {
        const u = typedRows[ri] && typedRows[ri][4];
        return (u && u.v) || u || '';
      };

      for (let r = firstDataRow; r <= lastRow; r++) {
        const addr = XLSX.utils.encode_cell({ r, c: valueCol });
        const cell = ws[addr];
        if (!cell || cell.t !== 'n') continue;
        const unit = unitAt(r);
        if (unit === '%') { cell.v = cell.v / 100; cell.z = '0.00%'; }
        else if (unit === INR_SYMBOL || unit === '&#8377;') { cell.z = `${INR_SYMBOL}#,##0.00`; }
        else if (unit === `${INR_SYMBOL}/kWh` || unit === '&#8377;/kWh') { cell.z = `${INR_SYMBOL}#,##0.000000`; }
        else if (unit === 'MWh') { cell.z = '0.000'; }
        else if (unit === 'kWh') { cell.z = '#,##0'; }
        else { cell.z = '#,##0.00'; }
      }

      updateRatesFromInputs();
      computeSes();
      const rateRows = [[]];
      rateRows.push(["Service Code","Service Name","Qty (B)","Tariff (C)","Amt (D)","Contract Rate (E)","Unit Adj (F)","Amount SES (G)"]);
      sesRows.forEach(r=>{
        const C=tariffs.rates[r.code]||0;
        const E=poRates.rates[r.code]||0;
        rateRows.push([r.code,r.name,r.qty,C,r.amt,E,r.adj,r.ses]);
      });
      const preLast=XLSX.utils.decode_range(ws['!ref']).e.r;
      XLSX.utils.sheet_add_aoa(ws, rateRows, {origin:-1});
      const range=XLSX.utils.decode_range(ws['!ref']);
      for(let R=preLast+3;R<=range.e.r;++R){
        for(let C=2;C<=7;++C){
          const cell=XLSX.utils.encode_cell({r:R,c:C});
          if(ws[cell]){ws[cell].t='n'; ws[cell].z='0.00';}
        }
      }
      ws['!cols']=[{wch:18},{wch:32},{wch:8},{wch:16},{wch:36},{wch:14},{wch:12},{wch:14}];
      ws['!autofilter'] = { ref: XLSX.utils.encode_range({ s:{ r:firstDataRow-1, c:0 }, e:{ r:lastRow, c:4 } }) };
      return ws;
    }

      // --- Display-only sorting: canonical YYYY-MM first (desc), then legacy (stable) ---
      function sortDisplayNames(names){
        const isYYYYMM = n => /^\d{4}-(0[1-9]|1[0-2])$/.test(n);
        const canonical = [];
        const legacy = [];
        for (const n of names) (isYYYYMM(n) ? canonical : legacy).push(n);
        // Descending chronological: 2025-12 > 2025-11 > ... > 2024-01
        canonical.sort((a,b) => {
          // Fast string compare works for YYYY-MM if both canonical and we want desc
          // but be explicit for clarity.
          const [ay,am] = a.split('-').map(Number);
          const [by,bm] = b.split('-').map(Number);
          if (ay !== by) return by - ay;
          return bm - am;
        });
        // legacy remains in original order (stable)
        return canonical.concat(legacy);
      }

      // Determine month label in YYYY-MM format, defaulting to current month
      function monthLabel(){
        const m = $('billMonth').value;
        if (m && /^\d{4}-(0[1-9]|1[0-2])$/.test(m)) return m;
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        return `${yyyy}-${mm}`;
      }

      function normalizeSheetNames(names){
        // Non-destructive: unique + lexicographic sort; do NOT filter legacy/non-YYYY-MM names.
        return Array.from(new Set(names))
          .sort((a,b)=>a.localeCompare(b));
      }

      function canonicalizeWorkbook(){
        const wb = getWB(); if(!wb) return;
        wb.SheetNames = normalizeSheetNames(
          (wb.SheetNames || []).filter(n => !!wb.Sheets[n])
        );
      }

      function fillSampleData(){
        Object.entries(SAMPLE).forEach(([id,val])=>{
          const el = $(id);
          el.value = val;
          if(el.type==='text' && !el.closest('#receiptCard')) parseInrInput(el);
        });
      }

      function prevMonthLabel(label){
        try{
          const [y,m] = String(label || '').split('-').map(n=>parseInt(n,10));
          if(!y || !m) return label;
          const d = new Date(y, m - 1, 1);
          d.setMonth(d.getMonth() - 1);
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth() + 1).padStart(2, '0');
          return `${yyyy}-${mm}`;
        }catch{ return label; }
      }

      function inWords(value){
        const a = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
        const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
        const num = Math.round(Number(value) || 0);
        if(num === 0) return 'Zero';
        const toWords = n => {
          if(n < 20) return a[n];
          const tens = Math.floor(n / 10);
          const ones = n % 10;
          return [b[tens], a[ones]].filter(Boolean).join(' ');
        };
        const parts = [];
        const crore = Math.floor(num / 1e7);
        const lakh = Math.floor(num / 1e5) % 100;
        const thousand = Math.floor(num / 1000) % 100;
        const hundred = Math.floor(num / 100) % 10;
        const rest = num % 100;
        if(crore) parts.push(toWords(crore) + ' Crore');
        if(lakh) parts.push(toWords(lakh) + ' Lakh');
        if(thousand) parts.push(toWords(thousand) + ' Thousand');
        if(hundred) parts.push(toWords(hundred) + ' Hundred');
        if(rest) parts.push(toWords(rest));
        return parts.join(' ').trim();
      }

      function enumerateSection(major, startMinor, items){
        let step = 0;
        return items.map(({ label, amount }) => {
          const code = `${major}.${String(startMinor + step).padStart(2,'0')}`;
          step += 1;
          return { code, label, amount };
        });
      }

      function buildSapLongText(model, billMonth){
        const prev = prevMonthLabel(billMonth);
        const creditExtras = (model.creditsExtras || []).filter(e=>e && e.include);
        const debitExtras = (model.debitsExtras || []).filter(e=>e && e.include);
        const finalExtras = (model.finalExtras || []).filter(e=>e && e.include);
        const amt = v => `${INR.format(Number(v || 0))}/-.`;
        const totalCreditAdj = Number(model.F16 || 0) + Number(model.G16 || 0);
        const totalDebit = Number(model.D24 || 0) + Number(model.E24 || 0) + Number(model.F24 || 0) + Number(model.F9 || 0) + Number(model.debitsExtrasTotal || 0);
        const balPrev = Number(model.E9 || 0) - Number(model.D9 || 0);
        const creditLinesSource = [
          { label:'Credit Board Charges', amount:model.A24 },
          { label:'Credit ED Charges', amount:model.B24 },
          { label:'Credit TDS', amount:model.C24 },
          ...creditExtras.map(extra=>{
            const name = (extra.label && extra.label.trim()) ? extra.label.trim() : 'Credits extra';
            return { label:`${name} (Credits extra)`, amount:extra.amount };
          }),
          ...finalExtras.map(extra=>{
            const name = (extra.label && extra.label.trim()) ? extra.label.trim() : 'Final adjustment extra';
            return { label:`${name} (Final adj. extra)`, amount:extra.amount };
          })
        ];
        const debitLinesSource = [
          { label:'Debit Board Charges', amount:model.D24 },
          { label:'Debit Electricity duty', amount:model.E24 },
          { label:'Debit Wheeling Charges', amount:model.F24 },
          { label:'Delayed Payment Charges', amount:model.F9 },
          ...debitExtras.map(extra=>{
            const name = (extra.label && extra.label.trim()) ? extra.label.trim() : 'Debits extra';
            return { label:`${name} (Debits extra)`, amount:extra.amount };
          })
        ];
        const creditLines = enumerateSection('3', 1, creditLinesSource).map(item=>`   ${item.code}. ${item.label}: ${amt(item.amount)}`);
        const debitLines = enumerateSection('4', 1, debitLinesSource).map(item=>`   ${item.code}. ${item.label}: ${amt(item.amount)}`);
        const lines = [
          'Long Text for SAP:',
          `Bill Certification for ${billMonth} as given below: -`,
          `1. Current Month Bill for ${billMonth}: ${amt(model.C9)}`,
          `2. Total credit adjustment of wind generation for ${prev} month: ${amt(totalCreditAdj)}`,
          '   Breakup of share of wind energy credit is as follows:',
          `   A. Share of 4.5MW WEG: ${amt(model.F16)}`,
          `   B. Share 14.7MW WEG: ${amt(model.G16)}`,
          '3. CREDIT ADJUSTMENT AMOUNT:',
          ...creditLines,
          `   Total Credit: ${amt(model.A26)}`,
          '4. DEBIT ADJUSTMENT AMOUNT:',
          ...debitLines,
          `   Total Debit: ${amt(totalDebit)}`,
          `6. Balance pending credit of Previous Month (if any) (=Freeze Amount - Out Standing Arrear): ${amt(balPrev)}`,
          `7. Final Bill (=Current Month Bill + Debit Adjustment - Credit Adjustment - Balance pending credit of Previous Month): ${amt(model.FINAL)}`,
          ''
        ];
        const finalAmt = Number(model.FINAL || 0);
        lines.push(`Rupees ${inWords(finalAmt)} Only`);
        return lines.join('\n');
      }
  // Basic menu behavior for <details>-based dropdowns
  document.addEventListener('click', (e) => {
    const openMenus = document.querySelectorAll('.menu details[open]');
    for (const d of openMenus) {
      if (!d.contains(e.target)) d.removeAttribute('open');
    }
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const open = document.querySelector('.menu details[open]');
      if (open) { open.removeAttribute('open'); open.querySelector('summary')?.focus(); }
    }
  });
  document.querySelectorAll('.menu details').forEach(d => {
    d.addEventListener('toggle', () => {
      if (d.open) {
        const panel = d.querySelector('.menu-panel');
        // Flip up if panel would overflow the viewport bottom
        if (panel) {
          panel.classList.remove('drop-up');
          const rect = panel.getBoundingClientRect();
          const overflowsBottom = rect.bottom > window.innerHeight - 8;
          if (overflowsBottom) panel.classList.add('drop-up');
        }
        const items = Array.from(d.querySelectorAll(
          '.menu-panel [role="menuitem"], .menu-panel [role="menuitemcheckbox"]'
        ));
        items.forEach((el,i)=> el.tabIndex = i===0 ? 0 : -1);
        items[0]?.focus();
      }
    });
  });
  // Re-evaluate placement on resize
  window.addEventListener('resize', () => {
    const open = document.querySelector('.menu details[open]');
    if (!open) return;
    const panel = open.querySelector('.menu-panel');
    if (!panel) return;
    panel.classList.remove('drop-up');
    const rect = panel.getBoundingClientRect();
    if (rect.bottom > window.innerHeight - 8) panel.classList.add('drop-up');
  });

  // Roving tabindex + arrow key nav inside menus
  document.addEventListener('keydown', (e) => {
    const open = document.querySelector('.menu details[open]');
    if (!open) return;
    const items = Array.from(open.querySelectorAll('.menu-panel [role="menuitem"], .menu-panel [role="menuitemcheckbox"]'));
    if (!items.length) return;
    const i = items.indexOf(document.activeElement);
    const move = (to) => { items.forEach(el=>el.tabIndex=-1); items[to].tabIndex=0; items[to].focus(); };
    if (e.key === 'ArrowDown') { e.preventDefault(); move(Math.min(items.length-1, i<0?0:i+1)); }
    if (e.key === 'ArrowUp')   { e.preventDefault(); move(Math.max(0, i<=0?0:i-1)); }
    if (e.key === 'Home')      { e.preventDefault(); move(0); }
    if (e.key === 'End')       { e.preventDefault(); move(items.length-1); }
    if (e.key === 'Enter' || e.key === ' ') {
      const el = document.activeElement;
      if (!el) return;
      const role = el.getAttribute('role');
      if (role === 'menuitemcheckbox') {
        const input = el.querySelector('input[type="checkbox"]');
        if (input) { e.preventDefault(); input.click(); }
      } else {
        // Activate any focused menuitem, not just <button>.
        e.preventDefault();
        el.click();
      }
    }
  });

  // ---------------- Sheets menu wiring ----------------
  function renderSheetMenu(filter=''){
    const list = document.getElementById('sheetMenuList');
    if(!list) return;
    list.textContent = '';
    const wb = getWB(); if(!wb) return;
    const names = sortDisplayNames(wb.SheetNames || []);
    const q = filter.trim().toLowerCase();
    const rows = q ? names.filter(n=>n.toLowerCase().includes(q)) : names;
    rows.forEach((name, idx) => {
      const row = document.createElement('div');
      row.className = 'sheet-menu-item';
      row.setAttribute('role','menuitem');
      row.tabIndex = idx===0 ? 0 : -1;
      row.dataset.name = name;
      const nameSpan = document.createElement('span');
      nameSpan.textContent = name;
      row.appendChild(nameSpan);
      const delBtn = document.createElement('button');
      delBtn.className = 'ghost del';
      delBtn.setAttribute('aria-label', 'Remove '+name);
      delBtn.title = 'Remove';
      delBtn.textContent = '&times;';
      row.appendChild(delBtn);
      row.addEventListener('click', (e) => {
        if (e.target && e.target.classList && e.target.classList.contains('del')) return;
        const mm = /^\d{4}-(0[1-9]|1[0-2])$/.test(name) ? name : null;
        if (mm) document.getElementById('billMonth').value = mm;
        else toast('Sheet "'+name+'" isn&rsquo;t a YYYY-MM label. Month picker left unchanged.','info');
        compute();
        const d = document.getElementById('sheetsMenu');
        if (d && d.hasAttribute('open')) d.removeAttribute('open');
        const strip = document.getElementById('sheetList');
        if (strip && strip.offsetParent) {
          const match = Array.from(document.querySelectorAll('#sheetList [role="option"]'))
            .find(p=> p.querySelector('.ghost') && p.querySelector('.ghost').textContent === name);
          if(match) match.focus();
        }
      });
      delBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const ok = await confirmModal('Remove sheet "'+name+'" from the workbook?');
        if(!ok) return;
        const w = getWB(); if(!w) return;
        delete w.Sheets[name];
        w.SheetNames = (w.SheetNames || []).filter(n=>n!==name);
        canonicalizeWorkbook();
        toast('Removed sheet: '+name, 'good');
        refreshSheetList();
        const searchVal = (document.getElementById('sheetSearch')||{}).value || '';
        renderSheetMenu(searchVal);
        const items = Array.from(document.querySelectorAll('#sheetMenuList [role="menuitem"]'));
        (items[idx] || items[idx-1])?.focus();
      });
      list.appendChild(row);
    });
    if (!list.children.length){
      const empty = document.createElement('div');
      empty.className = 'sheet-menu-item';
      empty.textContent = 'No sheets';
      empty.tabIndex = 0;
      list.appendChild(empty);
    }
  }

  const sheetsDetails = document.getElementById('sheetsMenu');
  if (sheetsDetails instanceof HTMLDetailsElement) {
    sheetsDetails.addEventListener('toggle', () => {
      if (sheetsDetails.open){
        const s = document.getElementById('sheetSearch');
        renderSheetMenu('');
        // After paint, move focus into the search box
        requestAnimationFrame(()=>{ if (s) s.focus(); });
      }
    });
  }

  const sheetSearchInput = document.getElementById('sheetSearch');
  if (sheetSearchInput) {
    sheetSearchInput.addEventListener('input', (e)=>{
      const val = e.target && e.target.value ? e.target.value : '';
      renderSheetMenu(val);
    });
  }

  // Sheets menu: only handle Delete key (generic handler covers nav + activation)
  document.addEventListener('keydown', (e)=>{
    const open = document.querySelector('#sheetsMenu[open]');
    if(!open) return;
    const items = Array.from(document.querySelectorAll('#sheetMenuList [role="menuitem"]'));
    if(!items.length) return;
    const i = items.indexOf(document.activeElement);
    if (e.key==='Delete' && i>=0){
      e.preventDefault();
      const del = items[i].querySelector('.del');
      if(del) del.click();
    }
  });

  // Sync aria-checked on menuitemcheckbox rows
  function syncMenuCheckboxAria(root=document){
    root.querySelectorAll('[role="menuitemcheckbox"]').forEach(row=>{
      const cb = row.querySelector('input[type="checkbox"]');
      if (!cb) return;
      row.setAttribute('aria-checked', cb.checked ? 'true' : 'false');
      cb.addEventListener('change', ()=> row.setAttribute('aria-checked', cb.checked ? 'true' : 'false'));
    });
  }
  syncMenuCheckboxAria();
  document.querySelectorAll('.menu details').forEach(d=>{
    d.addEventListener('toggle', ()=> { if (d.open) syncMenuCheckboxAria(d); });
  });

      document.addEventListener('DOMContentLoaded', () => {
      initRatesManager();
      // Apply INR masking and numeric guards
      document.querySelectorAll('input').forEach(el=>{
        if(isConfigInput(el)) return;
        if(el.type==='text' && !el.closest('#receiptCard')){
          el.addEventListener('input', ()=>{ parseInrInput(el,false); compute(); });
          el.addEventListener('blur', ()=>parseInrInput(el));
        }else if(el.type==='number'){
          el.addEventListener('keydown', (e)=>{
            if(e.key==='e' || e.key==='E'){
              e.preventDefault();
              showSciHint(el);
              el.dataset.sci='1';
            }
          });
          el.addEventListener('input', ()=>{ parseInrInput(el,false); compute(); });
          el.addEventListener('blur', ()=>parseInrInput(el,false));
        }else{
          el.addEventListener('input', compute);
        }
      });

      ['B15','D15','C16'].forEach(id=>{
        const el=$(id); if(!el) return;
        el.addEventListener('blur', ()=>{
          let v = parseFloat(el.value);
          if(Number.isFinite(v)){
            if(v<0) v=0; if(v>100) v=100;
            el.value = v; el.dataset.value = v;
          }
          compute();
        });
      });

      $('addSheet').addEventListener('click', () => withBusy('addSheet', async () => {
        if (!(await loadXLSX())) return;
        const _wb = getWB(); if(!_wb) return;
        const model = compute(true);
        if (!model) { toast('Fix highlighted inputs before adding the month sheet.', 'warn'); return; }
        const label = monthLabel();
        const ws = buildSheetData(model, label);
        const exists = _wb.SheetNames.includes(label);
        _wb.Sheets[label] = ws;
        if (!exists) _wb.SheetNames.push(label);
        canonicalizeWorkbook();
        toast(`${exists ? 'Updated' : 'Added'} sheet: ${label}`, 'good');
        refreshSheetList();
      }));

      let __dlInFlight = false;
      $('downloadExcel').addEventListener('click', () => withBusy('downloadExcel', async () => {
        if (__dlInFlight) return;
        __dlInFlight = true;
        try{
          if (!(await loadXLSX())) return;
        const _wb = getWB(); if(!_wb) return;
        const auto = $('autoUpdateOnDownload')?.checked;

        if (auto) {
          const model = compute(true);
          if (!model) { toast('Cannot download: fix inputs first.', 'warn'); return; }
          const label = monthLabel();
          const ws = buildSheetData(model, label);
          const exists = _wb.SheetNames.includes(label);
          _wb.Sheets[label] = ws;
          if(!exists) _wb.SheetNames.push(label);
        }

        canonicalizeWorkbook();
        if ((_wb.SheetNames?.length || 0) === 0) {
          toast('No sheets to download. Turn on auto&#8209;update or add a month sheet first.', 'warn');
          return;
        }

        XLSX.writeFile(_wb, `WEG_Billing_${monthLabel()}.xlsx`);
        toast('Workbook downloaded.', 'good');
        } finally { __dlInFlight = false; }
      }));

        // IOM PDF download feature removed

      // Centralize busy-state toggling to avoid drift
      function setBusy(el, on){
        if(!el) return;
        el.setAttribute('aria-busy', on ? 'true' : 'false');
      }
      // Ensure print flows always recover even if 'afterprint' is not fired by the browser
      function onPrintLifecycle({ host, reenable }) {
        let done = false;
        const finish = () => {
          if (done) return;
          done = true;
          try { document.documentElement.classList.remove('print-rcpt'); } catch(_) {}
          try { setBusy(host, false); } catch(_) {}
          try { reenable?.(); } catch(_) {}
          window.removeEventListener('afterprint', finish, { once: true });
          window.removeEventListener('focus', finish, { once: true });
          document.removeEventListener('visibilitychange', onVis, { once: true });
        };
        const onVis = () => { if (document.visibilityState === 'visible') finish(); };
        window.addEventListener('afterprint', finish, { once: true });
        window.addEventListener('focus', finish, { once: true });
        document.addEventListener('visibilitychange', onVis, { once: true });
        // safety net (some environments never emit any of the above)
        setTimeout(finish, 10000);
        return finish;
      }

      const btnRender = document.getElementById('renderHtml');
      const btnSave = document.getElementById('saveHtmlPdf');
      const btnOpen = document.getElementById('openHtmlPdf');
      const chkAuto = document.getElementById('autoPrintHtml');
      const setDisabled = (el, on) => {
        if (!el) return;
        el.disabled = !!on;
        if (on) el.setAttribute('aria-disabled', 'true');
        else el.removeAttribute('aria-disabled');
      };
      const disablePrintActions = () => {
        setDisabled(btnSave, true);
        setDisabled(btnOpen, true);
      };
      disablePrintActions();

      function monthLabelStr(){
        const m = document.getElementById('billMonth')?.value;
        if (m && /^\d{4}-(0[1-9]|1[0-2])$/.test(m)) return m;
        const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      }

      if (btnRender) btnRender.addEventListener('click', () => withBusy('renderHtml', async () => {
        const host = document.getElementById('htmlPrintHost');
        if (!host) return;
        if (host.getAttribute('aria-busy') === 'true') {
          toast('Preview is busy, please wait&hellip;', 'info');
          return;
        }
        try {
          setBusy(host, true);
          setDisabled(btnRender, true);
          const model = compute(true);
          if (!model) {
            setBusy(host, false);
            if (typeof disablePrintActions === 'function') disablePrintActions();
            toast('Fix highlighted inputs before rendering.', 'warn');
            return;
          }
          renderHtmlPreview(model, monthLabelStr(), new Date().toLocaleString());
          const hasPreview = !!document.querySelector('#htmlPrintHost .sheet'); // true if preview exists
          setDisabled(btnSave, !hasPreview);
          setDisabled(btnOpen, !hasPreview);
          if (chkAuto?.checked) {
            // Ensure layout has painted; recompute scale and set print guard
            requestAnimationFrame(() => setTimeout(() => {
              try{
                document.documentElement.classList.add('print-iom');
                const sheet = document.querySelector('#htmlPrintHost .sheet.iom') || document.querySelector('#htmlPrintHost .sheet');
                if (sheet && typeof setIomPrintScaleIfNeeded === 'function') setIomPrintScaleIfNeeded(sheet);
                window.addEventListener('afterprint', () => {
                  document.documentElement.classList.remove('print-iom');
                }, { once:true });
              }catch(_){ }
              window.print();
            }, 100));
          }
        } finally {
          setBusy(host, false);
          setDisabled(btnRender, false);
        }
      }));

      if (btnSave) btnSave.addEventListener('click', () => {
        const host = document.getElementById('htmlPrintHost');
        if (!host) { toast('Please render a preview first.', 'warn'); return; }
        if (host.getAttribute('aria-busy') === 'true') { toast('Preview is busy, please wait&hellip;', 'info'); return; }
        if (!host.querySelector('.sheet')) {
          toast('Please render a preview first.', 'warn');
          return;
        }
        document.documentElement.classList.add('print-rcpt');
        prunePrintSheets(host);
        // prevent re-entrancy while printing
        setDisabled(btnSave, true);
        setDisabled(btnOpen, true);
        setBusy(host, true);
        onPrintLifecycle({
          host,
          reenable: () => {
            setDisabled(btnSave, false);
            setDisabled(btnOpen, false);
          }
        });
        // Ensure scale is correct: use IOM fit for IOM sheets, receipt fit otherwise.
        try {
          const sheet = host.querySelector('.sheet.iom') || host.querySelector('.sheet');
          const isIom = !!(sheet && sheet.classList.contains('iom'));
          if (isIom) {
            document.documentElement.classList.add('print-iom');
            window.addEventListener('afterprint', () => {
              document.documentElement.classList.remove('print-iom');
            }, { once: true });
          }
          const fontsReady = (document.fonts && document.fonts.ready) ? document.fonts.ready : Promise.resolve();
          fontsReady
            .then(() => new Promise(r => requestAnimationFrame(r)))
            .then(() => {
              try {
                if (sheet) {
                  if (isIom && typeof setIomPrintScaleIfNeeded === 'function') {
                    setIomPrintScaleIfNeeded(sheet);
                  } else if (!isIom && typeof setRcptPrintScaleIfNeeded === 'function') {
                    setRcptPrintScaleIfNeeded(sheet);
                  }
                }
              } catch(_) {}
              try { window.focus(); } catch {}
              prunePrintSheets(host);
              window.print();
            });
        } catch(_) {
          // Fallback: Use immediate print on error
          window.print();
        }
      });

      // Proxy menu action for Save as PDF; Open PDF is bound separately
      document.getElementById('menuSavePdf')?.addEventListener('click', () => {
        document.getElementById('saveHtmlPdf')?.click();
      });

      // Re-disable print actions if inputs change after a render
      document.querySelectorAll('input, select, textarea').forEach(el => {
        el.addEventListener('input', disablePrintActions, { passive: true });
        el.addEventListener('change', disablePrintActions, { passive: true });
      });

      // Also disable on programmatic mutations triggered by toolbar actions
      ['resetSample','resetAll','addSheet','clearSheets'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('click', disablePrintActions);
      });

      $('uploadExcel').addEventListener('click', () => withBusy('uploadExcel', async () => {
        if (!(await loadXLSX())) return;
        $('uploadXlsx').click();
      }));
      $('uploadXlsx').addEventListener('change', e => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async ev => {
          try{
            const _wb = getWB(); if(!_wb) return;
            const data = new Uint8Array(ev.target.result);
            const wb = XLSX.read(data, {type:'array'});
            let added = 0, replaced = 0;
            const toReplace = [];
            for(const name of wb.SheetNames){
              if (_wb.SheetNames.includes(name)){
                const ok = await confirmModal(`Sheet "${name}" exists. Replace it?`);
                if (ok) toReplace.push(name);
              }else{
                _wb.Sheets[name] = wb.Sheets[name];
                _wb.SheetNames.push(name);
                added++;
              }
            }
            for(const name of toReplace){
              _wb.Sheets[name] = wb.Sheets[name];
              if(!_wb.SheetNames.includes(name)) _wb.SheetNames.push(name);
              replaced++;
            }
            canonicalizeWorkbook();
            toast(`Workbook merged: ${added} added, ${replaced} replaced.`, 'good');
            refreshSheetList();
            if (typeof disablePrintActions === 'function') disablePrintActions();
          }catch(err){
            console.error(err);
            toast('Upload failed','bad');
          }finally{
            e.target.value='';
          }
        };
        reader.onerror = err=>{ console.error(err); toast('Upload failed','bad'); e.target.value=''; };
        reader.readAsArrayBuffer(file);
      });

      $('clearSheets').addEventListener('click', async () => {
        if(!(await confirmModal('Remove ALL sheets from the workbook?'))) return;
        const wb = getWB(); if(!wb) return;
        (wb.SheetNames || []).forEach(n => delete wb.Sheets[n]);
        wb.SheetNames = [];
        canonicalizeWorkbook();
        toast('All sheets cleared.', 'good');
        refreshSheetList();
      });

      $('resetAll').addEventListener('click', ()=>{
        document.querySelectorAll('input').forEach(el=>{
          if(isConfigInput(el)) return;
          if(el.type!=="month"){
            el.value='';
            el.dataset.value='';
          }
        });
        compute();
      });

      $('resetSample').addEventListener('click', ()=>{
        fillSampleData();
        const m = compute(true);
        console.assert(m.A9 === 14350, `A9 expected 14350, got ${m.A9}`);
        console.assert(m.C9 === 17220, `C9 expected 17220, got ${m.C9}`);
        console.assert(Math.round(m.FINAL) === 16700, `FINAL expected 16700, got ${m.FINAL}`);
      });

(function(){
        const genBtn = $('genSapText');
        if(genBtn){
          genBtn.addEventListener('click', () => {
            const model = compute(true);
            if (!model) { toast('Fix highlighted inputs before generating long text.', 'warn'); return; }
            const label = monthLabel();
            const txt = buildSapLongText(model, label);
            const ta = $('sapText');
            ta.value = txt;
            ta.focus();
            ta.select();
          });
        }
      })();

      (function(){
        const copyBtn = $('copySapText'); if(!copyBtn) return;
        copyBtn.addEventListener('click', async () => {
          const ta = $('sapText');
          ta.focus();
          ta.select();
          try {
            await navigator.clipboard.writeText(ta.value);
          } catch {
            try { document.execCommand('copy'); } catch(_) {}
          }
          toast('Long text copied.', 'good');
        });
      })();

      loadExtras();
      const restored = restore();
      initConfigurationPanel();
      compute();
      refreshSheetList();
      if(restored) toast('Previous data restored.');
    });
  </script>
  <script>
    // Read a money value from a view cell by ID (strips currency and commas)
    window.readMoneyById = function(id){
      const el = document.getElementById(id);
      if(!el) return 0;
      const raw = el.textContent || '';
      const n = parseFloat(raw.replace(/[^0-9.\-]/g,''));
      return Number.isFinite(n) ? n : 0;
    };

    // Initialize defaults for Central Dak Receipt inputs
    window.addEventListener('DOMContentLoaded', () => {
      const ids = ['rc_vendorCode','rc_vendorName','rc_billNo','rc_billDate','rc_eic','rc_amount'];
      const editing = new Set();
      ids.forEach(id => {
        const el = document.getElementById(id);
        if(!el) return;
        el.addEventListener('input', () => {
          if(el.value.trim() === '') editing.delete(id); else editing.add(id);
          if(id === 'rc_amount' && el.value.trim() === '') setAmount();
          if(id === 'rc_vendorCode') defaultBillNo();
          if(id === 'rc_billNo') el.dataset.autogen = '0'; // user took control
        }, {passive:true});
      });

      function computeAmount(){
        const C9  = readMoneyById('C9v');
        const F16 = readMoneyById('F16v');
        const G16 = readMoneyById('G16v');
        const C24 = readMoneyById('C24v');
        const A31 = readMoneyById('A31v');
        const F9  = readMoneyById('F9v');
        return C9 - F16 - G16 - C24 + A31 + F9;
      }

      function setAmount(){
        const el = document.getElementById('rc_amount');
        if(!el) return;
        if(editing.has('rc_amount') && el.value.trim() !== '') return;
        const amt = computeAmount();
        el.value = String(amt);
        parseInrInput(el);
      }

      function defaultText(el, val){
        if(!el || editing.has(el.id) || el.value.trim()) return;
        el.value = val;
      }

      function defaultBillNo(){
        const el = document.getElementById('rc_billNo');
        const vc = document.getElementById('rc_vendorCode');
        if(!el || editing.has('rc_billNo')) return;
        const now = new Date();
        const YYYY = now.getFullYear();
        const MM = String(now.getMonth()+1).padStart(2,'0');
        const DD = String(now.getDate()).padStart(2,'0');
        const HH = String(now.getHours()).padStart(2,'0');
        const mm = String(now.getMinutes()).padStart(2,'0');
        const vendor = vc?.value || 'NA';
        const next = `DAK-${vendor || 'NA'}-${YYYY}${MM}${DD}-${HH}${mm}`;
        const isAuto = el.dataset.autogen === '1';
        // Generate if empty OR previously auto-generated; preserve if user-edited
        if(!el.value.trim() || isAuto){
          el.value = next;
          el.dataset.autogen = '1';
        }
      }

      function defaultDate(){
        const el = document.getElementById('rc_billDate');
        if(!el || (editing.has('rc_billDate') && el.value.trim())) return;
        if(!el.value.trim()){
          const now = new Date();
          const dd = String(now.getDate()).padStart(2,'0');
          const mm = String(now.getMonth()+1).padStart(2,'0');
          const yyyy = now.getFullYear();
          el.value = `${dd}-${mm}-${yyyy}`;
        }
      }

      function attachDateShim(){
        const el = document.getElementById('rc_billDate');
        if(!el) return;
        el.addEventListener('focus', () => {
          const v = el.value.trim();
          let iso = '';
          if(validDDMMYYYY(v)){
            const [d,m,y] = v.split('-');
            iso = `${y}-${m}-${d}`;
          }
          el.type = 'date';
          if(iso) el.value = iso;
        });
        const restore = () => {
          const v = el.value.trim();
          el.type = 'text';
          if(/^\d{4}-\d{2}-\d{2}$/.test(v)){
            const [y,m,d] = v.split('-');
            el.value = `${d}-${m}-${y}`;
          }
          const ok = validDDMMYYYY(el.value.trim());
          el.classList.toggle('warn', !ok && el.value.trim() !== '');
        };
        el.addEventListener('blur', restore);
        el.addEventListener('change', restore);
      }

      function initReceiptDefaults(){
        const vc = document.getElementById('rc_vendorCode');
        const vn = document.getElementById('rc_vendorName');
        const eic = document.getElementById('rc_eic');
        const cfg = window.appConfig || {};
        defaultText(vc, cfg.vendor_code || 'ZG0435');
        defaultText(vn, cfg.vendor_name || 'Paschim Gujarat Vij Company Ltd');
        defaultText(eic, cfg.eic_name || 'Vijendra Singh');
        defaultBillNo(); // will mark dataset.autogen='1' on first generation
        defaultDate();
        setAmount();
      }

      window.initReceiptDefaults = initReceiptDefaults;

      attachDateShim();
      initReceiptDefaults();
      window.addEventListener('receipt:refresh', initReceiptDefaults);

      let amtTimer = null;
      function scheduleAmount(){
        if(editing.has('rc_amount') && document.getElementById('rc_amount')?.value.trim() !== '') return;
        clearTimeout(amtTimer);
        amtTimer = setTimeout(setAmount, 100);
      }

      const srcIds = ['C9v','F16v','G16v','C24v','A31v','F9v'];
      const observer = new MutationObserver(scheduleAmount);
      srcIds.forEach(id => {
        const el = document.getElementById(id);
        if(el) observer.observe(el, {childList:true,subtree:true,characterData:true});
      });
    });
  </script>
  <script>
    // Open the current IOM sheet in a popup with single-page A4 fit
    function openIomPdfView(){
      const host = document.getElementById('htmlPrintHost');
      let sheet = host?.querySelector('.sheet');
      if(!sheet){
        try{ (window.renderHtml || window.renderHtmlPreview || window.renderHtml)?.(); }catch(_){ }
        sheet = document.getElementById('htmlPrintHost')?.querySelector('.sheet');
      }
      if(!sheet){ try{ toast('No IOM to print. Click &ldquo;Render IOM&rdquo; first.', 'bad'); }catch(_){ } return; }
      // Guarantee IOM scoping for popup rules (even if host forgot to tag)
      sheet.classList.add('iom');

      // Popup CSS: A4 page with dynamic --iom-scale and full IOM structure
      const css =
        `@page{size:A4;margin:12mm}`+
        `html,body{height:100%}`+
        `body{margin:0;background:#fff;color:#000;font:14px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}`+
        `:root{--iom-scale:1}`+
        `.sheet.iom{box-shadow:none;margin:0;`+
        ` transform:scale(var(--iom-scale));transform-origin:top left;`+
        ` width:calc(210mm / var(--iom-scale));min-height:auto;`+
        ` padding:12mm 14mm;`+
        ` -webkit-print-color-adjust:exact;print-color-adjust:exact}`+
        /* structure & typography parity with main IOM */
        `.doc-header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:4mm}`+
        `.doc-header h2{margin:1mm 0 0;font-size:18pt}`+
        `.doc-meta{color:#555;font-size:10.5pt;text-align:right}`+
        `.info-bar{background:#f3f4f6;border:1px solid #e5e7eb;padding:2mm 4mm;margin-bottom:6mm;font-size:10.5pt;white-space:normal;overflow:visible;text-overflow:clip;overflow-wrap:anywhere;word-break:break-word}`+
        `.sec{break-inside:avoid;margin:5mm 0 0}`+
        `.sec h3{margin:0 0 3mm;font-size:12pt;border-bottom:1px solid #ddd;padding-bottom:2.5mm}`+
        `.kv{display:grid;grid-template-columns:1fr minmax(52mm,auto) 10mm;gap:2mm;padding:2mm 0;border-bottom:1px dashed #eee}`+
        `.kv .label{color:#374151;overflow-wrap:anywhere;word-break:break-word}`+
        `.kv .value{font-weight:600;text-align:right;font-variant-numeric:tabular-nums}`+
        `.kv .unit{color:#6b7280;text-align:right}`+
        `.kv .value.total{font-weight:800}`+
        `.mapping .kv:last-child{background:#f3f4f6;border:1px solid #e5e7eb}`+
        `.total{font-weight:700}`+
        `.signatures{break-inside:avoid}`+
        `.sigs{display:grid;grid-template-columns:1fr 1fr;gap:4mm;margin-top:4mm}`+
        `.sig{text-align:left}`+
        `.sig.right{text-align:right}`+
        `.sig .line{border-top:1px solid #d1d5db;height:0;margin:10mm 0 2mm}`+
        `.sig .role{color:#111;font-weight:600}`+
        `.footer-note{margin-top:6mm;color:#6b7280;font-size:9.5pt}`+
        `.page-number{position:absolute;bottom:6mm;right:18mm;color:#6b7280;font-size:9pt}`;

      // Compute scale inside the popup to fit one A4 page
      const script =
        `(function(){`+
        `  function mmToPx(mm){var d=document.createElement('div');d.style.height=mm+"mm";d.style.position='absolute';d.style.visibility='hidden';document.body.appendChild(d);var px=d.getBoundingClientRect().height||0;d.remove();return px;}`+
        `  function fit(){var s=document.querySelector('.sheet.iom');if(!s) return;`+
        `    var pagePx=mmToPx(297); var h=s.getBoundingClientRect().height||0;`+
        `    if(pagePx>0 && h>pagePx){ var scale=Math.max(0.88, Math.min(0.98, pagePx/h));`+
        `      document.documentElement.style.setProperty('--iom-scale', String(scale)); }}`+
        `  function doPrint(){try{window.focus();window.print();}catch(e){}}`+
        `  window.addEventListener('load', function(){`+
        `    var p = (document.fonts && document.fonts.ready) ? document.fonts.ready : Promise.resolve();`+
        `    p.then(function(){ fit(); requestAnimationFrame(function(){ setTimeout(doPrint,150); }); });`+
        `  });`+
        `})();`;

      const month = (host.dataset && host.dataset.monthLabel) ? ` &ndash; ${host.dataset.monthLabel}` : '';
      const html =
        `<!doctype html><html><head><meta charset="utf-8"><meta name="color-scheme" content="light"><title>IOM - HT Bill${month}</title><style>${css}</style></head>`+
        `<body>${sheet.outerHTML}<script>${script}<\/script></body></html>`;
      try {
        const w = window.open('', '_blank', 'noopener,noreferrer');
        if (w) { w.document.open(); w.document.write(html); w.document.close(); return; }
      } catch(_) { /* fall through */ }
      try {
        const blob = new Blob([html], {type:'text/html'});
        const url = URL.createObjectURL(blob);
        const w2 = window.open(url, '_blank', 'noopener,noreferrer');
        setTimeout(() => URL.revokeObjectURL(url), 1000);
        if (!w2) { try{ toast('Popup blocked. Allow popups or use &ldquo;Save as PDF&rdquo;.', 'warn'); }catch{ alert('Popup blocked. Allow popups or use &ldquo;Save as PDF&rdquo;.'); } }
      } catch(e) {
        try{ toast('Could not open print view: ' + (e?.message||e), 'bad'); }catch{ alert('Could not open print view: ' + (e?.message||e)); }
      }
    }

    // Wire menu and button once DOM is ready
    window.addEventListener('DOMContentLoaded', ()=>{
      const menuOpen = document.getElementById('menuOpenPdf');
      if (menuOpen && !menuOpen.dataset.iomBound) {
        menuOpen.dataset.iomBound = '1';
        menuOpen.addEventListener('click', (e)=>{ e.preventDefault(); openIomPdfView(); });
      }
      const openBtn = document.getElementById('openHtmlPdf');
      if (openBtn && !openBtn.dataset.iomBound) {
        openBtn.dataset.iomBound = '1';
        openBtn.addEventListener('click', (e)=>{ e.preventDefault(); openIomPdfView(); });
      }
    });
  </script>
  <style id="print-guard-receipt">
  @media print{
    /* Hide chrome; keep rendered sheet visible */
    header, .toolbar, .card:not(.sheet), #toasts, .ui { display:none !important; }
    #htmlPrintHost { display:block !important; }
    /* Base sheet rules for print host (neutral) */
    #htmlPrintHost .sheet{
      display:block !important; border:none; width:auto; min-height:auto; margin:0;
      padding:0 0 16mm 0; break-inside:avoid;
      -webkit-print-color-adjust:exact; print-color-adjust:exact;
    }
    /* RECEIPT-ONLY tightening to prevent fractional overflow */
    #htmlPrintHost .sheet.receipt,
    #htmlPrintHost .sheet.rcpt{
      width:210mm;                     /* explicit page width */
      min-height:auto;                 /* override 297mm from base .sheet */
      max-height: calc(297mm - 14mm - 14mm); /* clamp to printable area height */
      margin:0;                        /* no extra outer margins */
      padding:0;                        /* no internal padding; footer is absolutely positioned */
      box-sizing:border-box;
      page-break-inside:avoid;         /* avoid UA splitting */
      break-inside:avoid;
      overflow:hidden;                 /* clip sub-pixel overflow */
    }
    /* Hide optional receipt footers that can push content */
    #htmlPrintHost .sheet.receipt .page-number,
    #htmlPrintHost .sheet.receipt .footer-note,
    #htmlPrintHost .sheet.rcpt .page-number,
    #htmlPrintHost .sheet.rcpt .footer-note { display:none !important; }
    /* Proper page breaks for multi-sheet prints (if any)
       Anchor the break to the following sheet to avoid false positives
       when non-sheet siblings (or stray nodes) follow the last sheet. */
    #htmlPrintHost > .sheet ~ .sheet { break-before: page; page-break-before: always }
    @page{ size:A4; margin:14mm }
  }
  </style>
  <script>
    // Fit receipt to a single A4 page with a modest scale only if needed (&le; 10%)
    if (typeof window.setRcptPrintScaleIfNeeded !== 'function') {
      window.setRcptPrintScaleIfNeeded = function(sheet){
        try{
          // Convert 297mm to px in this document
          const mmToPx = mm => {
            const d = document.createElement('div');
            d.style.height = mm + 'mm';
            d.style.position = 'absolute';
            d.style.visibility = 'hidden';
            document.body.appendChild(d);
            const px = d.getBoundingClientRect().height || 0;
            d.remove();
            return px;
          };
          const pagePx = mmToPx(297 - 14*2); // account for @page margin 14mm top/bottom
          const h = sheet.getBoundingClientRect().height || 0;
          if (h > pagePx){
            // Slight safety margin to avoid rounding overflow that can cause a blank trailing page
            const fudge = 0.998;
            const scale = Math.max(0.90, Math.min(1, (pagePx / h) * fudge));
            document.documentElement.style.setProperty('--rcpt-scale', String(scale));
          }
        }catch(_){ }
      };
    }
  </script>
  <style>
    /* Apply tiny scale only when printing receipt */
    html.print-rcpt #htmlPrintHost .sheet.receipt,
    html.print-rcpt #htmlPrintHost .sheet.rcpt{
      transform: scale(var(--rcpt-scale, 1));
      transform-origin: top left;
      width: calc(210mm / var(--rcpt-scale, 1));
      min-height:auto;
    }
  </style>
  <!-- Chart.js (pinned with SRI; keep fallback sparkline if unavailable) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"
          integrity="sha384-OdZ7mnmcJBFsRlPOjIvfl0lFLABPKyoU0tSjH8j+BgvUqQoRscY6hn00IP42BE8C"
          crossorigin="anonymous"></script>
  <script>
    (()=>{
      // ---- helpers ---------------------------------------------------------
      function normalizeNumber(raw){
        if (raw == null) return 0;
        if (typeof raw === 'number') return Number.isFinite(raw) ? raw : 0;
        const s = String(raw).replace(/[^0-9.+-]/g, ''); // drop &#8377;, commas, units
        const n = parseFloat(s);
        return Number.isFinite(n) ? n : 0;
      }
      const fmtINR = new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR'});
      const fmt0  = new Intl.NumberFormat('en-IN',{maximumFractionDigits:0});
      const fmt2  = new Intl.NumberFormat('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});
      // Rates (&#8377;/kWh) should be numeric, not currency:
      const fmtRate = new Intl.NumberFormat('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});

      // Load authoritative cell map; warn once if missing or invalid then fall back
      if(typeof fetch === 'function'){
        const warnOnce = msg => {
          if(!window.__analysisMapWarned){
            console.warn(msg);
            window.__analysisMapWarned = true;
          }
        };
        fetch('analysis-cell-map.json')
          .then(r=>r.json())
          .then(j=>{
            if(window.validateAnalysisCellMap && !window.validateAnalysisCellMap(j)){
              warnOnce('[analysis] invalid map; using legacy');
              return;
            }
            if(Array.isArray(j.mismatches) && j.mismatches.length){
              const details = j.mismatches.map(m=>{
                if(m && typeof m === 'object' && 'field' in m){
                  return `${m.field}: expected ${m.expected_cell ?? '?'} &rarr; ${m.actual_cell ?? '?'}`;
                }
                return '[invalid mismatch entry]';
              }).join('; ');
              warnOnce(`[analysis] map loaded with mismatches &rarr; ${details}`);
            }
            window.__analysisCellMap = j;
          })
          .catch(()=>{ warnOnce('[analysis] map missing; using legacy cell addresses'); });
      }
      // Canonical layout: B=FIELD, C=CELL, D=values, E=UNITS/NOTES (ignored)
      function buildCellMap(ws){
        try{
          if(ws.__cellMap) return ws.__cellMap;
          const ref = XLSX.utils.decode_range(ws['!ref'] || 'A1:Z500');
          let headerRow = -1, colCell = -1, colVal = -1;
          // 1) Find header row and the column containing "CELL"
          for(let R=0; R<=Math.min(ref.e.r, 50); R++){
            for(let C=0; C<=Math.min(ref.e.c, 16); C++){
              const cell = ws[XLSX.utils.encode_cell({r:R,c:C})];
              if(cell && String(cell.v).trim().toUpperCase() === 'CELL'){
                headerRow = R; colCell = C;
                // Numeric values are the column immediately to the right of CELL.
                colVal = C + 1;
                break;
              }
            }
            if(colCell >= 0) break;
          }
          // 2) If a header says UNITS/NOTES, never use it as numeric source
          const headerText = (c)=> {
            const h = ws[XLSX.utils.encode_cell({r:headerRow,c:c})];
            return h ? String(h.v).trim().toUpperCase() : '';
          };
          if (headerRow >= 0 && headerText(colVal) === 'UNITS/NOTES') {
            // Keep colVal fixed at CELL+1; do not drift into UNITS/NOTES.
          }
          // 3) As a last resort for atypical sheets, sniff to the right of CELL
          if(headerRow >= 0 && colCell >= 0 && colVal === colCell + 1){
            let found = false;
            for(let C = colCell + 1; C <= Math.min(ref.e.c, 16); C++){
              if (headerText(C) === 'UNITS/NOTES') continue; // never treat as numeric
              let sawNumeric = 0, sawTotal = 0;
              for(let R = headerRow + 1; R <= Math.min(headerRow + 6, ref.e.r); R++){
                const probe = ws[XLSX.utils.encode_cell({r:R,c:C})];
                if(!probe) continue; sawTotal++;
                const n = normalizeNumber(probe.v ?? probe.w);
                if(Number.isFinite(n)) sawNumeric++;
              }
              if(sawTotal && sawNumeric / sawTotal >= 0.6){ colVal = C; found = true; break; }
            }
            if(found && colVal !== colCell + 1 && !window.__analysisColValWarned){
              console.warn(`[analysis] value column auto-detected: ${XLSX.utils.encode_col(colVal)} (fallback)`);
              window.__analysisColValWarned = true;
            }
          }
          const map = {};
          if(colCell >= 0){
            for(let R = headerRow + 1; R <= ref.e.r; R++){
              const keyCell = ws[XLSX.utils.encode_cell({r:R,c:colCell})];
              const valCell = ws[XLSX.utils.encode_cell({r:R,c:colVal})];
              const key = keyCell && String(keyCell.v || keyCell.w || '').trim().toUpperCase();
              if(!key) continue;
              const v = normalizeNumber(valCell ? (valCell.v ?? valCell.w) : 0);
              map[key] = v;
            }
          }
          ws.__cellMap = map;
          return map;
        }catch{ return {}; }
      }

      function rowGet(ws, addr){
        // Prefer the (CELL -> numeric value) mapping derived from the worksheet table.
        // This ensures tokens like 'A4' or 'A18' resolve to the value in the VALUE column (e.g., D)
        // rather than reading the literal Excel address.
        const key = String(addr || '').toUpperCase();
        const map = buildCellMap(ws);
        if (map && Object.prototype.hasOwnProperty.call(map, key)) {
          return map[key];
        }
        // Fallback to reading the literal Excel address if not present in the CELL map
        const cell = ws && ws[addr];
        if (cell) {
          const v = cell.v != null ? cell.v : cell.w;
          if (typeof v === 'string') {
            // If the cell text looks like an A1 address, avoid coercion; we already missed the map.
            const a1 = /^[A-Z]{1,3}\d+$/i.test(v.trim());
            if (!a1) {
              const num = normalizeNumber(v);
              if (Number.isFinite(num)) return num;
            }
          } else {
            const num = normalizeNumber(v);
            if (Number.isFinite(num)) return num;
          }
        }
        return 0;
      }

      // deriveMetrics consults analysis-cell-map.json; falls back to legacy addresses
      function deriveMetrics(ws){
        let map;
        try{
          map = window.__analysisCellMap?.positional_cells;
        }catch{ map = null; }
        const getVal = addr => rowGet(ws, addr);
        const out = {};
        if(map && typeof map === 'object'){
          for(const [field, cell] of Object.entries(map)){
            const val = getVal(cell);
            out[field] = val;
            const short = field.split('_')[0];
            if(!(short in out)) out[short] = val;
          }
        } else {
          const fields = ['A4','C9','H9','I9','B19','A18','C18','C26'];
          for(const f of fields){
            const val = getVal(f);
            out[f] = val;
          }
        }
        out.eff = out.A4 ? out.C9 / out.A4 : 0;
        return out;
      }

      function computeMoM(arr,key){
        const deltas=[0];
        for(let i=1;i<arr.length;i++) deltas[i] = arr[i][key] - arr[i-1][key];
        return deltas;
      }

      function drawSparkline(host, series, w=900, h=180, pad=24){
        const min = Math.min(...series);
        const max = Math.max(...series);
        const span = max - min || 1;
        const step = series.length>1 ? (w-2*pad)/(series.length-1) : 0;
        const pts = series.map((v,i)=>{
          const x = pad + i*step;
          const y = h - pad - ((v-min)/span)*(h-2*pad);
          return `${x},${y}`;
        }).join(' ');
        host.innerHTML = `<svg role="img" aria-label="Current Month Bill (C9, INR) trend over months" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">`
          +`<polyline fill="none" stroke="var(--accent)" stroke-width="2" points="${pts}"/>`
          +`<line x1="0" x2="${w}" y1="${h-pad}" y2="${h-pad}" stroke="var(--muted)" stroke-width="1"/></svg>`;
      }

      // Chart.js powered chart (fallback to SVG sparkline if Chart is absent)
      let __analysisChart;
      // Metric catalog: key -> label, unit, formatter
      const METRICS = {
        A4:      {label:'Monthly Consumption (A4)',      unit:'kWh',       fmt:'int',  trend:'neutral'},
        C9:      {label:'Current Month Bill (C9)',       unit:'&#8377;',   fmt:'inr',  trend:'down'},
        I9:      {label:'Actual Paid (I9)',              unit:'&#8377;',   fmt:'inr',  trend:'down'},
        B19:     {label:'Wind Rate &#8377;/kWh (B19)',   unit:'&#8377;/kWh',fmt:'rate', trend:'up'},
        A18:     {label:'Bitlavadia Share (A18)',        unit:'kWh',       fmt:'int',  trend:'up'},
        C18:     {label:'Nanisindhodi Share (C18)',      unit:'kWh',       fmt:'int',  trend:'up'},
        C26:     {label:'Net Wind Credit (C26)',         unit:'&#8377;',   fmt:'inr',  trend:'up'},
        eff:     {label:'Effective Rate (&#8377;/kWh)',  unit:'&#8377;/kWh',fmt:'rate', trend:'down'},
        deltaC9: {label:'MoM Change in Bill (&Delta;C9)',unit:'&#8377;',   fmt:'inr',  trend:'down'},
        deltaPct:{label:'% Change in Bill (&Delta;C9)',  unit:'%',         fmt:'pct',  trend:'down'}
      };
      function fmtValue(k,v){
        const t = METRICS[k]?.fmt;
        if(t==='inr') return fmtINR.format(v);
        if(t==='pct') return `${fmt2.format(v)}%`;
        if(t==='rate') return fmt2.format(v);
        return fmt0.format(v);
      }
      function formatDeltaValue(metric, value){
        if(value===null || value===undefined) return '—';
        if(value===0) return fmtValue(metric, 0);
        const arrow = value>0 ? '↑' : '↓';
        const base = fmtValue(metric, Math.abs(value));
        return `${arrow} ${base}`;
      }
      function deltaSentiment(metric, value){
        if(value===null || value===undefined) return '';
        const trend = METRICS[metric]?.trend || 'neutral';
        if(value === 0 || trend === 'neutral') return '';
        if(trend === 'down') return value < 0 ? 'plus' : 'minus';
        if(trend === 'up') return value > 0 ? 'plus' : 'minus';
        return value > 0 ? 'plus' : value < 0 ? 'minus' : '';
      }
      function renderAnalysisStats(metric, cfg, rows){
        const host = document.getElementById('analysisStats');
        if(!host) return;
        if(!rows.length){
          host.innerHTML = '';
          host.hidden = true;
          return;
        }
        const labels = rows.map(r=>r.month || '—');
        const values = rows.map(r=>{
          const raw = Number(r?.[metric]);
          return Number.isFinite(raw) ? raw : 0;
        });
        const latestIndex = values.length - 1;
        const latestVal = values[latestIndex];
        const latestLabel = labels[latestIndex] || 'Latest month';
        const prevVal = values.length > 1 ? values[values.length - 2] : null;
        const delta = prevVal===null ? null : latestVal - prevVal;
        const deltaPct = prevVal===null || prevVal===0 ? null : (delta / Math.abs(prevVal)) * 100;
        const avgWindow = Math.min(3, values.length);
        const avgVal = avgWindow ? values.slice(-avgWindow).reduce((acc,v)=>acc+v,0) / avgWindow : null;
        let peak = {value:-Infinity, label:'—'};
        values.forEach((v, idx)=>{
          if(v>=peak.value){
            peak = {value:v, label:labels[idx] || '—'};
          }
        });
        const deltaPieces = [];
        if(delta!==null){
          const deltaClass = deltaSentiment(metric, delta);
          deltaPieces.push(`<span class="analysis-stat-delta ${deltaClass}">${formatDeltaValue(metric, delta)}</span>`);
        }
        if(deltaPct!==null){
          const pctClass = deltaSentiment(metric, deltaPct);
          const pctArrow = deltaPct>0 ? '↑' : deltaPct<0 ? '↓' : '';
          const pctMag = fmt2.format(Math.abs(deltaPct));
          const pctText = deltaPct===0 ? '0.00%' : `${pctArrow} ${pctMag}%`;
          deltaPieces.push(`<span class="analysis-stat-delta ${pctClass}">${pctText}</span>`);
        }
        const latestSub = `<div class="analysis-stat-sub"><span>${latestLabel}</span>${deltaPieces.join('')}</div>`;
        const avgLabel = avgWindow ? `Last ${avgWindow} month${avgWindow>1?'s':''}` : 'Need more history';
        const avgValue = avgWindow ? fmtValue(metric, avgVal) : '—';
        const peakValue = Number.isFinite(peak.value) ? fmtValue(metric, peak.value) : '—';
        const peakSub = `<div class="analysis-stat-sub"><span>${peak.label}</span></div>`;
        host.innerHTML = [
          `<div class="analysis-stat" role="listitem">
             <div class="analysis-stat-label">${cfg.label}</div>
             <div class="analysis-stat-value">${fmtValue(metric, latestVal)}</div>
             ${latestSub}
           </div>`,
          `<div class="analysis-stat" role="listitem">
             <div class="analysis-stat-label">Rolling average</div>
             <div class="analysis-stat-value">${avgValue}</div>
             <div class="analysis-stat-sub"><span>${avgLabel}</span></div>
           </div>`,
          `<div class="analysis-stat" role="listitem">
             <div class="analysis-stat-label">Peak month</div>
             <div class="analysis-stat-value">${peakValue}</div>
             ${peakSub}
           </div>`
        ].join('');
        host.hidden = false;
      }
      function metricKey(val){
        switch(String(val||'C9')){
          case 'EffRate': return 'eff';
          case '&Delta;C9': return 'deltaC9';
          case '&Delta;%C9': return 'deltaPct';
          case 'A4': case 'C9': case 'I9': case 'B19': case 'A18': case 'C18': case 'C26':
            return String(val);
          default: return 'C9';
        }
      }
      function renderAnalysisChart(metric='C9'){
        const rows = window.__analysisRows || [];
        const host = document.getElementById('analysisChartHost');
        const cfg = METRICS[metric] || {label:metric, unit:''};
        if(!rows.length){
          host.innerHTML = '<canvas id="analysisChart" height="220" aria-label="Analysis trend chart"></canvas>';
          renderAnalysisStats(metric, cfg, rows);
          return;
        }
        renderAnalysisStats(metric, cfg, rows);
        const labels = rows.map(r=>r.month);
        const data = rows.map(r=>Number(r[metric]||0));
        const canvas = document.getElementById('analysisChart');
        if(canvas){ canvas.setAttribute('aria-label', `Trend: ${cfg.label} over months`); }
        if(!(window.Chart && canvas)){
          drawSparkline(host, data);
          return;
        }
        if(__analysisChart){ __analysisChart.destroy(); }
        const styles = getComputedStyle(document.documentElement);
        const lineColor = (styles.getPropertyValue('--accent') || '#38bdf8').trim() || '#38bdf8';
        const lineAccent = (styles.getPropertyValue('--accent-2') || '#a78bfa').trim() || '#a78bfa';
        const gridColor = 'rgba(148,163,184,0.22)';
        const tickColor = (styles.getPropertyValue('--muted') || 'rgba(226,232,240,0.72)').trim() || 'rgba(226,232,240,0.72)';
        const tooltipBg = 'rgba(15,23,42,0.92)';
        const tooltipBorder = lineColor || '#38bdf8';
        host.classList.add('has-data');
        __analysisChart = new Chart(canvas.getContext('2d'),{
          type:'line',
          data:{ labels, datasets:[{
            label: cfg.label,
            data,
            tension:0.32,
            borderColor: lineColor,
            borderWidth:2.6,
            fill:true,
            pointRadius:4,
            pointBackgroundColor: lineColor,
            pointBorderColor:'rgba(15,23,42,0.9)',
            pointBorderWidth:2,
            pointHoverRadius:6,
            pointHoverBackgroundColor: lineAccent || lineColor,
            pointHoverBorderColor:'#ffffff',
            pointHoverBorderWidth:2,
            backgroundColor:(ctx)=>{
              const {chart}=ctx;
              const g=chart.ctx.createLinearGradient(0,0,0,chart.height);
              g.addColorStop(0,(lineColor || '#38bdf8')+'2a');
              g.addColorStop(1,'rgba(56,189,248,0)');
              return g;
            }
          }]},
          options:{
            responsive:true,
            maintainAspectRatio:false,
            interaction:{mode:'index', intersect:false},
            animation:{duration:650, easing:'easeOutQuart'},
            plugins:{
              legend:{display:false},
              tooltip:{
                backgroundColor:tooltipBg,
                titleColor:'#e2e8f0',
                bodyColor:'#e2e8f0',
                borderColor:tooltipBorder,
                borderWidth:1,
                padding:12,
                displayColors:false,
                callbacks:{
                  title:(ctx)=>ctx[0]?.label,
                  label:(ctx)=>`${cfg.label}: ${fmtValue(metric, ctx.parsed.y)}`
                }
              }
            },
            scales:{
              x:{
                grid:{color:gridColor, borderDash:[6,6], drawTicks:false, drawBorder:false},
                ticks:{maxRotation:0,autoSkip:true,color:tickColor}
              },
              y:{
                grid:{color:gridColor, borderDash:[4,6], drawTicks:false, drawBorder:false},
                ticks:{color:tickColor, callback:(v)=>fmtValue(metric,v)},
                title:{display:!!cfg.unit,text:cfg.unit, color:tickColor, padding:{bottom:6}}
              }
            }
          }
        });
      }

      async function analyzeAllSheets(){
        return withBusy('analyzeWorkbook', async ()=>{
          let wb = typeof getWB === 'function' ? getWB() : null;
          if(!wb || !Object.keys(wb.Sheets||{}).length){
            const file = document.getElementById('uploadXlsx')?.files?.[0];
            if(file && await loadXLSX()){
              const data = new Uint8Array(await file.arrayBuffer());
              wb = XLSX.read(data,{type:'array'});
            } else {
              toast('No workbook loaded...');
              return;
            }
          }
          const sheets = Object.keys(wb.Sheets).filter(n=>/^\d{4}-\d{2}$/.test(n)).sort();
          if(!sheets.length){ toast('No YYYY-MM sheets found.'); return; }
          const rows = sheets.map(name=>({month:name,...deriveMetrics(wb.Sheets[name])}));
          const deltas = computeMoM(rows,'C9');
          rows.forEach((r,i)=>{
            r.deltaC9 = deltas[i];
            r.deltaPct = i && rows[i-1].C9 ? (deltas[i]/rows[i-1].C9*100) : 0;
          });
          window.__analysisRows = rows;

          const tbody = document.querySelector('#analysisTable tbody');
          if(tbody){
            tbody.innerHTML='';
            rows.forEach(r=>{
              const tr=document.createElement('tr');
              tr.innerHTML =
                `<td>${r.month}</td>`+
                `<td style="text-align:right">${fmt0.format(r.A4)}</td>`+
                `<td style="text-align:right">${fmtINR.format(r.C9)}</td>`+
                `<td style="text-align:right">${fmtINR.format(r.I9)}</td>`+
                `<td style="text-align:right">${fmtRate.format(r.B19)}</td>`+
                `<td style="text-align:right">${fmt0.format(r.A18)}</td>`+
                `<td style="text-align:right">${fmt0.format(r.C18)}</td>`+
                `<td style="text-align:right">${fmtINR.format(r.C26)}</td>`+
                `<td style="text-align:right">${fmtRate.format(r.eff)}</td>`+
                `<td style="text-align:right">${fmtINR.format(r.deltaC9)}</td>`+
                `<td style="text-align:right">${fmt2.format(r.deltaPct)}%</td>`;
              tbody.appendChild(tr);
            });
          }

          const meta = document.getElementById('analysisMeta');
          if(meta) meta.textContent = `Sheets analyzed: ${rows.length} • Range: ${rows[0].month} → ${rows[rows.length-1].month}`;
          const metricSel = document.getElementById('analysisMetric');
          if(metricSel && !metricSel.dataset.bound){
            metricSel.dataset.bound = '1';
            metricSel.addEventListener('change', ()=> renderAnalysisChart(metricKey(metricSel.value)));
          }
          renderAnalysisChart(metricKey(metricSel?.value || 'C9'));
          const card = document.getElementById('analysisCard');
          if(card) card.hidden = false;
        });
      }

      function exportAnalysisCsv(){
        const rows = window.__analysisRows;
        if(!rows || !rows.length){ toast('No analysis data to export.'); return; }
        const header = ['Month','A4_kWh','C9_INR','I9_INR','B19_RsPerKWh','A18_kWh','C18_kWh','C26_INR','EffRate_RsPerKWh','DeltaC9_INR','DeltaC9_pct'];
        const lines = [header.join(',')];
        rows.forEach(r=>{
          lines.push([r.month,r.A4,r.C9,r.I9,r.B19,r.A18,r.C18,r.C26,r.eff,r.deltaC9,r.deltaPct].join(','));
        });
        const blob = new Blob([lines.join('\n')],{type:'text/csv'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'WEG_Analysis.csv';
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},0);
      }

      document.addEventListener('DOMContentLoaded',()=>{
        document.getElementById('analyzeWorkbook')?.addEventListener('click', analyzeAllSheets);
        document.getElementById('exportAnalysisCsv')?.addEventListener('click', exportAnalysisCsv);
      });
    })();
  </script>
</body>
</html>
