<!-- htmlhint tagname-lowercase:false -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IOM - HT Bill Calculator</title>
  <!-- Main styles including print rules; id must remain unique -->
  <style id="print-css">
    :root{
      --bg:#0f172a;          /* slate-900 */
      --card:#111827;        /* gray-900 */
      --ink:#e5e7eb;         /* gray-200 */
      --muted:#cbd5e1;       /* slate-300 */
      --accent:#22d3ee;      /* cyan-400 */
      --accent-2:#a78bfa;    /* violet-400 */
      --good:#22c55e;        /* green-500 */
      --bad:#ef4444;         /* red-500 */
      --warn:#f59e0b;        /* amber-500 */
      --panel:#0b1224;       /* deep */
      --ring:2px solid rgba(34,211,238,.6);
      --shadow: 0 20px 50px rgba(0,0,0,.45);
      --radius: 18px;
    }
    /* Force a light palette for export */
    :root { color-scheme: light only; }
    *{box-sizing:border-box}
    :focus-visible{outline:var(--ring);outline-offset:2px}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1100px 600px at 100% -10%, rgba(167,139,250,.18), transparent 60%),
                  radial-gradient(900px 500px at -10% 10%, rgba(34,211,238,.18), transparent 60%),
                  var(--bg);
      color:var(--ink);
    }
    .wrap{max-width:1200px;margin:20px auto;padding:0 20px}
    header{
      position:sticky;top:0;z-index:10;
      backdrop-filter:saturate(150%) blur(8px);
      background:linear-gradient(180deg, rgba(15,23,42,.92), rgba(15,23,42,.66));
      border-bottom:1px solid rgba(255,255,255,.08);
      display:grid;
      grid-template-columns:minmax(260px,auto) 1fr;
      align-items:start;
      gap:10px;
      margin-bottom:10px;
      padding:6px 0;               /* slimmer top bar */
    }

    .brand svg{width:26px;height:26px}
    .brand h1{font-size:18px;line-height:1.2}
    .sub{font-size:12px;margin-top:2px}

    .brand{display:flex;align-items:center;gap:12px}
    .brand h1{margin:0;letter-spacing:.3px}
    .sub{color:var(--ink)}

    button, .ghost{
      border:0;border-radius:10px;padding:6px 10px;font-size:13px;font-weight:600;letter-spacing:.2px;
      line-height:1.1;               /* compact but readable */
      min-height:34px;               /* a11y tap target */
      white-space:nowrap;            /* prevent multi-line buttons */
      max-width:100%;
      background:linear-gradient(145deg, rgba(167,139,250,.25), rgba(34,211,238,.25));
      color:white;cursor:pointer;box-shadow:var(--shadow);backdrop-filter: blur(6px);
    }
    button:hover{filter:brightness(1.07)}
    button:active{transform:translateY(1px)}
    .ghost{background:rgba(255,255,255,.05)}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{
      grid-column: span 12;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);padding:18px 18px 12px 18px;box-shadow:var(--shadow)
    }
    @media(min-width:980px){
      .span-6{grid-column:span 6}
      .span-4{grid-column:span 4}
      .span-8{grid-column:span 8}
      .span-3{grid-column:span 3}
      .span-9{grid-column:span 9}
    }

    .card h2{margin:0 0 12px 0;font-size:16px;font-weight:700;display:flex;justify-content:space-between;align-items:center}
    .help{color:var(--ink);font-size:12px}

    .fields{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .fields .f{grid-column:span 12}
    @media(min-width:860px){.fields .f{grid-column:span 6}}
    .fields .f.sm{grid-column:span 6}
    @media(min-width:860px){.fields .f.sm{grid-column:span 3}}

    label{display:flex;justify-content:space-between;gap:8px;color:var(--ink);font-size:12.5px;margin-bottom:6px}
    input[type="number"], input[type="month"], input[type="text"]{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(17,24,39,.6);color:var(--ink)
    }

    .kpi{
      display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin-top:6px
    }
    .kpi .box{grid-column:span 12;min-height:104px}
    @media(min-width:980px){.kpi .box{grid-column:span 4}}
    .box{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px
    }
    .box h3{margin:0;color:var(--muted);font-size:12.5px;font-weight:600;white-space:normal;line-height:1.25;word-break:break-word;overflow-wrap:anywhere}
    .box .v{margin-top:8px;font-size:22px;font-weight:800}
    .unit{font-size:12px;color:var(--muted);margin-left:6px;font-weight:600}

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .accent{color:var(--accent)}
    .violet{color:var(--accent-2)}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}

    .footer{margin-top:18px;color:var(--muted);font-size:12px}
    .muted{color:var(--muted)}
    .hr{height:1px;background:linear-gradient(90deg, rgba(255,255,255,.15), rgba(255,255,255,.03));margin:14px 0}

    .pill{display:inline-flex;align-items:center;gap:8px;padding:4px 6px;border-radius:999px;
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:11px;
      min-height:34px;flex:0 0 auto;scroll-snap-align:start}
    /* keep pill text on one line, truncate gracefully */
    .pill > span{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%;}
    .pill button{padding:2px 6px}
    .pill:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    .pills{
      display:flex;
      gap:6px;
      overflow-x:auto;
      overflow-y:hidden;
      white-space:nowrap;
      max-width:100%;
      -webkit-overflow-scrolling:touch;
      scroll-snap-type:x proximity;
    }
    .right{float:right}

    /* Normalize header form-control height to match 34px tap target */
    header .toolbar input[type="month"],
    header .toolbar input[type="text"],
    header .toolbar select{
      height:34px; line-height:34px;
      padding:0 10px; font-size:13px;
      border-radius:8px; /* harmonize with pill rounding */
    }
      header .toolbar input{margin:0}  /* avoid UA default margins increasing pill height */
      header .toolbar input[type="checkbox"]{height:auto;width:auto} /* keep checkbox natural */


    details{margin:10px 0}
    summary{cursor:pointer}

    #toasts{position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:1000}
    .toast{background:var(--card);color:var(--ink);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:1;transition:opacity .5s ease, transform .5s ease}
    .toast.info{border-left:4px solid var(--accent)}
    .toast.good{border-left:4px solid var(--good)}
    .toast.bad{border-left:4px solid var(--bad)}
    .toast.warn{border-left:4px solid var(--warn)}
    .toast.hide{opacity:0;transform:translateX(20px)}
    .hint{display:none;color:var(--bad);font-size:11px;margin-top:4px}
    .warn-text{display:none;color:var(--muted);font-size:11px;margin-top:4px}
    .invalid{border-color:var(--bad)!important}


    /* Toolbar group layout */
    header .toolbar{ grid-column:1 / -1; }
    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      overflow:hidden; min-width:0;
      padding:4px 0;
    }
    /* pills in toolbar should not cause overflow */
    .toolbar .pill{min-width:0; max-width:100%;}
    .group{
      display:flex; align-items:center; gap:6px;
      padding:3px 6px;                /* slightly tighter */
      border-radius:12px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      flex-wrap:wrap; flex:1 1 340px; min-width:240px; max-width:100%;
    }
    .group .label{
      font-size:10px; letter-spacing:.05em; text-transform:uppercase;
      color:var(--muted); margin-right:2px;
      min-width:90px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:120px;
    }
    .group[aria-label="Utilities"]{padding:2px 4px;gap:4px}
    /* Compact on narrow screens */
    @media (max-width: 980px){
      header{ grid-template-columns: 1fr; }
      .group{ width:100%; border-radius:14px; }
      .toolbar > label.pill{ width:100%; }
    }

    /* Encourage earlier wrapping on mid-width laptops to keep header compact */
    @media (max-width: 1280px) and (min-width: 1060px){
      .group{
        flex:1 1 300px;
      }
    }

    /* A4 page layout for HTML preview */
    .sheet {
      width: 210mm;
      min-height: 297mm;
      margin: 12px auto;
      background: #fff;
      color: #111;
      border: 1px solid rgba(0,0,0,.12);
      padding: 16mm 18mm 22mm; /* bottom padding to avoid footer overlap */
      position: relative;
      font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    .doc-header { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:4mm; }
    .doc-header h2 { margin:2mm 0 0; font-size:18pt; }
    .doc-header .company { font-weight:700; }
    .doc-header .dept { font-size:11pt; }
    .doc-meta { color:#555; font-size:10.5pt; text-align:right; }
    .info-bar { background:#f3f4f6; border:1px solid #e5e7eb; padding:2mm 4mm; margin-bottom:8mm; font-size:10.5pt; white-space:normal; overflow:visible; text-overflow:clip; overflow-wrap:anywhere; word-break:break-word; }
    @media print { .info-bar { overflow:visible; text-overflow:clip; } }
    .sec { break-inside: avoid; margin: 7mm 0 0; }
    .sec h3 { margin:0 0 3mm; font-size:12pt; border-bottom:1px solid #ddd; padding-bottom:2.5mm; }
    .kv { display:grid; grid-template-columns: 1fr minmax(52mm,auto) 10mm; gap:2mm; padding:2mm 0; border-bottom:1px dashed #eee; }
    .kv .label { color:#374151; overflow-wrap:anywhere; word-break:break-word; }
    .kv .value { font-weight:600; text-align:right; font-variant-numeric: tabular-nums; }
    .kv .unit { color:#6b7280; text-align:right; }
    .kv .value.total { font-weight:800; }
    .mapping .kv:last-child { background: #f3f4f6; border:1px solid #e5e7eb; }
    .total { font-weight:700; }
    /* Signatures */
    .signatures { break-inside: avoid; }
    .sigs { display:grid; grid-template-columns: 1fr 1fr; gap:6mm; margin-top:6mm; }
    .sig { text-align:left; }
    .sig.right { text-align:right; }
    .sig .line { border-top:1px solid #d1d5db; height:0; margin:14mm 0 2mm; }
    .sig .role { color:#111; font-weight:600; }
    .footer-note { margin-top:8mm; color:#6b7280; font-size:9.5pt; }
    .page-number { position:absolute; bottom:8mm; right:18mm; color:#6b7280; font-size:10pt; }

    /* Print rules: hide only UI chrome, keep the A4 preview visible */
    @media print {
      @page { size: A4; margin: 12mm; }
      header, .toolbar, .card:not(.sheet), #toasts { display:none !important; }
      .sheet { display:block !important; border:none; width:auto; min-height:auto; margin:0; padding:0 0 16mm 0; break-inside: avoid;
               -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .sheet:not(:last-of-type) { break-after: page; page-break-after: always; }
      /* Tighten vertical rhythm for single-page fit (print-only) */
      .doc-header { margin-bottom:2mm; }
      .doc-header h2 { margin:1mm 0 0; }
      .info-bar { margin-bottom:6mm; }
      .sec { margin:5mm 0 0; }
      .sigs { gap:4mm; margin-top:4mm; }
      .sig .line { margin:10mm 0 2mm; }
      .footer-note { margin-top:6mm; }
      .page-number { bottom:6mm; font-size:9pt; }
      .sheet { font-size:13px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="32" y2="32" gradientUnits="userSpaceOnUse">
              <stop stop-color="#22d3ee"/>
              <stop offset="1" stop-color="#a78bfa"/>
            </linearGradient>
          </defs>
          <path d="M16 3c7.18 0 13 5.82 13 13s-5.82 13-13 13S3 23.18 3 16 8.82 3 16 3Zm0 4a9 9 0 1 0 0 18 9 9 0 0 0 0-18Zm0 3.2a5.8 5.8 0 1 1 0 11.6A5.8 5.8 0 0 1 16 10.2Z" fill="url(#g)"/>
        </svg>
        <div>
          <h1>WEG Billing Calculator</h1>
          <div class="sub">Single‑file tool for HT bill + wind credits • Excel export with month sheets</div>
        </div>
      </div>
      <div class="toolbar">
        <!-- Month -->
        <label class="pill"><span>Billing Month</span><input type="month" id="billMonth"/></label>
        <div id="sheetList" class="pills" role="listbox"></div>

        <!-- Workbook group -->
        <div class="group" aria-label="Workbook">
          <span class="label">Workbook</span>
          <button id="addSheet">Add / Update Month Sheet</button>
          <button id="uploadExcel">Upload Excel</button>
          <input type="file" id="uploadXlsx" accept=".xlsx" hidden>
          <label class="pill" id="autoUpdateToggle">
            <input type="checkbox" id="autoUpdateOnDownload" checked />
            <span>Auto-update on Download</span>
          </label>
          <button id="downloadExcel">Download Excel</button>
        </div>

        <!-- Preview & Print group -->
        <div class="group" aria-label="Preview and Print">
          <span class="label">Preview & Print</span>
          <button id="renderHtml">Render Preview</button>
          <button id="renderReceipt">Render Receipt</button>
          <label class="pill"><input type="checkbox" id="autoPrintHtml" /> Auto-print</label>
          <button id="saveHtmlPdf" disabled aria-disabled="true">Save as PDF</button>
            <button id="openHtmlPdf" class="ghost" disabled aria-disabled="true">Open PDF</button>
        </div>

        <!-- Utilities group -->
        <div class="group" aria-label="Utilities">
          <span class="label">Utilities</span>
          <button id="resetSample">Sample Data</button>
          <button class="ghost" id="resetAll">Reset</button>
          <button class="ghost" id="clearSheets">Clear Sheets</button>
        </div>
      </div>
      </header>

      <div class="grid">
        <!-- Main HT Bill Inputs -->
      <section class="card span-6">
        <h2>HT Bill — Inputs <span class="help">Manual entries from utility bill</span></h2>
        <div class="fields">
          <div class="f"><label>Monthly Consumption (kWh) <span class="mono">A4</span></label><input type="number" id="A4" step="0.001" min="0"/><span class="hint"></span></div>
          <div class="f"><label>Demand Charges (₹) <span class="mono">B4</span></label><input type="text" id="B4"/><span class="hint"></span></div>
          <div class="f"><label>Energy Charges (₹) <span class="mono">C4</span></label><input type="text" id="C4"/><span class="hint"></span></div>
          <div class="f"><label>Night Rebate (₹) <span class="mono">D4</span></label><input type="text" id="D4"/><span class="hint"></span></div>
          <div class="f"><label>Fuel Charge (₹) <span class="mono">E4</span></label><input type="text" id="E4"/><span class="hint"></span></div>
          <div class="f"><label>PF Rebate (₹) <span class="mono">F4</span></label><input type="text" id="F4"/><span class="hint"></span></div>
          <div class="f"><label>EHV Rebate (₹) <span class="mono">G4</span></label><input type="text" id="G4"/><span class="hint"></span></div>
          <div class="f"><label>TOU (₹) <span class="mono">H4</span></label><input type="text" id="H4"/><span class="hint"></span></div>
          <div class="f"><label>GT Charges (₹) <span class="mono">I4</span></label><input type="text" id="I4"/><span class="hint"></span></div>
        </div>
        <div class="hr"></div>
        <div class="kpi">
          <div class="box"><h3>Tot Consumption Charge <span class="mono">A9 = B4+C4+D4+E4−F4−G4+H4+I4</span></h3><div class="v" id="A9v">₹0</div></div>
          <div class="box"><h3>ED @ 20% <span class="mono">B9 = A9×0.2</span></h3><div class="v" id="B9v">₹0</div></div>
          <div class="box"><h3>Current Month Bill <span class="mono">C9 = A9+B9</span></h3><div class="v" id="C9v">₹0</div></div>
        </div>
      </section>

      <!-- Adjustments -->
      <section class="card span-6">
        <h2>Adjustments & Carry‑forward <span class="help">Manual entries</span></h2>
        <div class="fields">
          <div class="f sm"><label>Outstanding Arrears (₹) <span class="mono">D9</span></label><input type="text" id="D9"/><span class="hint"></span></div>
          <div class="f sm"><label>Freeze Amount (₹) <span class="mono">E9</span></label><input type="text" id="E9"/><span class="hint"></span></div>
          <div class="f sm"><label>Delayed Payment Charges (₹) <span class="mono">F9</span></label><input type="text" id="F9"/><span class="hint"></span></div>
          <div class="f sm"><label>Advance Payment / Adjust. (₹) <span class="mono">G9</span></label><input type="text" id="G9"/><span class="hint"></span></div>
        </div>
        <div class="hr"></div>
        <div class="kpi">
          <div class="box"><h3>Net Payable <span class="mono">H9 = C9+D9+F9−G9</span></h3><div class="v" id="H9v">₹0</div></div>
          <div class="box"><h3>Actual Amount to be Paid <span class="mono">I9 = H9−E9</span></h3><div class="v" id="I9v">₹0</div></div>
          <div class="box"><h3>Balance Pending from Previous Month <span class="mono">A31 = D9−E9</span></h3><div class="v" id="A31v">₹0</div></div>
        </div>
      </section>

      <!-- WEG Inputs -->
      <section class="card span-6">
        <h2>WEG — Inputs <span class="help">Bitlavadia (4.5 MW) & Nanisindhodi (14.7 MW)</span></h2>
        <div class="fields">
          <div class="f sm"><label>Share Bitlavadia (%) <span class="mono">B15</span></label><input type="number" id="B15" step="0.01" min="0" max="100"/><span class="hint"></span></div>
          <div class="f sm"><label>Share Nanisindhodi (%) <span class="mono">D15</span></label><input type="number" id="D15" step="0.01" min="0" max="100"/><span class="hint"></span></div>
          <div class="f sm"><label>Transmission Loss (%) <span class="mono">C16</span></label><input type="number" id="C16" step="0.01" min="0" max="100"/><span class="hint"></span></div>
        </div>
        <details>
          <summary class="muted">Monthly Generation (MWh) — expand</summary>
          <div class="fields" style="margin-top:10px">
            <div class="f sm"><label>Bitlavadia MWh #1 <span class="mono">A17</span></label><input type="number" id="A17" step="0.001" min="0"/><span class="hint"></span></div>
            <div class="f sm"><label>Bitlavadia MWh #2 <span class="mono">B17</span></label><input type="number" id="B17" step="0.001" min="0"/><span class="hint"></span></div>
            <div class="f sm"><label>Nanisindhodi MWh #1 <span class="mono">C17</span></label><input type="number" id="C17" step="0.001" min="0"/><span class="hint"></span></div>
            <div class="f sm"><label>Nanisindhodi MWh #2 <span class="mono">D17</span></label><input type="number" id="D17" step="0.001" min="0"/><span class="hint"></span></div>
            <div class="f sm"><label>Nanisindhodi MWh #3 <span class="mono">E17</span></label><input type="number" id="E17" step="0.001" min="0"/><span class="hint"></span></div>
          </div>
        </details>
        <div class="hr"></div>
        <div class="kpi">
          <div class="box"><h3>Bitlavadia Share (kWh) <span class="mono">A18 = ROUNDUP((A17+B17)*1000*B15%*(1−C16%),0)</span></h3><div class="v" id="A18v">0 kWh</div></div>
          <div class="box"><h3>Nanisindhodi Share (kWh) <span class="mono">C18 = ROUNDUP((C17+D17+E17)*1000*D15%*(1−C16%),0)</span></h3><div class="v" id="C18v">0 kWh</div></div>
          <div class="box"><h3>Total Allocated (kWh) <span class="mono">A19 = A18+C18</span></h3><div class="v" id="A19v">0 kWh</div></div>
        </div>
      </section>

      <!-- WEG Credits -->
      <section class="card span-6">
        <h2>Wind Credits & Debits <span class="help">Prior‐month adjustments</span></h2>
        <div class="fields">
          <div class="f sm"><label>Credit Board Charges (₹) <span class="mono">A24</span></label><input type="text" id="A24"/><span class="hint"></span></div>
          <div class="f sm"><label>Credit ED Charges (₹) <span class="mono">B24</span></label><input type="text" id="B24"/><span class="hint"></span></div>
          <div class="f sm"><label>Credit TDS (₹) <span class="mono">C24</span></label><input type="text" id="C24"/><span class="hint"></span></div>
          <div class="f sm"><label>Debit Board Charges (₹) <span class="mono">D24</span></label><input type="text" id="D24"/><span class="hint"></span></div>
          <div class="f sm"><label>Debit Electricity Duty (₹) <span class="mono">E24</span></label><input type="text" id="E24"/><span class="hint"></span></div>
          <div class="f sm"><label>Debit Wheeling Charges (₹) <span class="mono">F24</span></label><input type="text" id="F24"/><span class="hint"></span></div>
        </div>
        <div class="hr"></div>
        <div class="kpi">
          <div class="box"><h3>Total Credit (₹) <span class="mono">A26 = A24+B24</span></h3><div class="v" id="A26v">₹0</div></div>
          <div class="box"><h3>Total Debit (₹) <span class="mono">B26 = D24+E24+F24</span></h3><div class="v" id="B26v">₹0</div></div>
          <div class="box"><h3>Net Wind Credit (₹) <span class="mono">C26 = A26−B26</span></h3><div class="v" id="C26v">₹0</div></div>
        </div>
        <div class="kpi">
          <div class="box"><h3>Wind Rate (₹ / kWh) <span class="mono">B19 = IF(A19=0,0,C26/A19)</span></h3><div class="v" id="B19v">₹0</div><small class="warn-text" id="windRateWarn">kWh allocated is zero; rate shown as ₹0.00/kWh</small></div>
          <div class="box"><h3>Share of 4.5 MW WEG (₹) <span class="mono">F16 = B19×A18</span></h3><div class="v" id="F16v">₹0</div></div>
          <div class="box"><h3>Share of 14.7 MW WEG (₹) <span class="mono">G16 = B19×C18</span></h3><div class="v" id="G16v">₹0</div></div>
        </div>
      </section>

        <!-- Final Bill -->
        <section class="card span-12">
          <h2>Final Bill for IOM</h2>
          <div class="kpi">
            <div class="box"><h3 class="mono">Formula: C9 − F16 − G16 − C24 + A31 + F9</h3>
              <div class="v" id="FINALv" style="font-size:30px">₹0</div>
              <div class="muted">Mapping: Current Month Bill − Share(4.5MW) − Share(14.7MW) − Credit TDS + Balance Pending (prev) + Delay Charges</div>
              <div id="finalCheckBadge" class="pill" style="margin-top:8px" role="status" aria-live="polite">
                <span id="FINALstatusv" aria-hidden="true"></span>
                &nbsp;Check • I9 (= H9 − E9): <span id="I9checkv">₹0</span>
                &nbsp;•&nbsp; Δ vs FINAL: <span id="FINALdeltav">₹0</span>
              </div>
            </div>
          </div>
        </section>
        <!-- Central Dak Receipt Inputs -->
        <section class="card span-4">
          <h2>Central Dak Receipt — Inputs</h2>
          <div class="fields">
            <div class="f"><label>Vendor Code</label><input type="text" id="rc_vendorCode"/></div>
            <div class="f"><label>Vendor Name</label><input type="text" id="rc_vendorName"/></div>
            <div class="f"><label>Bill No.</label><input type="text" id="rc_billNo"/></div>
            <div class="f"><label>Bill Date</label><input type="text" id="rc_billDate"/></div>
            <div class="f"><label>Amount</label><input type="text" id="rc_amount"/></div>
            <div class="f"><label>EIC Name</label><input type="text" id="rc_eic" value="Mr. Vijendra Singh"/></div>
          </div>
        </section>
        <!-- Rates Manager -->
        <section class="card span-12" id="ratesCard">
          <h2>Rates Manager (Tariffs &amp; PO Rates)</h2>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
            <button id="importRates">Load/Import</button>
            <button id="downloadTariffs" class="ghost">Download Tariffs</button>
            <button id="downloadPoRates" class="ghost">Download PO Rates</button>
            <button id="editRates" class="ghost">Edit Rates</button>
            <button id="saveRates">Save</button>
            <button id="exportCsv" class="ghost">Export CSV</button>
          </div>
          <div class="hr"></div>
          <table id="ratesTable" style="width:100%;border-collapse:collapse;font-size:12px;">
            <thead>
              <tr>
                <th style="text-align:left;">Service</th>
                <th>Qty (B)</th>
                <th>Tariff (C)</th>
                <th>Amt (D)</th>
                <th>Contract Rate (E)</th>
                <th>Unit Adj (F)</th>
                <th>Amount SES (G)</th>
              </tr>
            </thead>
            <tbody id="ratesBody"></tbody>
          </table>
          <div id="parityBadge" class="pill" style="margin-top:8px;">ΣD ₹0.00 | ΣG ₹0.00 | Δ ₹0.00</div>
          <input type="file" id="ratesFile" accept="application/json" style="display:none" multiple>
        </section>
        <!-- Long Text for SAP -->
        <section class="card span-12" aria-labelledby="sapLongTextH">
        <h2 id="sapLongTextH">Long Text for SAP</h2>
        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <button id="genSapText">Generate</button>
          <button id="copySapText" class="ghost">Copy</button>
        </div>
        <textarea id="sapText" rows="14" readonly aria-label="SAP long text" style="width:100%;"></textarea>
        <div class="muted" style="margin-top:4px;">Click Generate, review, then Copy and paste into SAP.</div>
      </section>
    </div>

  <div class="footer">Pro‑tips: enter positive numbers for all rebates/credits (the app handles signs). Rounding of kWh shares matches <span class="mono">ROUNDUP(…,0)</span>. Values are live‑calculated; add a month sheet when ready.</div>
  </div>

  <div id="htmlPrintHost" role="region" aria-label="A4 print preview" aria-busy="false" tabindex="-1"></div>
  <div id="toasts" role="status" aria-live="polite"></div>
  <div id="modal" role="dialog" aria-modal="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1100; align-items:center; justify-content:center;">
    <div style="background:var(--card); color:var(--ink); padding:16px; border-radius:12px; min-width:300px; box-shadow:var(--shadow)">
      <div id="modalText" style="margin-bottom:12px"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end">
        <button id="modalCancel" class="ghost">Cancel</button>
        <button id="modalOk">Replace</button>
      </div>
    </div>
  </div>

  <script>
    function toast(msg, type='info'){
      const host = document.getElementById('toasts');
      if(!host){
        try{ console.warn('[toast] container #toasts not found; message:', msg); }catch(_){ }
        return;
      }
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.textContent = msg;
      host.appendChild(t);
      setTimeout(()=>{
        t.classList.add('hide');
        t.addEventListener('transitionend',()=>t.remove());
      },3000);
    }
  </script>

    <!-- SheetJS for Excel export -->
    <!-- Prefer a local copy for offline/file:// usage; keep dynamic loader as fallback -->
    <script src="./xlsx.full.min.js"></script>
    <!-- pdfMake support removed -->
    <script>
      // Tries: ?xlsx=override → ./xlsx.full.min.js (local) → CDNs
      let __xlsxLoading = null;
    async function loadXLSX(){
      if (window.XLSX) return true; // already present (e.g., local tag succeeded)
      if (__xlsxLoading) return __xlsxLoading;
      __xlsxLoading = (async () => {
        const qp = new URLSearchParams(location.search);
        const override = qp.get('xlsx'); // optional: ?xlsx=/path/to/xlsx.full.min.js
        const urls = [
          ...(override ? [override] : []),
          './xlsx.full.min.js',
          'https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js',
          'https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js'
        ];
        let lastTried = '';
        for (const src of urls){
          lastTried = src;
          try{
            await new Promise((resolve, reject) => {
              const s = document.createElement('script');
              s.src = src;
              s.async = true;
              s.onload = resolve;
              s.onerror = reject;
              document.head.appendChild(s);
            });
            if (window.XLSX) return true;
          }catch{/* try next */}
        }
        toast(`Excel library failed to load (last: ${lastTried}). You are likely offline or a CSP blocked CDNs. Place "xlsx.full.min.js" next to this HTML or pass ?xlsx=/path/to/xlsx.full.min.js`, 'bad');
        return false;
      })();
      const ok = await __xlsxLoading;
      __xlsxLoading = null;
      return ok;
    }

    // Restore the small UX helper to show a temporary busy state on buttons.
    // Many toolbar handlers call withBusy('buttonId', async () => { ... }).
    async function withBusy(btnId, fn){
      const btn = document.getElementById(btnId);
      const prevDisabled = btn ? btn.disabled : false;
      const prevText = btn ? btn.textContent : '';
      if (btn){
        btn.disabled = true;
        btn.dataset.prevText = prevText;
        btn.textContent = 'Working…';
      }
      try{
        return await fn();
      } finally {
        if (btn){
          btn.disabled = prevDisabled;
          btn.textContent = btn.dataset.prevText || prevText;
          delete btn.dataset.prevText;
        }
      }
    }

  </script>
  <script>
    // Utility helpers
      const INR = new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR', maximumFractionDigits:2 });
      const KWH = new Intl.NumberFormat('en-IN', { maximumFractionDigits:0 });
      const RATE = new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR', maximumFractionDigits:6 });
      const SAMPLE = {
        A4:1000,B4:5000,C4:8000,D4:200,E4:300,F4:100,G4:50,H4:400,I4:600,
        D9:200,E9:50,F9:30,G9:0,
        B15:30,D15:70,C16:2,
        A17:1,B17:1,C17:2,D17:1,E17:1,
        A24:500,B24:200,C24:100,D24:50,E24:25,F24:25
      };

    const $ = id => document.getElementById(id);
    const num = id => {
      const el = $(id);
      return parseFloat(el.dataset.value || el.value || 0) || 0;
    };
    const roundUp0 = x => Math.ceil(x);

    // Final reconciliation tolerance (INR); hoisted for clarity & micro-perf.
    // Stability guard: do not change without approval.
    const FINAL_CHECK_TOL = 0.05;

    const SERVICE_LIST = [
      { code:'FIXED_METER_RENT', name:'Fixed Meter Rent' },
      { code:'MD_SLAB1', name:'MD Slab 1' },
      { code:'MD_SLAB2', name:'MD Slab 2' },
      { code:'MD_SLAB3', name:'MD Slab 3' },
      { code:'PENAL_ABOVE_CD', name:'Penal Above CD' },
      { code:'EC_SLAB1', name:'Energy Charge Slab 1' },
      { code:'FCA', name:'FCA' },
      { code:'TOD_PEAK', name:'TOD Peak' },
      { code:'TOD_NIGHT_REBATE', name:'TOD Night Rebate' },
      { code:'PF_CHARGE_SLAB1', name:'PF Charge Slab 1' },
      { code:'ARREAR_FCA', name:'Arrear FCA' },
      { code:'ARREAR_ED', name:'Arrear ED' },
      { code:'ARREAR_CESS', name:'Arrear Cess' },
      { code:'ARREAR_PF', name:'Arrear PF' },
      { code:'ARREAR_ENERGY', name:'Arrear Energy' },
      { code:'WIND_ENERGY_CREDIT', name:'Wind Energy Credit' }
    ];
    const SERVICE_HINTS = {
      EC_SLAB1: 'Hint: from “Energy Charges” (HT Bill → C4)',
      TOD_PEAK: 'Hint: from “TOU” (HT Bill → H4)',
      TOD_NIGHT_REBATE: 'Hint: from “EHV Rebate” (HT Bill → G4)',
      PF_CHARGE_SLAB1: 'Hint: Enter Power Factor (e.g., 0.997)',
      ARREAR_ED: 'Hint: Enter Consumption Charges (base for ED)'
    };
    const QTY_PLACEHOLDERS = {
      PF_CHARGE_SLAB1: 'Enter Power Factor (e.g., 0.997)',
      EC_SLAB1: 'kWh billed',
      TOD_PEAK: 'kWh @ TOU (peak)',
      TOD_NIGHT_REBATE: 'kWh (night rebate)',
      ARREAR_ED: 'Consumption Charges (₹)'
    };
    const SERVICE_CODES = SERVICE_LIST.map(s=>s.code);

    const DEFAULT_TARIFFS = {
      FIXED_METER_RENT:0,
      MD_SLAB1:150,
      MD_SLAB2:260,
      MD_SLAB3:475,
      PENAL_ABOVE_CD:0,
      EC_SLAB1:4.2,
      FCA:2.45,
      TOD_PEAK:0.85,
      TOD_NIGHT_REBATE:0.015,
      PF_CHARGE_SLAB1:0.0235,
      ARREAR_FCA:1,
      ARREAR_ED:0.2,
      ARREAR_CESS:1,
      ARREAR_PF:1,
      ARREAR_ENERGY:1,
      WIND_ENERGY_CREDIT:0
    };

    const DEFAULT_PO_RATES = {
      FIXED_METER_RENT:750,
      MD_SLAB1:150,
      MD_SLAB2:260,
      MD_SLAB3:475,
      PENAL_ABOVE_CD:370,
      EC_SLAB1:4.2,
      FCA:1.81,
      TOD_PEAK:0.85,
      TOD_NIGHT_REBATE:0.43,
      PF_CHARGE_SLAB1:0.02,
      ARREAR_FCA:1,
      ARREAR_ED:1,
      ARREAR_CESS:1,
      ARREAR_PF:1,
      ARREAR_ENERGY:1,
      WIND_ENERGY_CREDIT:-1
    };

    let tariffs = { version:1, meta:{supplier:'PGVCL',currency:'INR'}, effective:'', rates:{...DEFAULT_TARIFFS} };
    let poRates = { version:1, meta:{po_number:'',currency:'INR'}, rates:{...DEFAULT_PO_RATES} };
    let sesRows = [];

    function sanitizeRates(obj, defaults){
      obj = obj || {};
      obj.rates = obj.rates || {};
      const unknown = Object.keys(obj.rates).filter(k=>!SERVICE_CODES.includes(k));
      if(unknown.length) toast(`Unknown service codes: ${unknown.join(', ')}`, 'warn');
      unknown.forEach(k=>delete obj.rates[k]);
      SERVICE_CODES.forEach(code=>{ if(!(code in obj.rates)) obj.rates[code] = defaults[code] ?? 0; });
      return obj;
    }

    function loadRates(){
      let t=null,p=null;
      try{ t = JSON.parse(localStorage.getItem('tariffs.v1')); }catch{}
      try{ p = JSON.parse(localStorage.getItem('po_rates.v1')); }catch{}
      if(!t) toast('Tariff defaults loaded; Save to persist.', 'info');
      if(!p) toast('PO rate defaults loaded; Save to persist.', 'info');
      tariffs = sanitizeRates(t || tariffs, DEFAULT_TARIFFS);
      poRates = sanitizeRates(p || poRates, DEFAULT_PO_RATES);
    }

    function updateRatesFromInputs(){
      SERVICE_LIST.forEach(s=>{
        const tEl=$('tar_'+s.code); if(tEl) tariffs.rates[s.code]=parseFloat(tEl.value)||0;
        const pEl=$('po_'+s.code); if(pEl) poRates.rates[s.code]=parseFloat(pEl.value)||0;
      });
    }

    function renderRatesTable(){
      const body=$('ratesBody'); if(!body) return;
      body.innerHTML='';
      SERVICE_LIST.forEach(s=>{
        const tr=document.createElement('tr');
        const qtyAttrs = s.code==='PF_CHARGE_SLAB1' ? 'step="0.000001"' : 'step="0.01"';
        const qtyDis = s.code==='FCA' ? 'disabled' : '';
        const hint = SERVICE_HINTS[s.code];
        const hintHtml = hint ? `<div class="muted" style="font-size:11px">${hint}</div>` : '';
        const ph = QTY_PLACEHOLDERS[s.code] ? `placeholder="${QTY_PLACEHOLDERS[s.code]}"` : '';
        tr.innerHTML=`
          <td><span class="mono">${s.code}</span><div class="muted">${s.name}</div>${hintHtml}</td>
          <td><input type="number" ${qtyAttrs} id="qty_${s.code}" ${qtyDis} ${ph}/></td>
          <td><input type="number" step="0.000001" id="tar_${s.code}" disabled/></td>
          <td><span id="d_${s.code}" class="muted">—</span></td>
          <td><input type="number" step="0.000001" id="po_${s.code}" disabled/></td>
          <td><span id="f_${s.code}" class="muted">—</span></td>
          <td><span id="g_${s.code}" class="muted">—</span></td>`;
        body.appendChild(tr);
      });
      SERVICE_LIST.forEach(s=>{
        $('tar_'+s.code).value = tariffs.rates[s.code];
        $('po_'+s.code).value = poRates.rates[s.code];
      });
      body.querySelectorAll('input').forEach(el=>el.addEventListener('input', compute));
      computeSes();
    }

    function toggleEditRates(){
      const editing = $('tar_'+SERVICE_CODES[0])?.disabled;
      SERVICE_LIST.forEach(s=>{
        $('tar_'+s.code)?.toggleAttribute('disabled', !editing);
        $('po_'+s.code)?.toggleAttribute('disabled', !editing);
      });
      const btn=$('editRates'); if(btn) btn.textContent = editing ? 'Done' : 'Edit Rates';
    }

    function saveRates(){
      if(!$('ratesCard')) return;
      updateRatesFromInputs();
      tariffs.effective = monthLabel();
      localStorage.setItem('tariffs.v1', JSON.stringify(tariffs));
      localStorage.setItem('po_rates.v1', JSON.stringify(poRates));
      downloadJson(tariffs,'tariffs.json');
      downloadJson(poRates,'po_rates.json');
      toast('Rates saved.', 'good');
      compute();
    }

    function handleImport(ev){
      const files=ev.target.files; if(!files) return;
      Array.from(files).forEach(file=>{
        const reader=new FileReader();
        reader.onload=()=>{
          try{
            const data=JSON.parse(reader.result);
            if(data.meta && data.meta.supplier){
              tariffs = sanitizeRates(data, DEFAULT_TARIFFS);
              toast('Tariffs loaded.', 'good');
            }else if(data.meta && 'po_number' in data.meta){
              poRates = sanitizeRates(data, DEFAULT_PO_RATES);
              toast('PO rates loaded.', 'good');
            }else{
              toast('Unknown rates file.', 'warn');
            }
            renderRatesTable();
          }catch{ toast('Malformed JSON.', 'warn'); }
        };
        reader.readAsText(file);
      });
      ev.target.value='';
    }

    function downloadJson(obj,name){
      const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=name;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},1000);
    }

    function exportCsv(){
      computeSes();
      if(!sesRows.length){ toast('No data for CSV.', 'warn'); return; }
      const note=monthLabel();
      const lines=['ServiceCode,ServiceName,UnitAdjusted,ContractRate,AmountSES,Note'];
      sesRows.forEach(r=>{
        if(Math.abs(r.ses)<=0.004) return;
        const qty=r.code==='PF_CHARGE_SLAB1'?r.adj.toFixed(6):r.adj.toFixed(2);
        lines.push(`${r.code},${r.name},${qty},${r.rate.toFixed(2)},${r.ses.toFixed(2)},${note}`);
      });
      const csv=lines.join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=`SES_${note}.csv`;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},1000);
    }

    function computeSes(){
      const body=$('ratesBody'); if(!body) return;
      sesRows=[];
      let totalD=0,totalG=0,dEnergy=0;
      SERVICE_LIST.forEach(s=>{
        const qtyEl=$('qty_'+s.code);
        const tarEl=$('tar_'+s.code);
        const poEl=$('po_'+s.code);
        const dEl=$('d_'+s.code);
        const fEl=$('f_'+s.code);
        const gEl=$('g_'+s.code);
        let B=parseFloat(qtyEl?.value)||0;
        const C=parseFloat(tarEl?.value)||0;
        const E=parseFloat(poEl?.value)||0;
        let D=0,F=0,G=0;
        if(s.code==='FCA'){
          B=parseFloat($('qty_EC_SLAB1')?.value)||0;
          if(qtyEl) qtyEl.value=B;
          D=B*C;
          F=E?D/E:0;
        }else if(s.code==='TOD_NIGHT_REBATE'){
          D=-B*C;
          F=E?D/E:0;
        }else if(s.code==='PF_CHARGE_SLAB1'){
          const pf=B;
          D=-((pf-0.95)*dEnergy/2);
          F=E?D/E:0;
        }else if(s.code.startsWith('ARREAR_')){
          D=B*C;
          F=D;
        }else if(s.code==='WIND_ENERGY_CREDIT'){
          D=B*C;
          F=E?D/E:0;
        }else{
          D=B*C;
          F=E?D/E:0;
        }
        if(s.code==='EC_SLAB1') dEnergy=D;
        G=(s.code==='WIND_ENERGY_CREDIT')?D:E*F;
        totalD+=D; totalG+=G;
        sesRows.push({code:s.code,name:s.name,adj:F,rate:E,ses:G});
        if(dEl) dEl.textContent = Math.abs(D)<0.005 ? '—' : INR.format(D);
        if(fEl){const prec=s.code==='PF_CHARGE_SLAB1'?6:2; fEl.textContent=Math.abs(F)<0.005?'—':F.toFixed(prec);}
        if(gEl) gEl.textContent = Math.abs(G)<0.005 ? '—' : INR.format(G);
      });
      const badge=$('parityBadge');
      if(badge){
        badge.textContent=`ΣD ${INR.format(totalD)} | ΣG ${INR.format(totalG)} | Δ ${INR.format(totalG-totalD)}`;
        badge.classList.remove('good','bad');
        badge.classList.add(Math.abs(totalG-totalD)<=0.05?'good':'bad');
      }
    }

    function initRatesManager(){
      if(!$('ratesCard')) return;
      loadRates();
      renderRatesTable();
      $('importRates')?.addEventListener('click', ()=>$('ratesFile')?.click());
      $('ratesFile')?.addEventListener('change', handleImport);
      $('downloadTariffs')?.addEventListener('click', ()=>{updateRatesFromInputs();downloadJson(tariffs,'tariffs.json');});
      $('downloadPoRates')?.addEventListener('click', ()=>{updateRatesFromInputs();downloadJson(poRates,'po_rates.json');});
      $('editRates')?.addEventListener('click', toggleEditRates);
      $('saveRates')?.addEventListener('click', saveRates);
      $('exportCsv')?.addEventListener('click', exportCsv);
    }

    const toInr = v => INR.format(Number.isFinite(v) ? v : 0);
      const toRate = v => RATE.format(Number.isFinite(v) ? v : 0) + ' /kWh';
    function parseInrInput(el){
      const raw = el.value.replace(/[^0-9.\-]/g,'');
      const v = parseFloat(raw);
      if(Number.isFinite(v)){
        el.dataset.value = v;
        el.value = toInr(v);
      }else{
        el.dataset.value = '';
        el.value = '';
      }
    }

    const debounce = (fn, delay=200) => {
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); };
    };

    function confirmModal(msg){
      return new Promise(resolve=>{
        const m = $('modal');
        const okBtn = $('modalOk');
        const cancelBtn = $('modalCancel');
        const prev = document.activeElement;
        $('modalText').textContent = msg;
        m.style.display = 'flex';
        okBtn.focus();
        const ok = ()=>{ cleanup(); resolve(true); };
        const cancel = ()=>{ cleanup(); resolve(false); };
        const esc = e=>{ if(e.key==='Escape') cancel(); };
        const backdrop = e=>{ if(e.target===m) cancel(); };
        function cleanup(){
          okBtn.removeEventListener('click', ok);
          cancelBtn.removeEventListener('click', cancel);
          document.removeEventListener('keydown', esc);
          m.removeEventListener('click', backdrop);
          m.style.display = 'none';
          if(prev) prev.focus();
        }
        okBtn.addEventListener('click', ok, { once:true });
        cancelBtn.addEventListener('click', cancel, { once:true });
        document.addEventListener('keydown', esc);
        m.addEventListener('click', backdrop);
      });
    }

    function validate(){
      let ok = true;
      const percentIds = ['B15','D15','C16'];
      const sciIds = ['A4','A17','B17','C17','D17','E17','B15','D15','C16'];
      document.querySelectorAll('input').forEach(el=>{
        if(el.type==='month' || el.type==='file') return;
        const hint = el.nextElementSibling;
        if(!hint || !hint.classList.contains('hint')) return;
        hint.textContent=''; hint.style.display='none';
        el.classList.remove('invalid');

        const raw = el.dataset.value ?? el.value;
        if (sciIds.includes(el.id) && /e/i.test(String(raw))) {
          hint.textContent='Scientific notation not allowed.'; hint.style.display='block'; el.classList.add('invalid'); ok = false; return;
        }
        const val = parseFloat(raw);
        if (!Number.isFinite(val)) return; // allow empty/unfilled during typing

        if (percentIds.includes(el.id)) {
          if (val < 0 || val > 100) { hint.textContent='0–100 only.'; hint.style.display='block'; el.classList.add('invalid'); ok = false; }
        } else if (val < 0) {
          hint.textContent='≥ 0 only.'; hint.style.display='block'; el.classList.add('invalid'); ok = false;
        }
      });
      return ok;
    }

    function compute(strict=false){
      const ok = validate();
      // HT Bill
      const A4=num('A4'), B4=num('B4'), C4=num('C4'), D4=num('D4'), E4=num('E4'), F4=num('F4'), G4=num('G4'), H4=num('H4'), I4=num('I4');
      const A9 = B4 + C4 + D4 + E4 - F4 - G4 + H4 + I4;
      const B9 = A9 * 0.2;
      const C9 = A9 + B9;
      $('A9v').textContent = toInr(A9);
      $('B9v').textContent = toInr(B9);
      $('C9v').textContent = toInr(C9);

      // Adjustments
      const D9=num('D9'), E9=num('E9'), F9=num('F9'), G9=num('G9');
      const H9 = C9 + D9 + F9 - G9;
      const I9 = H9 - E9;
      const A31 = D9 - E9;
      $('H9v').textContent = toInr(H9);
      $('I9v').textContent = toInr(I9);
      $('A31v').textContent = toInr(A31);

      // WEG Inputs
      const B15=num('B15'), D15=num('D15'), C16=num('C16');
      const A17=num('A17'), B17=num('B17'), C17=num('C17'), D17=num('D17'), E17=num('E17');
      const bit_mwh = A17 + B17;
      const nan_mwh = C17 + D17 + E17;
      const A18 = roundUp0((bit_mwh)*1000*(B15/100)*(1-(C16/100)));
      const C18 = roundUp0((nan_mwh)*1000*(D15/100)*(1-(C16/100)));
      const A19 = A18 + C18;
      $('A18v').textContent = KWH.format(A18) + ' kWh';
      $('C18v').textContent = KWH.format(C18) + ' kWh';
      $('A19v').textContent = KWH.format(A19) + ' kWh';

      // Credits/Debits
      const A24=num('A24'), B24=num('B24'), C24=num('C24'), D24=num('D24'), E24=num('E24'), F24=num('F24');
      const A26 = A24 + B24;
      const B26 = D24 + E24 + F24;
      const C26 = A26 - B26;
      $('A26v').textContent = toInr(A26);
      $('B26v').textContent = toInr(B26);
      $('C26v').textContent = toInr(C26);

      // Rates & Shares
      const B19 = (A19===0) ? 0 : (C26 / A19);
      const F16 = B19 * A18;
      const G16 = B19 * C18;
      $('B19v').textContent = toRate(B19);
      $('windRateWarn').style.display = (A19===0) ? 'block' : 'none';
      $('F16v').textContent = toInr(F16);
      $('G16v').textContent = toInr(G16);

      // Final Bill for IOM
      const FINAL = C9 - F16 - G16 - C24 + A31 + F9; // C9 − F16 − G16 − Credit TDS + Balance Pending + Delay Charges
      $('FINALv').textContent = toInr(FINAL);

      // Cross-check: I9 (= H9 − E9) should reconcile with FINAL
      const I9_check = (Number(H9) || 0) - (Number(E9) || 0);
      const deltaFinal = FINAL - I9_check;
      const badge = $('finalCheckBadge');
      if (badge) {
        const i9Span = $('I9checkv'), dSpan = $('FINALdeltav');
        const statusSpan = $('FINALstatusv');
        const withinTol = Math.abs(deltaFinal) <= FINAL_CHECK_TOL;
        if (i9Span) i9Span.textContent = toInr(I9_check);
        if (dSpan) dSpan.textContent = toInr(deltaFinal);
        // Visual state + symbol
        badge.classList.remove('good','bad');
        badge.classList.add(withinTol ? 'good' : 'bad');
        if (statusSpan) statusSpan.textContent = withinTol ? '✓' : '✗';
        // Accessibility: narrate current status & values
        const a11y =
          `Final check: I9 ${toInr(I9_check)}, delta vs FINAL ${toInr(deltaFinal)}, `
          + (withinTol ? 'status OK' : 'status NOT OK');
        badge.setAttribute('aria-label', a11y);
        badge.title = a11y;
      }
      computeSes();
      persistDebounced();
      return strict && !ok ? null : { A4,B4,C4,D4,E4,F4,G4,H4,I4, A9,B9,C9, D9,E9,F9,G9,H9,I9, B15,D15,C16, A17,B17,C17,D17,E17, A18,C18,A19, A24,B24,C24,D24,E24,F24, A26,B26,C26, B19,F16,G16, A31, FINAL, I9_check };
    }

    // Reuse formatters from existing code:
    const INR_FMT = new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR', maximumFractionDigits:2 });
    const asINR = v => Number.isFinite(+v) ? INR_FMT.format(+v) : (v ?? '');
    // DO NOT EDIT — Stability Guard:
    // Per stakeholder directive these identifiers never change and must NOT be read from inputs/models.
    const SAP_VENDOR_CODE = 'ZG0435';
    const SAP_BANKT = 'SBI1';

    function buildHtmlSections(model) {
      const order = [
        ['HT Bill','HT Bill (calc)'],
        ['Adjust','Adjust (calc)'],
        ['WEG','WEG (calc)'],
        ['Wind Credits','Wind Debits','Wind (calc)'],
        ['FINAL']
      ];
      const secs = {};
      const add = (s, field, cell, val, unit='') => {
        (secs[s] ||= []).push({ field, cell, val, unit });
      };

      // HT Bill
      add('HT Bill','Monthly Consumption','A4', model.A4,'kWh');
      add('HT Bill','Demand Charges','B4', model.B4,'₹');
      add('HT Bill','Energy Charges','C4', model.C4,'₹');
      add('HT Bill','Night Rebate','D4', model.D4,'₹');
      add('HT Bill','Fuel Charge','E4', model.E4,'₹');
      add('HT Bill','PF Rebate','F4', model.F4,'₹');
      add('HT Bill','EHV Rebate','G4', model.G4,'₹');
      add('HT Bill','TOU','H4', model.H4,'₹');
      add('HT Bill','GT Charges','I4', model.I4,'₹');

      add('HT Bill (calc)','Total Consumption Charge','A9', model.A9,'₹');
      add('HT Bill (calc)','ED @ 20%','B9', model.B9,'₹');
      add('HT Bill (calc)','Current Month Bill','C9', model.C9,'₹');

      // Adjust
      add('Adjust','Outstanding Arrears','D9', model.D9,'₹');
      add('Adjust','Freeze Amount','E9', model.E9,'₹');
      add('Adjust','Delayed Payment Charges','F9', model.F9,'₹');
      add('Adjust','Advance Payment / Adjust.','G9', model.G9,'₹');
      add('Adjust (calc)','Net Payable','H9', model.H9,'₹');
      add('Adjust (calc)','Actual Amount to be Paid','I9', model.I9,'₹');
      add('Adjust (calc)','Balance Pending from Previous Month','A31', model.A31,'₹');

      // WEG
      add('WEG','Share Bitlavadia (%)','B15', model.B15,'%');
      add('WEG','Share Nanisindhodi (%)','D15', model.D15,'%');
      add('WEG','Transmission Loss (%)','C16', model.C16,'%');
      add('WEG','Bitlavadia MWh #1','A17', model.A17,'MWh');
      add('WEG','Bitlavadia MWh #2','B17', model.B17,'MWh');
      add('WEG','Nanisindhodi MWh #1','C17', model.C17,'MWh');
      add('WEG','Nanisindhodi MWh #2','D17', model.D17,'MWh');
      add('WEG','Nanisindhodi MWh #3','E17', model.E17,'MWh');
      add('WEG (calc)','Bitlavadia Share (kWh)','A18', model.A18,'kWh');
      add('WEG (calc)','Nanisindhodi Share (kWh)','C18', model.C18,'kWh');
      add('WEG (calc)','Total Allocated (kWh)','A19', model.A19,'kWh');

      // Wind Credits / Debits
      add('Wind Credits','Credit Board Charges','A24', model.A24,'₹');
      add('Wind Credits','Credit ED Charges','B24', model.B24,'₹');
      add('Wind Credits','Credit TDS','C24', model.C24,'₹');
      add('Wind Debits','Debit Board Charges','D24', model.D24,'₹');
      add('Wind Debits','Debit Electricity Duty','E24', model.E24,'₹');
      add('Wind Debits','Debit Wheeling Charges','F24', model.F24,'₹');
      add('Wind (calc)','Total Credit','A26', model.A26,'₹');
      add('Wind (calc)','Total Debit','B26', model.B26,'₹');
      add('Wind (calc)','Net Wind Credit','C26', model.C26,'₹');
      add('Wind (calc)','Wind Rate (₹/kWh)','B19', model.B19,'₹/kWh');
      add('Wind (calc)','Share 4.5 MW (₹)','F16', model.F16,'₹');
      add('Wind (calc)','Share 14.7 MW (₹)','G16', model.G16,'₹');

      // FINAL
      add('FINAL','Final Bill for IOM','—', model.FINAL,'₹');

      return { secs, order };
    }

    function buildIomStatementHtml(model, monthLabel, generatedAt){
      // Remove leading rupee sign plus any regular/NBSP/NNBSP spacing
      const inrNoSymbol = (v) => String(asINR(v) || '')
        .replace(/^[₹\s\u00A0\u202F]+/, '')
        .trim();
      const el = document.createElement('div');
      el.className = 'sheet';
      const meta = generatedAt || new Date().toLocaleString();
      const metaISO = (() => { try { const d = generatedAt ? new Date(generatedAt) : new Date(); return isNaN(d) ? new Date().toISOString() : d.toISOString(); } catch { return new Date().toISOString(); } })();
      // Do not read from model: hard-coded by policy (see Stability Guard above).
      const vendorCode = SAP_VENDOR_CODE;
      const bankT = SAP_BANKT;
      try { document.title = `IOM - HT Bill – ${monthLabel}`; } catch {}
      el.innerHTML = `
        <div class="doc-header">
          <div>
            <div class="company">GAIL (India) Limited – Samakhiali, Gujarat</div>
            <div class="dept">Electrical Department</div>
            <h2 role="heading" aria-level="1">IOM - HT Bill</h2>
            <div class="mini">Billing Month: <b>${monthLabel}</b></div>
          </div>
          <div class="doc-meta">
            Generation Date: <b><time datetime="${metaISO}">${meta}</time></b>
          </div>
        </div>
        <div
          class="info-bar"
          title="Please pay to Paschim Gujarat Vij Company Ltd (Vendor Code: ${vendorCode}). Bank A/C No.: 31729314272; RTGS/NEFT IFSC: SBIN0000554; Branch: SBI – Bhachau"
          aria-label="Please pay to Paschim Gujarat Vij Company Ltd (Vendor Code: ${vendorCode}). Bank A/C No.: 31729314272; RTGS/NEFT IFSC: SBIN0000554; Branch: SBI – Bhachau"
        >Please pay to <b>Paschim&nbsp;Gujarat&nbsp;Vij&nbsp;Company&nbsp;Ltd</b> (Vendor Code: <b>${vendorCode}</b>). Bank A/C No.: <b>31729314272</b>; RTGS/NEFT IFSC: <b>SBIN0000554</b>; Branch: <b>SBI – Bhachau</b></div>
        <section class="sec mapping" role="table" aria-label="Amount Mapping (per formula)">
          <h3>Amount Mapping (per formula)</h3>
          <div class="footer-note" style="margin:0 0 6px 0;">
            Mapping: Current Month Bill – Share(4.5MW) – Share(14.7MW) – Credit TDS + Balance Pending (prev) + Delay Charges
          </div>
          <div class="kv" role="row" aria-roledescription="header">
            <div class="label" role="columnheader" style="color:#6b7280;text-transform:uppercase;font-size:11px;">Component <span class="mono">(cell)</span></div>
            <div class="value" role="columnheader" style="color:#6b7280;text-transform:uppercase;font-size:11px;">Amount</div>
            <div class="unit" role="columnheader" style="color:#6b7280;text-transform:uppercase;font-size:11px;">₹</div>
          </div>
          ${([
            ['Current Month Bill',           'C9',    model.C9,  'none'],
            ['Share of 4.5MW WEG',           'F16',   model.F16, 'minus'],
            ['Share of 14.7MW WEG',          'G16',   model.G16, 'minus'],
            ['Credit TDS',                   'C24',   model.C24, 'minus'],
            ['Balance Pending (prev)',       'A31',   model.A31, 'plus'],
            ['Delay Charges',                'F9',    model.F9,  'plus'],
          ]).map(([label, cell, val, sign]) => {
            const amt = Math.abs(+val || 0);
            const s = amt === 0 ? '' : (sign === 'minus' ? '−' : (sign === 'plus' ? '+' : ''));
            return `
            <div class="kv" role="row">
              <div class="label" role="rowheader">${label} <span class="mono">${cell}</span></div>
              <div class="value" role="cell">${s}${inrNoSymbol(amt)}</div>
              <div class="unit" role="cell">₹</div>
            </div>`;
          }).join('')}
          <div class="kv" role="row" aria-roledescription="total">
            <div class="label" role="rowheader"><b>Net Payable</b></div>
            <div class="value total" role="cell">${inrNoSymbol(model.FINAL)}</div>
            <div class="unit" role="cell">₹</div>
          </div>
        </section>
        <section class="sec" role="region" aria-labelledby="cert-h">
          <h3 id="cert-h">Certification & Attachments</h3>
          <div class="footer-note">
            The amount claimed here has not been previously paid.<br/>
            The payment of ${asINR(model.FINAL)} is certified and verified.<br/>
            The expenditure is in the interest of the company.<br/>
            Certified copies of the bills are attached.<br/>
            <span data-testid="receipt-note">Bill received via central post.</span>
          </div>
          <div class="footer-note" style="margin-top:6px;">
            Attachments: Bill copy; Credit & Debit Adjustment Details (PGVCL); SES sheet; BWS receipt.
          </div>
        </section>
        <section class="sec signatures" role="group" aria-labelledby="sig-h">
          <h3 id="sig-h">Authorizations & Signatures</h3>
          <div class="sigs">
            <div class="sig">
              <div class="line" aria-hidden="true"></div>
              <div class="role" data-testid="sig-dgm-om">DGM (O&amp;M)/WIC, Samakhiali</div>
            </div>
            <div class="sig right">
              <div class="line" aria-hidden="true"></div>
              <div class="role" data-testid="sig-sm-ele">Senior Manager (ELE)</div>
            </div>
            <div class="sig">
              <div class="line" aria-hidden="true"></div>
              <div class="role" data-testid="sig-dgm-fa">DGM (F&amp;A), Jaipur</div>
            </div>
          </div>
        </section>
        <div class="footer-note" style="margin-top:6mm;">Keep this PDF with the source data for audit.</div>
        <div class="page-number" aria-hidden="true">Page 1</div>`;
      // Accessibility: hide decorative page number from AT if present
      try {
        const pn = el.querySelector('.page-number');
        if (pn) pn.setAttribute('aria-hidden','true');
      } catch {}
      return el;
    }

    function renderHtmlPreview(model, monthLabel, generatedAt) {
      const host = document.getElementById('htmlPrintHost');
      host.innerHTML = '';
      host.dataset.monthLabel = monthLabel || '';
      const sheet = buildIomStatementHtml(model, monthLabel, generatedAt);
      host.appendChild(sheet);
      sheet.scrollIntoView({ behavior: 'smooth' });
      host.focus({ preventScroll: true });
    }

    function buildDakReceiptHtml(d){
      const el = document.createElement('div');
      el.className = 'sheet';
      const amtClean = String(d.amount || '').replace(/[^0-9.-]/g,'');
      const amtNum = parseFloat(amtClean || '0');
      const amtFmt = new Intl.NumberFormat('en-IN',{ style:'currency', currency:'INR', maximumFractionDigits:2 }).format(amtNum) + '/-';
      el.innerHTML = `
        <div class="page-number" aria-hidden="true">1</div>
        <div style="text-align:center;margin-bottom:12px;">
          <div style="font-weight:700;font-size:16pt;">GAIL (India) LIMITED</div>
          <div>IPS Samakhiali</div>
          <div style="font-size:12.5pt;">Central Dak Receipt Format</div>
        </div>
        <div style="font-size:12pt;display:grid;grid-template-columns:auto 1fr;column-gap:8px;row-gap:4px;margin-top:20px;">
          <div>1. Vendor Code:</div><div><b>${d.vendorCode || ''}</b></div>
          <div>2. Vendor Name:</div><div><b>${d.vendorName || ''}</b></div>
          <div>3. Bill No.:</div><div><b>${d.billNo || ''}</b></div>
          <div>4. Bill Date:</div><div><b>${d.billDate || ''}</b></div>
          <div>5. Amount:</div><div><b>${amtFmt}</b></div>
          <div>6. EIC Name:</div><div><b>${d.eic || ''}</b></div>
        </div>
        <div style="margin-top:40px;text-align:right;">
          <div style="display:inline-block;width:60mm;text-align:center;">
            <div style="border-top:1px solid #000;height:0;margin-bottom:4px;"></div>
            Sign. Of Initiator
          </div>
        </div>
      `;
      return el;
    }

    async function renderDakReceipt(){
      const host = document.getElementById('htmlPrintHost');
      if(!host) return;
      const data = {
        vendorCode: document.getElementById('rc_vendorCode')?.value.trim() || '',
        vendorName: document.getElementById('rc_vendorName')?.value.trim() || '',
        billNo: document.getElementById('rc_billNo')?.value.trim() || '',
        billDate: document.getElementById('rc_billDate')?.value.trim() || '',
        amount: document.getElementById('rc_amount')?.value.trim() || '',
        eic: document.getElementById('rc_eic')?.value.trim() || ''
      };
      const btnSave = document.getElementById('saveHtmlPdf');
      const btnOpen = document.getElementById('openHtmlPdf');
      const chkAuto = document.getElementById('autoPrintHtml');
      setBusy(host, true);
      try{
        host.innerHTML = '';
        const sheet = buildDakReceiptHtml(data);
        host.appendChild(sheet);
        sheet.scrollIntoView({ behavior:'smooth' });
        host.focus({ preventScroll: true });
        // Enable print actions (robustly)
        if(typeof setDisabled === 'function'){
          setDisabled(btnSave, false);
          setDisabled(btnOpen, false);
        }
        btnSave?.removeAttribute('disabled');
        btnSave?.setAttribute('aria-disabled','false');
        btnOpen?.removeAttribute('disabled');
        btnOpen?.setAttribute('aria-disabled','false');
        if(chkAuto?.checked){
          requestAnimationFrame(()=> setTimeout(()=> window.print(), 100));
        }
      } finally {
        setBusy(host, false);
      }
    }


      // Excel workbook in memory (lazy init)
      let WB = null;
  function getWB(){
        if(!window.XLSX) return null;
        if(!WB){
          WB = XLSX.utils.book_new();
          WB.Props = { Title:'WEG Billing Workbook', Author:'WEG Billing Calculator', CreatedDate:new Date() };
        }
        return WB;
      }

    const LS_KEY = 'weg-billing-v1';

    function persist(){
      const inputs = {};
      document.querySelectorAll('input').forEach(el=>{
        inputs[el.id] = el.value;
      });
      const _wb = getWB();
      canonicalizeWorkbook();
      const data = { inputs, sheets: _wb ? _wb.SheetNames.slice() : [] };
      localStorage.setItem(LS_KEY, JSON.stringify(data));
    }

    const persistDebounced = debounce(persist, 200);

    function restore(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return false;
        const data = JSON.parse(raw);
        if(data.inputs){
          Object.entries(data.inputs).forEach(([id,val])=>{
            const el = $(id);
            if(el){
              el.value = val;
              if(el.type==='text') parseInrInput(el);
            }
          });
        }
        if(Array.isArray(data.sheets)){
          const _wb = getWB();
          if(_wb){
            _wb.SheetNames = data.sheets;
            canonicalizeWorkbook();
          }
        }
        return true;
      }catch(err){
        console.error(err);
      }
      return false;
    }

    function refreshSheetList(){
      canonicalizeWorkbook();
      const list = $('sheetList');
      list.innerHTML = '';
      const _wb = getWB();
      if(!_wb) return;
      const names = _wb.SheetNames || [];
      const renderNames = sortDisplayNames(names);
      const active = $('billMonth').value;
      let hasFocusable = false;
      renderNames.forEach((name, idx) => {
        const pill = document.createElement('span');
        pill.className = 'pill';
        pill.setAttribute('role','option');
        const isActive = name === active;
        if (isActive) {
          pill.setAttribute('aria-selected','true');
          pill.tabIndex = 0;
          hasFocusable = true;
        } else {
          pill.tabIndex = -1;
        }

        const btnGo = document.createElement('button');
        btnGo.className = 'ghost';
        btnGo.tabIndex = -1;
        btnGo.textContent = name;
        btnGo.setAttribute('aria-label', `Open ${name}`);
        btnGo.addEventListener('click', () => {
          // Only write to <input type="month"> if the sheet name is canonical YYYY-MM.
          const mm = /^\d{4}-(0[1-9]|1[0-2])$/.test(name) ? name : null;
          if (mm) {
            $('billMonth').value = mm;
          } else {
            // Keep UX calm: just inform without breaking flow.
            toast(`Sheet "${name}" isn’t a YYYY-MM label. Month picker left unchanged.`, 'info');
          }
          // Continue with compute() so the action still proceeds as before.
          compute();
          list.querySelectorAll('[role="option"]').forEach(o => { o.tabIndex = -1; o.removeAttribute('aria-selected'); });
          pill.setAttribute('aria-selected','true');
          pill.tabIndex = 0;
          pill.focus();
        });

        const btnDel = document.createElement('button');
        btnDel.className = 'ghost';
        btnDel.tabIndex = -1;
        btnDel.setAttribute('aria-label', `Remove ${name}`);
        btnDel.textContent = '×';
        btnDel.addEventListener('click', async (e) => {
          e.stopPropagation();
          const options = [...list.querySelectorAll('[role="option"]')];
          const i = options.indexOf(pill);
          if(!(await confirmModal(`Remove sheet "${name}" from the workbook?`))) return;
          const wb = getWB(); if(!wb) return;
          delete wb.Sheets[name];
          wb.SheetNames = wb.SheetNames.filter(n => n !== name);
          canonicalizeWorkbook();
          toast(`Removed sheet: ${name}`, 'good');
          refreshSheetList();
          const next = list.querySelectorAll('[role="option"]')[i] || list.querySelector('[role="option"]:last-child');
          next?.focus();
        });

        pill.append(btnGo, btnDel);
        pill.addEventListener('keydown', (e) => {
          const focusOption = dir => {
            const options = [...list.querySelectorAll('[role="option"]')];
            const i = options.indexOf(document.activeElement);
            const j = Math.max(0, Math.min(options.length - 1, i + dir));
            options[j]?.focus();
          };
          if (e.key === 'ArrowRight') { e.preventDefault(); focusOption(1); }
          if (e.key === 'ArrowLeft')  { e.preventDefault(); focusOption(-1); }
          if (e.key === 'Home')       { e.preventDefault(); list.querySelector('[role="option"]')?.focus(); }
          if (e.key === 'End')        { e.preventDefault(); [...list.querySelectorAll('[role="option"]')].pop()?.focus(); }
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btnGo.click(); }
          if (e.key === 'Delete') { e.preventDefault(); btnDel.click(); }
        });

        list.appendChild(pill);
      });
      if (!hasFocusable) {
        const last = list.querySelector('[role="option"]:last-child');
        if (last) last.tabIndex = 0;
      }
      list.scrollLeft = list.scrollWidth;
      persistDebounced();
    }

    function buildSheetData(model, monthLabel){
      const rows = [];
      // Always push a row array, even if r(['a','b']) or r('a','b') is used.
      function r(...cells){
        const row = (cells.length === 1 && Array.isArray(cells[0])) ? cells[0] : cells;
        rows.push(row);
      }

        const DANGEROUS_FORMULA = /^[=+@]/;
        const isPlainNegativeNumber = s => /^-\d+(\.\d+)?$/.test(s);
        const looksLikeYYYYMM = s => /^\d{4}-(0[1-9]|1[0-2])$/.test(s);
        function forceText(v){
          if (v == null) return '';
          const s = String(v);
          if (DANGEROUS_FORMULA.test(s)) return { t:'s', v:s, z:'@' };
          if (s.startsWith('-') && !isPlainNegativeNumber(s)) return { t:'s', v:s, z:'@' };
          return looksLikeYYYYMM(s) ? { t:'s', v:s, z:'@' } : s;
        }

      // Header row
      r(['WEG Billing – Month', monthLabel]);
      r(['Generated at', new Date().toLocaleString()]);
      r([]);

      r(['SECTION','FIELD','CELL','VALUE','UNITS/NOTES']);
      // HT Bill
      r(['HT Bill','Monthly Consumption','A4', model.A4, 'kWh']);
      r(['HT Bill','Demand Charges','B4', model.B4, '₹']);
      r(['HT Bill','Energy Charges','C4', model.C4, '₹']);
      r(['HT Bill','Night Rebate','D4', model.D4, '₹']);
      r(['HT Bill','Fuel Charge','E4', model.E4, '₹']);
      r(['HT Bill','PF Rebate','F4', model.F4, '₹']);
      r(['HT Bill','EHV Rebate','G4', model.G4, '₹']);
      r(['HT Bill','TOU','H4', model.H4, '₹']);
      r(['HT Bill','GT Charges','I4', model.I4, '₹']);
      // mark calculated rows as currency so Excel formats them
      r(['HT Bill (calc)','Total Consumption Charge','A9', model.A9, '₹']);
      r(['HT Bill (calc)','ED @ 20%','B9', model.B9, '₹']);
      r(['HT Bill (calc)','Current Month Bill','C9', model.C9, '₹']);
      r([]);

      // Adjustments
      r(['Adjust','Outstanding Arrears','D9', model.D9, '₹']);
      r(['Adjust','Freeze Amount','E9', model.E9, '₹']);
      r(['Adjust','Delayed Payment Charges','F9', model.F9, '₹']);
      r(['Adjust','Advance Payment / Adjust.','G9', model.G9, '₹']);
      r(['Adjust (calc)','Net Payable','H9', model.H9, '₹']);
      r(['Adjust (calc)','Actual Amount to be Paid','I9', model.I9, '₹']);
      r(['Adjust (calc)','Balance Pending from Previous Month','A31', model.A31, '₹']);
      r([]);

      // WEG Inputs
      r(['WEG','Share Bitlavadia (%)','B15', model.B15, '%']);
      r(['WEG','Share Nanisindhodi (%)','D15', model.D15, '%']);
      r(['WEG','Transmission Loss (%)','C16', model.C16, '%']);
      r(['WEG','Bitlavadia MWh #1','A17', model.A17, 'MWh']);
      r(['WEG','Bitlavadia MWh #2','B17', model.B17, 'MWh']);
      r(['WEG','Nanisindhodi MWh #1','C17', model.C17, 'MWh']);
      r(['WEG','Nanisindhodi MWh #2','D17', model.D17, 'MWh']);
      r(['WEG','Nanisindhodi MWh #3','E17', model.E17, 'MWh']);
      r(['WEG (calc)','Bitlavadia Share (kWh)','A18', model.A18, 'kWh']);
      r(['WEG (calc)','Nanisindhodi Share (kWh)','C18', model.C18, 'kWh']);
      r(['WEG (calc)','Total Allocated (kWh)','A19', model.A19, 'kWh']);
      r([]);

      // Credits & Debits
      r(['Wind Credits','Credit Board Charges','A24', model.A24, '₹']);
      r(['Wind Credits','Credit ED Charges','B24', model.B24, '₹']);
      r(['Wind Credits','Credit TDS','C24', model.C24, '₹']);
      r(['Wind Debits','Debit Board Charges','D24', model.D24, '₹']);
      r(['Wind Debits','Debit Electricity Duty','E24', model.E24, '₹']);
      r(['Wind Debits','Debit Wheeling Charges','F24', model.F24, '₹']);
      r(['Wind (calc)','Total Credit','A26', model.A26, '₹']);
      r(['Wind (calc)','Total Debit','B26', model.B26, '₹']);
      r(['Wind (calc)','Net Wind Credit','C26', model.C26, '₹']);
      r(['Wind (calc)','Wind Rate (₹/kWh)','B19', model.B19, '₹/kWh']);
      r(['Wind (calc)','Share 4.5 MW (₹)','F16', model.F16, '₹']);
      r(['Wind (calc)','Share 14.7 MW (₹)','G16', model.G16, '₹']);
      r([]);

      // Final
      r(['FINAL','Final Bill for IOM','—', model.FINAL, '₹']);

      const valueCol = 3;          // VALUE index
      const NUM = x => (typeof x === 'number' ? x
                : (x==='' || x==null ? null : Number(String(x).replace(/[, ]/g,''))));

      const typedRows = rows.map(row => {
        // Guard: row must be an array
        if (!Array.isArray(row)) row = [String(row)];   // last-resort safety net
        const out = row.slice();

        // A,B,C,E -> text
        [0,1,2,4].forEach(ci => { if (ci in out) out[ci] = forceText(out[ci]); });

        // VALUE -> numeric or blank
        if (valueCol in out) {
          const n = NUM(out[valueCol]);
          out[valueCol] = (n==null || !isFinite(n)) ? { t:'z' } : { t:'n', v:n };
        }
        return out;
      });

      if (window.DEV) {
        const bad = typedRows.find(r => !Array.isArray(r));
        if (bad) console.error('Export row not array:', bad);
      }

      const ws = XLSX.utils.aoa_to_sheet(typedRows);

      const firstDataRow = 4;                    // month, generated-at, blank, header
      const lastRow = typedRows.length - 1;
      const unitAt = ri => {
        const u = typedRows[ri] && typedRows[ri][4];
        return (u && u.v) || u || '';
      };

      for (let r = firstDataRow; r <= lastRow; r++) {
        const addr = XLSX.utils.encode_cell({ r, c: valueCol });
        const cell = ws[addr];
        if (!cell || cell.t !== 'n') continue;
        const unit = unitAt(r);
        if (unit === '%') { cell.v = cell.v / 100; cell.z = '0.00%'; }
        else if (unit === '₹') { cell.z = '₹#,##0.00'; }
        else if (unit === '₹/kWh') { cell.z = '₹#,##0.000000'; }
        else if (unit === 'MWh') { cell.z = '0.000'; }
        else if (unit === 'kWh') { cell.z = '#,##0'; }
        else { cell.z = '#,##0.00'; }
      }

      // Column widths + proper AutoFilter over the 5 columns (A:E)
      ws['!cols'] = [{wch:18},{wch:32},{wch:8},{wch:16},{wch:36}];
      ws['!autofilter'] = { ref: XLSX.utils.encode_range({ s:{ r:firstDataRow-1, c:0 }, e:{ r:lastRow, c:4 } }) };
      return ws;
    }

      // --- Display-only sorting: canonical YYYY-MM first (desc), then legacy (stable) ---
      function sortDisplayNames(names){
        const isYYYYMM = n => /^\d{4}-(0[1-9]|1[0-2])$/.test(n);
        const canonical = [];
        const legacy = [];
        for (const n of names) (isYYYYMM(n) ? canonical : legacy).push(n);
        // Descending chronological: 2025-12 > 2025-11 > ... > 2024-01
        canonical.sort((a,b) => {
          // Fast string compare works for YYYY-MM if both canonical and we want desc
          // but be explicit for clarity.
          const [ay,am] = a.split('-').map(Number);
          const [by,bm] = b.split('-').map(Number);
          if (ay !== by) return by - ay;
          return bm - am;
        });
        // legacy remains in original order (stable)
        return canonical.concat(legacy);
      }

      // Determine month label in YYYY-MM format, defaulting to current month
      function monthLabel(){
        const m = $('billMonth').value;
        if (m && /^\d{4}-(0[1-9]|1[0-2])$/.test(m)) return m;
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        return `${yyyy}-${mm}`;
      }

      function normalizeSheetNames(names){
        // Non-destructive: unique + lexicographic sort; do NOT filter legacy/non-YYYY-MM names.
        return Array.from(new Set(names))
          .sort((a,b)=>a.localeCompare(b));
      }

      function canonicalizeWorkbook(){
        const wb = getWB(); if(!wb) return;
        wb.SheetNames = normalizeSheetNames(
          (wb.SheetNames || []).filter(n => !!wb.Sheets[n])
        );
      }

      function fillSampleData(){
        Object.entries(SAMPLE).forEach(([id,val])=>{
          const el = $(id);
          el.value = val;
          if(el.type==='text') parseInrInput(el);
        });
      }

      function prevMonthLabel(label){
        try{
          const [y,m] = String(label || '').split('-').map(n=>parseInt(n,10));
          if(!y || !m) return label;
          const d = new Date(y, m - 1, 1);
          d.setMonth(d.getMonth() - 1);
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth() + 1).padStart(2, '0');
          return `${yyyy}-${mm}`;
        }catch{ return label; }
      }

      function inWords(value){
        const a = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
        const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
        const num = Math.round(Number(value) || 0);
        if(num === 0) return 'Zero';
        const toWords = n => {
          if(n < 20) return a[n];
          const tens = Math.floor(n / 10);
          const ones = n % 10;
          return [b[tens], a[ones]].filter(Boolean).join(' ');
        };
        const parts = [];
        const crore = Math.floor(num / 1e7);
        const lakh = Math.floor(num / 1e5) % 100;
        const thousand = Math.floor(num / 1000) % 100;
        const hundred = Math.floor(num / 100) % 10;
        const rest = num % 100;
        if(crore) parts.push(toWords(crore) + ' Crore');
        if(lakh) parts.push(toWords(lakh) + ' Lakh');
        if(thousand) parts.push(toWords(thousand) + ' Thousand');
        if(hundred) parts.push(toWords(hundred) + ' Hundred');
        if(rest) parts.push(toWords(rest));
        return parts.join(' ').trim();
      }

      function buildSapLongText(model, billMonth){
        const prev = prevMonthLabel(billMonth);
        const amt = v => `${INR.format(Number(v || 0))}/-.`;
        const totalCreditAdj = Number(model.F16 || 0) + Number(model.G16 || 0);
        const totalDebit = Number(model.D24 || 0) + Number(model.E24 || 0) + Number(model.F24 || 0) + Number(model.F9 || 0);
        const balPrev = Number(model.E9 || 0) - Number(model.D9 || 0);
        const lines = [
          'Long Text for SAP:',
          `Bill Certification for ${billMonth} as given below: -`,
          `1. Current Month Bill for ${billMonth}: ${amt(model.C9)}`,
          `2. Total credit adjustment of wind generation for ${prev} month: ${amt(totalCreditAdj)}`,
          '   Breakup of share of wind energy credit is as follows:',
          `   A. Share of 4.5MW WEG: ${amt(model.F16)}`,
          `   B. Share 14.7MW WEG: ${amt(model.G16)}`,
          '3. CREDIT ADJUSTMENT AMOUNT:',
          `   3.05. Credit Board Charges: ${amt(model.A24)}`,
          `   3.08. Credit ED Charges: ${amt(model.B24)}`,
          `   3.14. Credit TDS: ${amt(model.C24)}`,
          `   Total Credit: ${amt(model.A26)}`,
          '4. DEBIT ADJUSTMENT AMOUNT:',
          `   4.1. Debit Board Charges: ${amt(model.D24)}`,
          `   4.2. Debit Electricity duty: ${amt(model.E24)}`,
          `   4.3. Debit Wheeling Charges: ${amt(model.F24)}`,
          `   4.4. Delayed Payment Charges: ${amt(model.F9)}`,
          `   Total Debit: ${amt(totalDebit)}`,
          `6. Balance pending credit of Previous Month (if any) (=Freeze Amount – Out Standing Arrear): ${amt(balPrev)}`,
          `7. Final Bill (=Current Month Bill + Debit Adjustment - Credit Adjustment - Balance pending credit of Previous Month): ${amt(model.FINAL)}`,
          ''
        ];
        const finalAmt = Number(model.FINAL || 0);
        lines.push(`Rupees ${inWords(finalAmt)} Only`);
        return lines.join('\n');
      }

    document.addEventListener('DOMContentLoaded', () => {
      initRatesManager();
      document.querySelectorAll('input[type="text"]').forEach(el=>{
        el.addEventListener('input', ()=>{ parseInrInput(el); compute(); });
        el.addEventListener('blur', ()=>parseInrInput(el));
      });
      document.querySelectorAll('input:not([type="text"])').forEach(el=>{
        el.addEventListener('input', compute);
      });

      const sciIds = ['A4','A17','B17','C17','D17','E17','B15','D15','C16'];
      const showSciHint = el=>{
        const hint = el.nextElementSibling;
        if(hint && hint.classList.contains('hint')){
          hint.textContent = 'Scientific notation not allowed.';
          hint.style.display = 'block';
          el.classList.add('invalid');
        }
      };
      sciIds.forEach(id=>{
        const el=$(id); if(!el) return;
        el.addEventListener('keydown', e=>{
          if(e.key==='e' || e.key==='E'){ e.preventDefault(); showSciHint(el); }
        });
        el.addEventListener('paste', e=>{
          const txt = (e.clipboardData || window.clipboardData).getData('text');
          if(/e/i.test(txt)){ e.preventDefault(); showSciHint(el); }
        });
      });

      ['B15','D15','C16'].forEach(id=>{
        const el=$(id); if(!el) return;
        el.addEventListener('blur', ()=>{
          let v = parseFloat(el.value);
          if(Number.isFinite(v)){
            if(v<0) v=0; if(v>100) v=100;
            el.value = v; el.dataset.value = v;
          }
          compute();
        });
      });

      $('addSheet').addEventListener('click', () => withBusy('addSheet', async () => {
        if (!(await loadXLSX())) return;
        const _wb = getWB(); if(!_wb) return;
        const model = compute(true);
        if (!model) { toast('Fix highlighted inputs before adding the month sheet.', 'warn'); return; }
        const label = monthLabel();
        const ws = buildSheetData(model, label);
        const exists = _wb.SheetNames.includes(label);
        _wb.Sheets[label] = ws;
        if (!exists) _wb.SheetNames.push(label);
        canonicalizeWorkbook();
        toast(`${exists ? 'Updated' : 'Added'} sheet: ${label}`, 'good');
        refreshSheetList();
      }));

      let __dlInFlight = false;
      $('downloadExcel').addEventListener('click', () => withBusy('downloadExcel', async () => {
        if (__dlInFlight) return;
        __dlInFlight = true;
        try{
          if (!(await loadXLSX())) return;
        const _wb = getWB(); if(!_wb) return;
        const auto = $('autoUpdateOnDownload')?.checked;

        if (auto) {
          const model = compute(true);
          if (!model) { toast('Cannot download: fix inputs first.', 'warn'); return; }
          const label = monthLabel();
          const ws = buildSheetData(model, label);
          const exists = _wb.SheetNames.includes(label);
          _wb.Sheets[label] = ws;
          if(!exists) _wb.SheetNames.push(label);
        }

        canonicalizeWorkbook();
        if ((_wb.SheetNames?.length || 0) === 0) {
          toast('No sheets to download. Turn on auto‑update or add a month sheet first.', 'warn');
          return;
        }

        XLSX.writeFile(_wb, `WEG_Billing_${monthLabel()}.xlsx`);
        toast('Workbook downloaded.', 'good');
        } finally { __dlInFlight = false; }
      }));

        // IOM PDF download feature removed

      // Centralize busy-state toggling to avoid drift
      function setBusy(el, on){
        if(!el) return;
        el.setAttribute('aria-busy', on ? 'true' : 'false');
      }
      // Ensure print flows always recover even if 'afterprint' is not fired by the browser
      function onPrintLifecycle({ host, reenable }) {
        let done = false;
        const finish = () => {
          if (done) return;
          done = true;
          try { setBusy(host, false); } catch(_) {}
          try { reenable?.(); } catch(_) {}
          window.removeEventListener('afterprint', finish, { once: true });
          window.removeEventListener('focus', finish, { once: true });
          document.removeEventListener('visibilitychange', onVis, { once: true });
        };
        const onVis = () => { if (document.visibilityState === 'visible') finish(); };
        window.addEventListener('afterprint', finish, { once: true });
        window.addEventListener('focus', finish, { once: true });
        document.addEventListener('visibilitychange', onVis, { once: true });
        // safety net (some environments never emit any of the above)
        setTimeout(finish, 10000);
        return finish;
      }

      const btnRender = document.getElementById('renderHtml');
      const btnSave = document.getElementById('saveHtmlPdf');
      const btnOpen = document.getElementById('openHtmlPdf');
      const chkAuto = document.getElementById('autoPrintHtml');
      const setDisabled = (el, on) => {
        if (!el) return;
        el.disabled = !!on;
        if (on) el.setAttribute('aria-disabled', 'true');
        else el.removeAttribute('aria-disabled');
      };
      const disablePrintActions = () => {
        setDisabled(btnSave, true);
        setDisabled(btnOpen, true);
      };
      disablePrintActions();

      function monthLabelStr(){
        const m = document.getElementById('billMonth')?.value;
        if (m && /^\d{4}-(0[1-9]|1[0-2])$/.test(m)) return m;
        const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      }

      if (btnRender) btnRender.addEventListener('click', () => withBusy('renderHtml', async () => {
        const host = document.getElementById('htmlPrintHost');
        if (!host) return;
        if (host.getAttribute('aria-busy') === 'true') {
          toast('Preview is busy, please wait…', 'info');
          return;
        }
        try {
          setBusy(host, true);
          setDisabled(btnRender, true);
          const model = compute(true);
          if (!model) {
            setBusy(host, false);
            if (typeof disablePrintActions === 'function') disablePrintActions();
            toast('Fix highlighted inputs before rendering.', 'warn');
            return;
          }
          renderHtmlPreview(model, monthLabelStr(), new Date().toLocaleString());
          const hasPreview = !!document.querySelector('#htmlPrintHost .sheet'); // true if preview exists
          setDisabled(btnSave, !hasPreview);
          setDisabled(btnOpen, !hasPreview);
          if (chkAuto?.checked) {
            // Ensure layout has painted before invoking print
            requestAnimationFrame(() => setTimeout(() => window.print(), 100));
          }
        } finally {
          setBusy(host, false);
          setDisabled(btnRender, false);
        }
      }));

      if (btnSave) btnSave.addEventListener('click', () => {
        const host = document.getElementById('htmlPrintHost');
        if (!host) { toast('Please render a preview first.', 'warn'); return; }
        if (host.getAttribute('aria-busy') === 'true') { toast('Preview is busy, please wait…', 'info'); return; }
        if (!host.querySelector('.sheet')) {
          toast('Please render a preview first.', 'warn');
          return;
        }
        // prevent re-entrancy while printing
        setDisabled(btnSave, true);
        setDisabled(btnOpen, true);
        setBusy(host, true);
        onPrintLifecycle({
          host,
          reenable: () => {
            setDisabled(btnSave, false);
            setDisabled(btnOpen, false);
          }
        });
        // Use browser print on the visible on-page preview
        window.print();
      });

      if (btnOpen) btnOpen.addEventListener('click', () => {
        const host = document.getElementById('htmlPrintHost');
        if (!host) { toast('Please render a preview first.', 'warn'); return; }
        if (host.getAttribute('aria-busy') === 'true') { toast('Preview is busy, please wait…', 'info'); return; }
        if (!host.querySelector('.sheet')) { toast('Please render a preview first.', 'warn'); return; }
        // Open a print-only view (clean tab)
        // prevent re-entrancy while spawning child window
        setDisabled(btnSave, true);
        setDisabled(btnOpen, true);
        setBusy(host, true);
        const cssElems = document.querySelectorAll('#print-css');
        if (cssElems.length > 1 && !window.__printCssWarned) {
          console.warn('Multiple #print-css elements found; using the first.');
          window.__printCssWarned = true;
        }
        const cssElem = cssElems[0];
        const fallbackCss = `
@page{size:A4;margin:14mm}
body{margin:0;font:14px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#111}
.sheet{width:210mm;min-height:297mm;padding:12mm 14mm 16mm;position:relative;font:13px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.doc-header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:4mm}
.doc-header h2{margin:1mm 0 0;font-size:18pt}
.doc-meta{color:#555;font-size:10.5pt;text-align:right}
.info-bar{background:#f3f4f6;border:1px solid #e5e7eb;padding:2mm 4mm;margin-bottom:6mm;font-size:10.5pt;white-space:normal;overflow:visible;text-overflow:clip;overflow-wrap:anywhere;word-break:break-word}
@media print{.info-bar{overflow:visible;text-overflow:clip}}
.sheet:not(:last-of-type){break-after:page;page-break-after:always}
.sec{break-inside:avoid;margin:5mm 0 0}
 .sec h3{margin:0 0 3mm;font-size:12pt;border-bottom:1px solid #ddd;padding-bottom:2.5mm}
 .kv{display:grid;grid-template-columns:1fr minmax(52mm,auto) 10mm;gap:2mm;padding:2mm 0;border-bottom:1px dashed #eee}
 .kv .label{color:#374151;overflow-wrap:anywhere;word-break:break-word}.kv .value{font-weight:600;text-align:right;font-variant-numeric:tabular-nums}.kv .unit{color:#6b7280;text-align:right}.kv .value.total{font-weight:800}.mapping .kv:last-child{background:#f3f4f6;border:1px solid #e5e7eb}.total{font-weight:700}
 .signatures{break-inside:avoid} .sigs{display:grid;grid-template-columns:1fr 1fr;gap:4mm;margin-top:4mm}.sig{text-align:left}.sig.right{text-align:right}.sig .line{border-top:1px solid #d1d5db;height:0;margin:10mm 0 2mm}.sig .role{color:#111;font-weight:600}
 .footer-note{margin-top:6mm;color:#6b7280;font-size:9.5pt}.page-number{position:absolute;bottom:6mm;right:18mm;color:#6b7280;font-size:9pt}`;
        const css = cssElem ? cssElem.innerHTML : fallbackCss;
        const month = (host.dataset && host.dataset.monthLabel) ? ` – ${host.dataset.monthLabel}` : '';
        const html = `
    <!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="color-scheme" content="light"><title>IOM - HT Bill${month}</title>
    <style>${css}</style>
    <script>window.addEventListener('afterprint',()=>{ try{ window.close(); }catch(_){} });<\/script>
    </head><body onload="setTimeout(()=>window.print(),100)">${host.innerHTML}</body></html>`;
        try{
          const w = window.open('', '_blank');
          if (!w) {
            alert('Popup blocked.\nEnable popups for this file and try again.\nTip: in Chrome/Edge, check the address bar icon or press Ctrl+J.');
            setBusy(host, false);
            setDisabled(btnSave, false); setDisabled(btnOpen, false);
            return;
          }
          try { w.opener = null; } catch(_) {}
          w.document.open(); w.document.write(html); w.document.close();
          onPrintLifecycle({
            host,
            reenable: () => {
              setDisabled(btnSave, false);
              setDisabled(btnOpen, false);
            }
          });
        } catch(e) {
          alert('Could not open print view: ' + e.message);
          setBusy(host, false);
          setDisabled(btnSave, false);
          setDisabled(btnOpen, false);
        }
      });

      document.getElementById('renderReceipt')?.addEventListener('click', renderDakReceipt);

      // Re-disable print actions if inputs change after a render
      document.querySelectorAll('input, select, textarea').forEach(el => {
        el.addEventListener('input', disablePrintActions, { passive: true });
        el.addEventListener('change', disablePrintActions, { passive: true });
      });

      // Also disable on programmatic mutations triggered by toolbar actions
      ['resetSample','resetAll','addSheet','clearSheets'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('click', disablePrintActions);
      });

      $('uploadExcel').addEventListener('click', () => withBusy('uploadExcel', async () => {
        if (!(await loadXLSX())) return;
        $('uploadXlsx').click();
      }));
      $('uploadXlsx').addEventListener('change', e => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async ev => {
          try{
            const _wb = getWB(); if(!_wb) return;
            const data = new Uint8Array(ev.target.result);
            const wb = XLSX.read(data, {type:'array'});
            let added = 0, replaced = 0;
            const toReplace = [];
            for(const name of wb.SheetNames){
              if (_wb.SheetNames.includes(name)){
                const ok = await confirmModal(`Sheet "${name}" exists. Replace it?`);
                if (ok) toReplace.push(name);
              }else{
                _wb.Sheets[name] = wb.Sheets[name];
                _wb.SheetNames.push(name);
                added++;
              }
            }
            for(const name of toReplace){
              _wb.Sheets[name] = wb.Sheets[name];
              if(!_wb.SheetNames.includes(name)) _wb.SheetNames.push(name);
              replaced++;
            }
            canonicalizeWorkbook();
            toast(`Workbook merged: ${added} added, ${replaced} replaced.`, 'good');
            refreshSheetList();
            if (typeof disablePrintActions === 'function') disablePrintActions();
          }catch(err){
            console.error(err);
            toast('Upload failed','bad');
          }finally{
            e.target.value='';
          }
        };
        reader.onerror = err=>{ console.error(err); toast('Upload failed','bad'); e.target.value=''; };
        reader.readAsArrayBuffer(file);
      });

      $('clearSheets').addEventListener('click', async () => {
        if(!(await confirmModal('Remove ALL sheets from the workbook?'))) return;
        const wb = getWB(); if(!wb) return;
        (wb.SheetNames || []).forEach(n => delete wb.Sheets[n]);
        wb.SheetNames = [];
        canonicalizeWorkbook();
        toast('All sheets cleared.', 'good');
        refreshSheetList();
      });

      $('resetAll').addEventListener('click', ()=>{
        document.querySelectorAll('input').forEach(el=>{
          if(el.type!=="month"){
            el.value='';
            el.dataset.value='';
          }
        });
        compute();
      });

      $('resetSample').addEventListener('click', ()=>{
        fillSampleData();
        const m = compute(true);
        console.assert(m.A9 === 14350, `A9 expected 14350, got ${m.A9}`);
        console.assert(m.C9 === 17220, `C9 expected 17220, got ${m.C9}`);
        console.assert(Math.round(m.FINAL) === 16700, `FINAL expected 16700, got ${m.FINAL}`);
      });

      (function(){
        const genBtn = $('genSapText');
        if(genBtn){
          genBtn.addEventListener('click', () => {
            const model = compute(true);
            if (!model) { toast('Fix highlighted inputs before generating long text.', 'warn'); return; }
            const label = monthLabel();
            const txt = buildSapLongText(model, label);
            const ta = $('sapText');
            ta.value = txt;
            ta.focus();
            ta.select();
          });
        }
      })();

      (function(){
        const copyBtn = $('copySapText'); if(!copyBtn) return;
        copyBtn.addEventListener('click', async () => {
          const ta = $('sapText');
          ta.focus();
          ta.select();
          try {
            await navigator.clipboard.writeText(ta.value);
          } catch {
            try { document.execCommand('copy'); } catch(_) {}
          }
          toast('Long text copied.', 'good');
        });
      })();

      const restored = restore();
      compute();
      refreshSheetList();
      if(restored) toast('Previous data restored.');
    });
  </script>
</body>
</html>
