<!-- htmlhint tagname-lowercase:false -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WEG Billing Calculator</title>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --card:#111827;        /* gray-900 */
      --ink:#e5e7eb;         /* gray-200 */
      --muted:#cbd5e1;       /* slate-300 */
      --accent:#22d3ee;      /* cyan-400 */
      --accent-2:#a78bfa;    /* violet-400 */
      --good:#22c55e;        /* green-500 */
      --bad:#ef4444;         /* red-500 */
      --warn:#f59e0b;        /* amber-500 */
      --panel:#0b1224;       /* deep */
      --ring:2px solid rgba(34,211,238,.6);
      --shadow: 0 20px 50px rgba(0,0,0,.45);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    :focus-visible{outline:var(--ring);outline-offset:2px}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1100px 600px at 100% -10%, rgba(167,139,250,.18), transparent 60%),
                  radial-gradient(900px 500px at -10% 10%, rgba(34,211,238,.18), transparent 60%),
                  var(--bg);
      color:var(--ink);
    }
    .wrap{max-width:1200px;margin:32px auto;padding:0 20px}
    header{
      position:sticky;top:0;z-index:10;
      backdrop-filter:saturate(150%) blur(8px);
      background:linear-gradient(180deg, rgba(15,23,42,.92), rgba(15,23,42,.66));
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:18px;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brand svg{width:34px;height:34px}
    .brand h1{margin:0;font-size:22px;letter-spacing:.3px}
    .sub{color:var(--ink);font-size:13.5px}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;padding:8px 0}
    button, .ghost{
      border:0;border-radius:12px;padding:10px 14px;font-weight:600;letter-spacing:.2px;
      background:linear-gradient(145deg, rgba(167,139,250,.25), rgba(34,211,238,.25));
      color:white;cursor:pointer;box-shadow:var(--shadow);backdrop-filter: blur(6px);
    }
    button:hover{filter:brightness(1.07)}
    button:active{transform:translateY(1px)}
    .ghost{background:rgba(255,255,255,.05)}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{
      grid-column: span 12;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);padding:18px 18px 12px 18px;box-shadow:var(--shadow)
    }
    @media(min-width:980px){
      .span-6{grid-column:span 6}
      .span-4{grid-column:span 4}
      .span-8{grid-column:span 8}
      .span-3{grid-column:span 3}
      .span-9{grid-column:span 9}
    }

    .card h2{margin:0 0 12px 0;font-size:16px;font-weight:700;display:flex;justify-content:space-between;align-items:center}
    .help{color:var(--ink);font-size:12px}

    .fields{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .fields .f{grid-column:span 12}
    @media(min-width:860px){.fields .f{grid-column:span 6}}
    .fields .f.sm{grid-column:span 6}
    @media(min-width:860px){.fields .f.sm{grid-column:span 3}}

    label{display:flex;justify-content:space-between;gap:8px;color:var(--ink);font-size:12.5px;margin-bottom:6px}
    input[type="number"], input[type="month"], input[type="text"]{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(17,24,39,.6);color:var(--ink)
    }

    .kpi{
      display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin-top:6px
    }
    .kpi .box{grid-column:span 12;min-height:104px}
    @media(min-width:980px){.kpi .box{grid-column:span 4}}
    .box{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px
    }
    .box h3{margin:0;color:var(--muted);font-size:12.5px;font-weight:600;white-space:normal;line-height:1.25;word-break:break-word;overflow-wrap:anywhere}
    .box .v{margin-top:8px;font-size:22px;font-weight:800}
    .unit{font-size:12px;color:var(--muted);margin-left:6px;font-weight:600}

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .accent{color:var(--accent)}
    .violet{color:var(--accent-2)}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}

    .footer{margin-top:18px;color:var(--muted);font-size:12px}
    .muted{color:var(--muted)}
    .hr{height:1px;background:linear-gradient(90deg, rgba(255,255,255,.15), rgba(255,255,255,.03));margin:14px 0}

    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:12px}
    .pill button{padding:2px 8px}
    .pills{display:flex;gap:6px;flex-wrap:wrap}
    .right{float:right}

    details{margin:10px 0}
    summary{cursor:pointer}

    #toasts{position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:1000}
    .toast{background:var(--card);color:var(--ink);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:1;transition:opacity .5s ease, transform .5s ease}
    .toast.info{border-left:4px solid var(--accent)}
    .toast.good{border-left:4px solid var(--good)}
    .toast.bad{border-left:4px solid var(--bad)}
    .toast.warn{border-left:4px solid var(--warn)}
    .toast.hide{opacity:0;transform:translateX(20px)}
    .hint{display:none;color:var(--bad);font-size:11px;margin-top:4px}
    .warn-text{display:none;color:var(--muted);font-size:11px;margin-top:4px}
    .invalid{border-color:var(--bad)!important}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="32" y2="32" gradientUnits="userSpaceOnUse">
              <stop stop-color="#22d3ee"/>
              <stop offset="1" stop-color="#a78bfa"/>
            </linearGradient>
          </defs>
          <path d="M16 3c7.18 0 13 5.82 13 13s-5.82 13-13 13S3 23.18 3 16 8.82 3 16 3Zm0 4a9 9 0 1 0 0 18 9 9 0 0 0 0-18Zm0 3.2a5.8 5.8 0 1 1 0 11.6A5.8 5.8 0 0 1 16 10.2Z" fill="url(#g)"/>
        </svg>
        <div>
          <h1>WEG Billing Calculator</h1>
          <div class="sub">Single‑file tool for HT bill + wind credits • Excel export with month sheets</div>
        </div>
      </div>
      <div class="toolbar">
        <label class="pill"><span>Billing Month</span><input type="month" id="billMonth"/></label>
        <div id="sheetList" class="pills"></div>
        <button id="addSheet">Add / Update Month Sheet</button>
        <button id="uploadExcel">Upload Excel</button>
        <input type="file" id="uploadXlsx" accept=".xlsx" hidden>
        <label class="pill" id="autoUpdateToggle">
          <input type="checkbox" id="autoUpdateOnDownload" checked />
          <span>Auto‑update month on Download</span>
        </label>
        <button id="downloadExcel">Download Excel</button>
        <button id="downloadPDF">Download IOM PDF</button>
          <button class="ghost" id="resetAll">Reset</button>
          <button class="ghost" id="clearSheets">Clear Sheets</button>
          <button id="resetSample">Sample Data</button><!-- fills fields with example screenshot values -->
        </div>
      </header>

    <div class="grid">
      <!-- Main HT Bill Inputs -->
      <section class="card span-6">
        <h2>HT Bill — Inputs <span class="help">Manual entries from utility bill</span></h2>
        <div class="fields">
          <div class="f"><label>Monthly Consumption (kWh) <span class="mono">A4</span></label><input type="number" id="A4" step="0.001" min="0"/><span class="hint"></span></div>
          <div class="f"><label>Demand Charges (₹) <span class="mono">B4</span></label><input type="text" id="B4"/><span class="hint"></span></div>
          <div class="f"><label>Energy Charges (₹) <span class="mono">C4</span></label><input type="text" id="C4"/><span class="hint"></span></div>
          <div class="f"><label>Night Rebate (₹) <span class="mono">D4</span></label><input type="text" id="D4"/><span class="hint"></span></div>
          <div class="f"><label>Fuel Charge (₹) <span class="mono">E4</span></label><input type="text" id="E4"/><span class="hint"></span></div>
          <div class="f"><label>PF Rebate (₹) <span class="mono">F4</span></label><input type="text" id="F4"/><span class="hint"></span></div>
          <div class="f"><label>EHV Rebate (₹) <span class="mono">G4</span></label><input type="text" id="G4"/><span class="hint"></span></div>
          <div class="f"><label>TOU (₹) <span class="mono">H4</span></label><input type="text" id="H4"/><span class="hint"></span></div>
          <div class="f"><label>GT Charges (₹) <span class="mono">I4</span></label><input type="text" id="I4"/><span class="hint"></span></div>
        </div>
        <div class="hr"></div>
        <div class="kpi">
          <div class="box"><h3>Tot Consumption Charge <span class="mono">A9 = B4+C4+D4+E4−F4−G4+H4+I4</span></h3><div class="v" id="A9v">₹0</div></div>
          <div class="box"><h3>ED @ 20% <span class="mono">B9 = A9×0.2</span></h3><div class="v" id="B9v">₹0</div></div>
          <div class="box"><h3>Current Month Bill <span class="mono">C9 = A9+B9</span></h3><div class="v" id="C9v">₹0</div></div>
        </div>
      </section>

      <!-- Adjustments -->
      <section class="card span-6">
        <h2>Adjustments & Carry‑forward <span class="help">Manual entries</span></h2>
        <div class="fields">
          <div class="f sm"><label>Outstanding Arrears (₹) <span class="mono">D9</span></label><input type="text" id="D9"/><span class="hint"></span></div>
          <div class="f sm"><label>Freeze Amount (₹) <span class="mono">E9</span></label><input type="text" id="E9"/><span class="hint"></span></div>
          <div class="f sm"><label>Delayed Payment Charges (₹) <span class="mono">F9</span></label><input type="text" id="F9"/><span class="hint"></span></div>
          <div class="f sm"><label>Advance Payment / Adjust. (₹) <span class="mono">G9</span></label><input type="text" id="G9"/><span class="hint"></span></div>
        </div>
        <div class="hr"></div>
        <div class="kpi">
          <div class="box"><h3>Net Payable <span class="mono">H9 = C9+D9+F9−G9</span></h3><div class="v" id="H9v">₹0</div></div>
          <div class="box"><h3>Actual Amount to be Paid <span class="mono">I9 = H9−E9</span></h3><div class="v" id="I9v">₹0</div></div>
          <div class="box"><h3>Balance Pending from Previous Month <span class="mono">A31 = D9−E9</span></h3><div class="v" id="A31v">₹0</div></div>
        </div>
      </section>

      <!-- WEG Inputs -->
      <section class="card span-6">
        <h2>WEG — Inputs <span class="help">Bitlavadia (4.5 MW) & Nanisindhodi (14.7 MW)</span></h2>
        <div class="fields">
          <div class="f sm"><label>Share Bitlavadia (%) <span class="mono">B15</span></label><input type="number" id="B15" step="0.01" min="0" max="100"/><span class="hint"></span></div>
          <div class="f sm"><label>Share Nanisindhodi (%) <span class="mono">D15</span></label><input type="number" id="D15" step="0.01" min="0" max="100"/><span class="hint"></span></div>
          <div class="f sm"><label>Transmission Loss (%) <span class="mono">C16</span></label><input type="number" id="C16" step="0.01" min="0" max="100"/><span class="hint"></span></div>
        </div>
        <details>
          <summary class="muted">Monthly Generation (MWh) — expand</summary>
          <div class="fields" style="margin-top:10px">
            <div class="f sm"><label>Bitlavadia MWh #1 <span class="mono">A17</span></label><input type="number" id="A17" step="0.001" min="0"/><span class="hint"></span></div>
            <div class="f sm"><label>Bitlavadia MWh #2 <span class="mono">B17</span></label><input type="number" id="B17" step="0.001" min="0"/><span class="hint"></span></div>
            <div class="f sm"><label>Nanisindhodi MWh #1 <span class="mono">C17</span></label><input type="number" id="C17" step="0.001" min="0"/><span class="hint"></span></div>
            <div class="f sm"><label>Nanisindhodi MWh #2 <span class="mono">D17</span></label><input type="number" id="D17" step="0.001" min="0"/><span class="hint"></span></div>
            <div class="f sm"><label>Nanisindhodi MWh #3 <span class="mono">E17</span></label><input type="number" id="E17" step="0.001" min="0"/><span class="hint"></span></div>
          </div>
        </details>
        <div class="hr"></div>
        <div class="kpi">
          <div class="box"><h3>Bitlavadia Share (kWh) <span class="mono">A18 = ROUNDUP((A17+B17)*1000*B15%*(1−C16%),0)</span></h3><div class="v" id="A18v">0 kWh</div></div>
          <div class="box"><h3>Nanisindhodi Share (kWh) <span class="mono">C18 = ROUNDUP((C17+D17+E17)*1000*D15%*(1−C16%),0)</span></h3><div class="v" id="C18v">0 kWh</div></div>
          <div class="box"><h3>Total Allocated (kWh) <span class="mono">A19 = A18+C18</span></h3><div class="v" id="A19v">0 kWh</div></div>
        </div>
      </section>

      <!-- WEG Credits -->
      <section class="card span-6">
        <h2>Wind Credits & Debits <span class="help">Prior‐month adjustments</span></h2>
        <div class="fields">
          <div class="f sm"><label>Credit Board Charges (₹) <span class="mono">A24</span></label><input type="text" id="A24"/><span class="hint"></span></div>
          <div class="f sm"><label>Credit ED Charges (₹) <span class="mono">B24</span></label><input type="text" id="B24"/><span class="hint"></span></div>
          <div class="f sm"><label>Credit TDS (₹) <span class="mono">C24</span></label><input type="text" id="C24"/><span class="hint"></span></div>
          <div class="f sm"><label>Debit Board Charges (₹) <span class="mono">D24</span></label><input type="text" id="D24"/><span class="hint"></span></div>
          <div class="f sm"><label>Debit Electricity Duty (₹) <span class="mono">E24</span></label><input type="text" id="E24"/><span class="hint"></span></div>
          <div class="f sm"><label>Debit Wheeling Charges (₹) <span class="mono">F24</span></label><input type="text" id="F24"/><span class="hint"></span></div>
        </div>
        <div class="hr"></div>
        <div class="kpi">
          <div class="box"><h3>Total Credit (₹) <span class="mono">A26 = A24+B24</span></h3><div class="v" id="A26v">₹0</div></div>
          <div class="box"><h3>Total Debit (₹) <span class="mono">B26 = D24+E24+F24</span></h3><div class="v" id="B26v">₹0</div></div>
          <div class="box"><h3>Net Wind Credit (₹) <span class="mono">C26 = A26−B26</span></h3><div class="v" id="C26v">₹0</div></div>
        </div>
        <div class="kpi">
          <div class="box"><h3>Wind Rate (₹ / kWh) <span class="mono">B19 = IF(A19=0,0,C26/A19)</span></h3><div class="v" id="B19v">₹0</div><small class="warn-text" id="windRateWarn">kWh allocated is zero; rate shown as ₹0.00/kWh</small></div>
          <div class="box"><h3>Share of 4.5 MW WEG (₹) <span class="mono">F16 = B19×A18</span></h3><div class="v" id="F16v">₹0</div></div>
          <div class="box"><h3>Share of 14.7 MW WEG (₹) <span class="mono">G16 = B19×C18</span></h3><div class="v" id="G16v">₹0</div></div>
        </div>
      </section>

      <!-- Final Bill -->
      <section class="card span-12">
        <h2>Final Bill for IOM</h2>
        <div class="kpi">
          <div class="box"><h3 class="mono">Formula: C9 − F16 − G16 − C24 + A31 + F9</h3>
            <div class="v" id="FINALv" style="font-size:30px">₹0</div>
            <div class="muted">Mapping: Current Month Bill − Share(4.5MW) − Share(14.7MW) − Credit TDS + Balance Pending (prev) + Delay Charges</div>
          </div>
        </div>
      </section>
    </div>

  <div class="footer">Pro‑tips: enter positive numbers for all rebates/credits (the app handles signs). Rounding of kWh shares matches <span class="mono">ROUNDUP(…,0)</span>. Values are live‑calculated; add a month sheet when ready.</div>
  </div>

  <div id="toasts" role="status" aria-live="polite"></div>
  <div id="modal" role="dialog" aria-modal="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1100; align-items:center; justify-content:center;">
    <div style="background:var(--card); color:var(--ink); padding:16px; border-radius:12px; min-width:300px; box-shadow:var(--shadow)">
      <div id="modalText" style="margin-bottom:12px"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end">
        <button id="modalCancel" class="ghost">Cancel</button>
        <button id="modalOk">Replace</button>
      </div>
    </div>
  </div>

  <!-- SheetJS for Excel export -->
  <!-- Prefer a local copy for offline/file:// usage; keep dynamic loader as fallback -->
  <script src="./xlsx.full.min.js"></script>
  <!-- pdfMake and fonts for PDF export (local files only) -->
  <script src="./pdfmake.min.js"></script>
  <script src="./vfs_fonts.js"></script>
  <script type="module">
    import vfs from './vfs_noto_deva.js';
    if (vfs && window.pdfMake) {
      window.pdfMake.vfs = Object.assign({}, window.pdfMake.vfs || {}, vfs);
      window.pdfMake.fonts = Object.assign({}, window.pdfMake.fonts || {}, {
        Noto: {
          normal: 'NotoSansDevanagari-Regular.ttf',
          bold: 'NotoSansDevanagari-Bold.ttf',
          italics: 'NotoSansDevanagari-Regular.ttf',
          bolditalics: 'NotoSansDevanagari-Bold.ttf'
        }
      });
    }
  </script>
  <script src="./iom-pdf.js"></script>
  <script>
    function toast(msg, type='info'){
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.textContent = msg;
      document.getElementById('toasts').appendChild(t);
      setTimeout(()=>{
        t.classList.add('hide');
        t.addEventListener('transitionend',()=>t.remove());
      },3000);
    }
  </script>
  <script>
    // Single-flight, on-demand SheetJS loader
    // Tries: ?xlsx=override → ./xlsx.full.min.js (local) → CDNs
    let __xlsxLoading = null;
    async function loadXLSX(){
      if (window.XLSX) return true; // already present (e.g., local tag succeeded)
      if (__xlsxLoading) return __xlsxLoading;
      __xlsxLoading = (async () => {
        const qp = new URLSearchParams(location.search);
        const override = qp.get('xlsx'); // optional: ?xlsx=/path/to/xlsx.full.min.js
        const urls = [
          ...(override ? [override] : []),
          './xlsx.full.min.js',
          'https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js',
          'https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js'
        ];
        let lastTried = '';
        for (const src of urls){
          lastTried = src;
          try{
            await new Promise((resolve, reject) => {
              const s = document.createElement('script');
              s.src = src;
              s.async = true;
              s.onload = resolve;
              s.onerror = reject;
              document.head.appendChild(s);
            });
            if (window.XLSX) return true;
          }catch{/* try next */}
        }
        toast(`Excel library failed to load (last: ${lastTried}). You are likely offline or a CSP blocked CDNs. Place "xlsx.full.min.js" next to this HTML or pass ?xlsx=/path/to/xlsx.full.min.js`, 'bad');
        return false;
      })();
      const ok = await __xlsxLoading;
      __xlsxLoading = null;
      return ok;
    }

    // Restore the small UX helper to show a temporary busy state on buttons.
    // Many toolbar handlers call withBusy('buttonId', async () => { ... }).
    async function withBusy(btnId, fn){
      const btn = document.getElementById(btnId);
      const prevDisabled = btn ? btn.disabled : false;
      const prevText = btn ? btn.textContent : '';
      if (btn){
        btn.disabled = true;
        btn.dataset.prevText = prevText;
        btn.textContent = 'Working…';
      }
      try{
        return await fn();
      } finally {
        if (btn){
          btn.disabled = prevDisabled;
          btn.textContent = btn.dataset.prevText || prevText;
          delete btn.dataset.prevText;
        }
      }
    }
  </script>
  <script>
    // Utility helpers
      const INR = new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR', maximumFractionDigits:2 });
      const KWH = new Intl.NumberFormat('en-IN', { maximumFractionDigits:0 });
      const RATE = new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR', maximumFractionDigits:6 });
      const SAMPLE = {
        A4:1000,B4:5000,C4:8000,D4:200,E4:300,F4:100,G4:50,H4:400,I4:600,
        D9:200,E9:50,F9:30,G9:0,
        B15:30,D15:70,C16:2,
        A17:1,B17:1,C17:2,D17:1,E17:1,
        A24:500,B24:200,C24:100,D24:50,E24:25,F24:25
      };

    const $ = id => document.getElementById(id);
    const num = id => {
      const el = $(id);
      return parseFloat(el.dataset.value || el.value || 0) || 0;
    };
    const roundUp0 = x => Math.ceil(x);

    const toInr = v => INR.format(Number.isFinite(v) ? v : 0);
      const toRate = v => RATE.format(Number.isFinite(v) ? v : 0) + ' /kWh';
    function parseInrInput(el){
      const raw = el.value.replace(/[^0-9.\-]/g,'');
      const v = parseFloat(raw);
      if(Number.isFinite(v)){
        el.dataset.value = v;
        el.value = toInr(v);
      }else{
        el.dataset.value = '';
        el.value = '';
      }
    }

    const debounce = (fn, delay=200) => {
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); };
    };

    function confirmModal(msg){
      return new Promise(resolve=>{
        const m = $('modal');
        const okBtn = $('modalOk');
        const cancelBtn = $('modalCancel');
        const prev = document.activeElement;
        $('modalText').textContent = msg;
        m.style.display = 'flex';
        okBtn.focus();
        const ok = ()=>{ cleanup(); resolve(true); };
        const cancel = ()=>{ cleanup(); resolve(false); };
        const esc = e=>{ if(e.key==='Escape') cancel(); };
        const backdrop = e=>{ if(e.target===m) cancel(); };
        function cleanup(){
          okBtn.removeEventListener('click', ok);
          cancelBtn.removeEventListener('click', cancel);
          document.removeEventListener('keydown', esc);
          m.removeEventListener('click', backdrop);
          m.style.display = 'none';
          if(prev) prev.focus();
        }
        okBtn.addEventListener('click', ok, { once:true });
        cancelBtn.addEventListener('click', cancel, { once:true });
        document.addEventListener('keydown', esc);
        m.addEventListener('click', backdrop);
      });
    }

    function validate(){
      let ok = true;
      const percentIds = ['B15','D15','C16'];
      const sciIds = ['A4','A17','B17','C17','D17','E17','B15','D15','C16'];
      document.querySelectorAll('input').forEach(el=>{
        if(el.type==='month' || el.type==='file') return;
        const hint = el.nextElementSibling;
        if(!hint || !hint.classList.contains('hint')) return;
        hint.textContent=''; hint.style.display='none';
        el.classList.remove('invalid');

        const raw = el.dataset.value ?? el.value;
        if (sciIds.includes(el.id) && /e/i.test(String(raw))) {
          hint.textContent='Scientific notation not allowed.'; hint.style.display='block'; el.classList.add('invalid'); ok = false; return;
        }
        const val = parseFloat(raw);
        if (!Number.isFinite(val)) return; // allow empty/unfilled during typing

        if (percentIds.includes(el.id)) {
          if (val < 0 || val > 100) { hint.textContent='0–100 only.'; hint.style.display='block'; el.classList.add('invalid'); ok = false; }
        } else if (val < 0) {
          hint.textContent='≥ 0 only.'; hint.style.display='block'; el.classList.add('invalid'); ok = false;
        }
      });
      return ok;
    }

    function compute(strict=false){
      const ok = validate();
      // HT Bill
      const A4=num('A4'), B4=num('B4'), C4=num('C4'), D4=num('D4'), E4=num('E4'), F4=num('F4'), G4=num('G4'), H4=num('H4'), I4=num('I4');
      const A9 = B4 + C4 + D4 + E4 - F4 - G4 + H4 + I4;
      const B9 = A9 * 0.2;
      const C9 = A9 + B9;
      $('A9v').textContent = toInr(A9);
      $('B9v').textContent = toInr(B9);
      $('C9v').textContent = toInr(C9);

      // Adjustments
      const D9=num('D9'), E9=num('E9'), F9=num('F9'), G9=num('G9');
      const H9 = C9 + D9 + F9 - G9;
      const I9 = H9 - E9;
      const A31 = D9 - E9;
      $('H9v').textContent = toInr(H9);
      $('I9v').textContent = toInr(I9);
      $('A31v').textContent = toInr(A31);

      // WEG Inputs
      const B15=num('B15'), D15=num('D15'), C16=num('C16');
      const A17=num('A17'), B17=num('B17'), C17=num('C17'), D17=num('D17'), E17=num('E17');
      const bit_mwh = A17 + B17;
      const nan_mwh = C17 + D17 + E17;
      const A18 = roundUp0((bit_mwh)*1000*(B15/100)*(1-(C16/100)));
      const C18 = roundUp0((nan_mwh)*1000*(D15/100)*(1-(C16/100)));
      const A19 = A18 + C18;
      $('A18v').textContent = KWH.format(A18) + ' kWh';
      $('C18v').textContent = KWH.format(C18) + ' kWh';
      $('A19v').textContent = KWH.format(A19) + ' kWh';

      // Credits/Debits
      const A24=num('A24'), B24=num('B24'), C24=num('C24'), D24=num('D24'), E24=num('E24'), F24=num('F24');
      const A26 = A24 + B24;
      const B26 = D24 + E24 + F24;
      const C26 = A26 - B26;
      $('A26v').textContent = toInr(A26);
      $('B26v').textContent = toInr(B26);
      $('C26v').textContent = toInr(C26);

      // Rates & Shares
      const B19 = (A19===0) ? 0 : (C26 / A19);
      const F16 = B19 * A18;
      const G16 = B19 * C18;
      $('B19v').textContent = toRate(B19);
      $('windRateWarn').style.display = (A19===0) ? 'block' : 'none';
      $('F16v').textContent = toInr(F16);
      $('G16v').textContent = toInr(G16);

      // Final Bill for IOM
      const FINAL = C9 - F16 - G16 - C24 + A31 + F9; // C9 − F16 − G16 − Credit TDS + Balance Pending + Delay Charges
      $('FINALv').textContent = toInr(FINAL);
      persistDebounced();
      return strict && !ok ? null : { A4,B4,C4,D4,E4,F4,G4,H4,I4, A9,B9,C9, D9,E9,F9,G9,H9,I9, B15,D15,C16, A17,B17,C17,D17,E17, A18,C18,A19, A24,B24,C24,D24,E24,F24, A26,B26,C26, B19,F16,G16, A31, FINAL };
    }

      // Excel workbook in memory (lazy init)
      let WB = null;
  function getWB(){
        if(!window.XLSX) return null;
        if(!WB){
          WB = XLSX.utils.book_new();
          WB.Props = { Title:'WEG Billing Workbook', Author:'WEG Billing Calculator', CreatedDate:new Date() };
        }
        return WB;
      }

    const LS_KEY = 'weg-billing-v1';

    function persist(){
      const inputs = {};
      document.querySelectorAll('input').forEach(el=>{
        inputs[el.id] = el.value;
      });
      const _wb = getWB();
      canonicalizeWorkbook();
      const data = { inputs, sheets: _wb ? _wb.SheetNames.slice() : [] };
      localStorage.setItem(LS_KEY, JSON.stringify(data));
    }

    const persistDebounced = debounce(persist, 200);

    function restore(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return false;
        const data = JSON.parse(raw);
        if(data.inputs){
          Object.entries(data.inputs).forEach(([id,val])=>{
            const el = $(id);
            if(el){
              el.value = val;
              if(el.type==='text') parseInrInput(el);
            }
          });
        }
        if(Array.isArray(data.sheets)){
          const _wb = getWB();
          if(_wb) _wb.SheetNames = data.sheets;
        }
        return true;
      }catch(err){
        console.error(err);
      }
      return false;
    }

    function refreshSheetList(){
      canonicalizeWorkbook();
      const list = $('sheetList');
      list.innerHTML = '';
      const _wb = getWB();
      if(!_wb) return;
      const names = _wb.SheetNames || [];
      names.forEach(name=>{
        const pill = document.createElement('span');
        pill.className = 'pill';
        const btnGo = document.createElement('button');
        btnGo.className = 'ghost';
        btnGo.textContent = name;
        btnGo.addEventListener('click', () => { $('billMonth').value = name; compute(); });

        const btnDel = document.createElement('button');
        btnDel.className = 'ghost';
        btnDel.setAttribute('aria-label', `Remove ${name}`);
        btnDel.textContent = '×';
        btnDel.addEventListener('click', async (e) => {
          e.stopPropagation();
          if(!(await confirmModal(`Remove sheet "${name}" from the workbook?`))) return;
          const wb = getWB(); if(!wb) return;
          delete wb.Sheets[name];
          wb.SheetNames = wb.SheetNames.filter(n => n !== name);
          canonicalizeWorkbook();
          toast(`Removed sheet: ${name}`, 'good');
          refreshSheetList();
        });

        pill.append(btnGo, btnDel);
        list.appendChild(pill);
      });
      persistDebounced();
    }

    function buildSheetData(model, monthLabel){
      const rows = [];
      // Always push a row array, even if r(['a','b']) or r('a','b') is used.
      function r(...cells){
        const row = (cells.length === 1 && Array.isArray(cells[0])) ? cells[0] : cells;
        rows.push(row);
      }

      const DANGEROUS_LEAD = /^([=+\-@])/;
      const looksLikeYYYYMM = s => /^\d{4}-(0[1-9]|1[0-2])$/.test(s);
      function forceText(v){
        if (v == null) return '';
        const s = String(v);
        return (DANGEROUS_LEAD.test(s) || looksLikeYYYYMM(s)) ? { t:'s', v:s, z:'@' } : s;
      }

      // Header row
      r(['WEG Billing – Month', monthLabel]);
      r(['Generated at', new Date().toLocaleString()]);
      r([]);

      r(['SECTION','FIELD','CELL','VALUE','UNITS/NOTES']);
      // HT Bill
      r(['HT Bill','Monthly Consumption','A4', model.A4, 'kWh']);
      r(['HT Bill','Demand Charges','B4', model.B4, '₹']);
      r(['HT Bill','Energy Charges','C4', model.C4, '₹']);
      r(['HT Bill','Night Rebate','D4', model.D4, '₹']);
      r(['HT Bill','Fuel Charge','E4', model.E4, '₹']);
      r(['HT Bill','PF Rebate','F4', model.F4, '₹']);
      r(['HT Bill','EHV Rebate','G4', model.G4, '₹']);
      r(['HT Bill','TOU','H4', model.H4, '₹']);
      r(['HT Bill','GT Charges','I4', model.I4, '₹']);
      // mark calculated rows as currency so Excel formats them
      r(['HT Bill (calc)','Total Consumption Charge','A9', model.A9, '₹']);
      r(['HT Bill (calc)','ED @ 20%','B9', model.B9, '₹']);
      r(['HT Bill (calc)','Current Month Bill','C9', model.C9, '₹']);
      r([]);

      // Adjustments
      r(['Adjust','Outstanding Arrears','D9', model.D9, '₹']);
      r(['Adjust','Freeze Amount','E9', model.E9, '₹']);
      r(['Adjust','Delayed Payment Charges','F9', model.F9, '₹']);
      r(['Adjust','Advance Payment / Adjust.','G9', model.G9, '₹']);
      r(['Adjust (calc)','Net Payable','H9', model.H9, '₹']);
      r(['Adjust (calc)','Actual Amount to be Paid','I9', model.I9, '₹']);
      r(['Adjust (calc)','Balance Pending from Previous Month','A31', model.A31, '₹']);
      r([]);

      // WEG Inputs
      r(['WEG','Share Bitlavadia (%)','B15', model.B15, '%']);
      r(['WEG','Share Nanisindhodi (%)','D15', model.D15, '%']);
      r(['WEG','Transmission Loss (%)','C16', model.C16, '%']);
      r(['WEG','Bitlavadia MWh #1','A17', model.A17, 'MWh']);
      r(['WEG','Bitlavadia MWh #2','B17', model.B17, 'MWh']);
      r(['WEG','Nanisindhodi MWh #1','C17', model.C17, 'MWh']);
      r(['WEG','Nanisindhodi MWh #2','D17', model.D17, 'MWh']);
      r(['WEG','Nanisindhodi MWh #3','E17', model.E17, 'MWh']);
      r(['WEG (calc)','Bitlavadia Share (kWh)','A18', model.A18, 'kWh']);
      r(['WEG (calc)','Nanisindhodi Share (kWh)','C18', model.C18, 'kWh']);
      r(['WEG (calc)','Total Allocated (kWh)','A19', model.A19, 'kWh']);
      r([]);

      // Credits & Debits
      r(['Wind Credits','Credit Board Charges','A24', model.A24, '₹']);
      r(['Wind Credits','Credit ED Charges','B24', model.B24, '₹']);
      r(['Wind Credits','Credit TDS','C24', model.C24, '₹']);
      r(['Wind Debits','Debit Board Charges','D24', model.D24, '₹']);
      r(['Wind Debits','Debit Electricity Duty','E24', model.E24, '₹']);
      r(['Wind Debits','Debit Wheeling Charges','F24', model.F24, '₹']);
      r(['Wind (calc)','Total Credit','A26', model.A26, '₹']);
      r(['Wind (calc)','Total Debit','B26', model.B26, '₹']);
      r(['Wind (calc)','Net Wind Credit','C26', model.C26, '₹']);
      r(['Wind (calc)','Wind Rate (₹/kWh)','B19', model.B19, '₹/kWh']);
      r(['Wind (calc)','Share 4.5 MW (₹)','F16', model.F16, '₹']);
      r(['Wind (calc)','Share 14.7 MW (₹)','G16', model.G16, '₹']);
      r([]);

      // Final
      r(['FINAL','Final Bill for IOM','—', model.FINAL, '₹']);

      const valueCol = 3;          // VALUE index
      const NUM = x => (typeof x === 'number' ? x
                : (x==='' || x==null ? null : Number(String(x).replace(/[, ]/g,''))));

      const typedRows = rows.map(row => {
        // Guard: row must be an array
        if (!Array.isArray(row)) row = [String(row)];   // last-resort safety net
        const out = row.slice();

        // A,B,C,E -> text
        [0,1,2,4].forEach(ci => { if (ci in out) out[ci] = forceText(out[ci]); });

        // VALUE -> numeric or blank
        if (valueCol in out) {
          const n = NUM(out[valueCol]);
          out[valueCol] = (n==null || !isFinite(n)) ? { t:'z' } : { t:'n', v:n };
        }
        return out;
      });

      if (window.DEV) {
        const bad = typedRows.find(r => !Array.isArray(r));
        if (bad) console.error('Export row not array:', bad);
      }

      const ws = XLSX.utils.aoa_to_sheet(typedRows);

      const firstDataRow = 4;                    // month, generated-at, blank, header
      const lastRow = typedRows.length - 1;
      const unitAt = ri => {
        const u = typedRows[ri] && typedRows[ri][4];
        return (u && u.v) || u || '';
      };

      for (let r = firstDataRow; r <= lastRow; r++) {
        const addr = XLSX.utils.encode_cell({ r, c: valueCol });
        const cell = ws[addr];
        if (!cell || cell.t !== 'n') continue;
        const unit = unitAt(r);
        if (unit === '%') { cell.v = cell.v / 100; cell.z = '0.00%'; }
        else if (unit === '₹') { cell.z = '₹#,##0.00'; }
        else if (unit === '₹/kWh') { cell.z = '₹#,##0.000000'; }
        else if (unit === 'MWh') { cell.z = '0.000'; }
        else if (unit === 'kWh') { cell.z = '#,##0'; }
        else { cell.z = '#,##0.00'; }
      }

      // Column widths + proper AutoFilter over the 5 columns (A:E)
      ws['!cols'] = [{wch:18},{wch:32},{wch:8},{wch:16},{wch:36}];
      ws['!autofilter'] = { ref: XLSX.utils.encode_range({ s:{ r:firstDataRow-1, c:0 }, e:{ r:lastRow, c:4 } }) };
      return ws;
    }

      // Determine month label in YYYY-MM format, defaulting to current month
      function monthLabel(){
        const m = $('billMonth').value;
        if (m && /^\d{4}-(0[1-9]|1[0-2])$/.test(m)) return m;
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        return `${yyyy}-${mm}`;
      }

      function normalizeSheetNames(names){
        return Array.from(new Set(names)).sort((a,b)=>a.localeCompare(b));
      }

      function canonicalizeWorkbook(){
        const wb = getWB(); if(!wb) return;
        wb.SheetNames = normalizeSheetNames(
          (wb.SheetNames || []).filter(n => !!wb.Sheets[n])
        );
      }

      function fillSampleData(){
        Object.entries(SAMPLE).forEach(([id,val])=>{
          const el = $(id);
          el.value = val;
          if(el.type==='text') parseInrInput(el);
        });
      }
 
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('input[type="text"]').forEach(el=>{
        el.addEventListener('input', ()=>{ parseInrInput(el); compute(); });
        el.addEventListener('blur', ()=>parseInrInput(el));
      });
      document.querySelectorAll('input:not([type="text"])').forEach(el=>{
        el.addEventListener('input', compute);
      });

      const sciIds = ['A4','A17','B17','C17','D17','E17','B15','D15','C16'];
      const showSciHint = el=>{
        const hint = el.nextElementSibling;
        if(hint && hint.classList.contains('hint')){
          hint.textContent = 'Scientific notation not allowed.';
          hint.style.display = 'block';
          el.classList.add('invalid');
        }
      };
      sciIds.forEach(id=>{
        const el=$(id); if(!el) return;
        el.addEventListener('keydown', e=>{
          if(e.key==='e' || e.key==='E'){ e.preventDefault(); showSciHint(el); }
        });
        el.addEventListener('paste', e=>{
          const txt = (e.clipboardData || window.clipboardData).getData('text');
          if(/e/i.test(txt)){ e.preventDefault(); showSciHint(el); }
        });
      });

      ['B15','D15','C16'].forEach(id=>{
        const el=$(id); if(!el) return;
        el.addEventListener('blur', ()=>{
          let v = parseFloat(el.value);
          if(Number.isFinite(v)){
            if(v<0) v=0; if(v>100) v=100;
            el.value = v; el.dataset.value = v;
          }
          compute();
        });
      });

      $('addSheet').addEventListener('click', () => withBusy('addSheet', async () => {
        if (!(await loadXLSX())) return;
        const _wb = getWB(); if(!_wb) return;
        const model = compute(true);
        if (!model) { toast('Fix highlighted inputs before adding the month sheet.', 'warn'); return; }
        const label = monthLabel();
        const ws = buildSheetData(model, label);
        const exists = _wb.SheetNames.includes(label);
        _wb.Sheets[label] = ws;
        if (!exists) _wb.SheetNames.push(label);
        canonicalizeWorkbook();
        toast(`${exists ? 'Updated' : 'Added'} sheet: ${label}`, 'good');
        refreshSheetList();
      }));

      let __dlInFlight = false;
      $('downloadExcel').addEventListener('click', () => withBusy('downloadExcel', async () => {
        if (__dlInFlight) return;
        __dlInFlight = true;
        try{
          if (!(await loadXLSX())) return;
        const _wb = getWB(); if(!_wb) return;
        const auto = $('autoUpdateOnDownload')?.checked;

        if (auto) {
          const model = compute(true);
          if (!model) { toast('Cannot download: fix inputs first.', 'warn'); return; }
          const label = monthLabel();
          const ws = buildSheetData(model, label);
          const exists = _wb.SheetNames.includes(label);
          _wb.Sheets[label] = ws;
          if(!exists) _wb.SheetNames.push(label);
        }

        canonicalizeWorkbook();
        if ((_wb.SheetNames?.length || 0) === 0) {
          toast('No sheets to download. Turn on auto‑update or add a month sheet first.', 'warn');
          return;
        }

        XLSX.writeFile(_wb, `WEG_Billing_${monthLabel()}.xlsx`);
        toast('Workbook downloaded.', 'good');
        } finally { __dlInFlight = false; }
      }));

            // Download IOM PDF
      $('downloadPDF').addEventListener('click', () => withBusy('downloadPDF', async () => {
        const model = compute(true);
        if (!model) { toast('Cannot download: fix inputs first.', 'warn'); return; }
        const label = monthLabel();
        const canSavePicker = !!(window.showSaveFilePicker) && isSecureContext;

        try {
          if (canSavePicker) {
            const blob = await generateIOMPDFBlob(model, label);
            const handle = await window.showSaveFilePicker({
              suggestedName: `IOM_${label}.pdf`,
              types: [{ description: 'PDF', accept: { 'application/pdf': ['.pdf'] } }]
            });
            const ws = await handle.createWritable();
            await ws.write(blob);
            await ws.close();
            toast('IOM PDF saved to the chosen location.', 'good');
          } else {
            generateIOMPDF(model, label);
            if (location.protocol === 'file:') {
              toast('Your browser saved the PDF to its default Downloads folder. For a Save As dialog, open this file via http://localhost or HTTPS.', 'info');
            } else {
              toast('PDF saved to your browser’s default download location. Enable “Ask where to save each file” to choose a folder.', 'info');
            }
          }
        } catch (e) {
          console.error(e);
          toast('PDF generation failed. See console for details.', 'bad');
        }
      }));

      $('uploadExcel').addEventListener('click', () => withBusy('uploadExcel', async () => {
        if (!(await loadXLSX())) return;
        $('uploadXlsx').click();
      }));
      $('uploadXlsx').addEventListener('change', e => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async ev => {
          try{
            const _wb = getWB(); if(!_wb) return;
            const data = new Uint8Array(ev.target.result);
            const wb = XLSX.read(data, {type:'array'});
            let added = 0, replaced = 0;
            const toReplace = [];
            for(const name of wb.SheetNames){
              if (_wb.SheetNames.includes(name)){
                const ok = await confirmModal(`Sheet "${name}" exists. Replace it?`);
                if (ok) toReplace.push(name);
              }else{
                _wb.Sheets[name] = wb.Sheets[name];
                _wb.SheetNames.push(name);
                added++;
              }
            }
            for(const name of toReplace){
              _wb.Sheets[name] = wb.Sheets[name];
              if(!_wb.SheetNames.includes(name)) _wb.SheetNames.push(name);
              replaced++;
            }
            canonicalizeWorkbook();
            toast(`Workbook merged: ${added} added, ${replaced} replaced.`, 'good');
            refreshSheetList();
          }catch(err){
            console.error(err);
            toast('Upload failed','bad');
          }finally{
            e.target.value='';
          }
        };
        reader.onerror = err=>{ console.error(err); toast('Upload failed','bad'); e.target.value=''; };
        reader.readAsArrayBuffer(file);
      });

      $('clearSheets').addEventListener('click', async () => {
        if(!(await confirmModal('Remove ALL sheets from the workbook?'))) return;
        const wb = getWB(); if(!wb) return;
        (wb.SheetNames || []).forEach(n => delete wb.Sheets[n]);
        wb.SheetNames = [];
        canonicalizeWorkbook();
        toast('All sheets cleared.', 'good');
        refreshSheetList();
      });

      $('resetAll').addEventListener('click', ()=>{
        document.querySelectorAll('input').forEach(el=>{
          if(el.type!=="month"){
            el.value='';
            el.dataset.value='';
          }
        });
        compute();
      });

      $('resetSample').addEventListener('click', ()=>{
        fillSampleData();
        const m = compute(true);
        console.assert(m.A9 === 14350, `A9 expected 14350, got ${m.A9}`);
        console.assert(m.C9 === 17220, `C9 expected 17220, got ${m.C9}`);
        console.assert(Math.round(m.FINAL) === 16700, `FINAL expected 16700, got ${m.FINAL}`);
      });

      const restored = restore();
      compute();
      refreshSheetList();
      if(restored) toast('Previous data restored.');
    });
  </script>
</body>
</html>
